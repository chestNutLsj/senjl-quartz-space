### 4.2.4　练习使用FixVhdWr 工具向虚拟硬盘写数据

通常，VHD 是由虚拟机VirtualBox 使用的。应用程序像往常一样，直接针对硬盘进行操作，而在底层，虚拟机将这些硬件访问转化为对文件的读写。

为了在处理器加电或者复位之后能够执行我们写的程序，势必要将这些程序写到硬盘的主引导扇区里，也就是0 面0 道1 扇区，即使是在虚拟机工作环境中，也是这样。

为了做到这一点，需要一个专门针对虚拟硬盘进行读写的工具。我自己写了一个，就在配书源代码和工具里，名叫FixVhdWr。

FixVhdWr 只针对固定尺寸的VHD。当它启动之后，首先需要选择要读写的VHD 文件。如图4-8 所示，一旦这是个合法的VHD 文件，它将读取该文件的结尾，并显示该虚拟硬盘的信息。

注意，因为FixVhdWr 只针对固定尺寸的VHD，所以，如果它检测到该VHD 是一个动态虚拟硬盘，则“下一步”按钮处于禁止状态。

第二步是选择要写入虚拟硬盘的数据文件。毕竟，在任何操作系统中，数据都是以文件的方式组织的，如图4-9 所示。

最后一个界面，是执行写入操作，如图4-10 所示，你应该选择第一种写入方式，即“LBA 连续直写模式”，并指定起始的逻辑扇区号。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00057.jpeg)

图4-8　打开VHD 文件并显示该虚拟硬盘的信息

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00058.jpeg)

图4-9　选择要写入虚拟硬盘的文件

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00059.jpeg)

图4-10　指定数据写入时的起始逻辑扇区号

通常，一个扇区的尺寸是512 字节，可以看成一个数据块。所以，从这个意义上来说，硬盘是一个典型的块（Block）设备。

采用磁头、磁道和扇区这种模式来访问硬盘的方法称为CHS 模式，但不是很方便。想想看，如果有一大堆数据要写，还得注意磁头号、磁道号和扇区号不要超过界限。所以，后来引入了逻辑块地址（Logical Block Address，LBA）的概念。现在市场上销售的硬盘，无论是哪个厂家生产的，都支持LBA 模式。

LBA 模式是由硬盘控制器在硬件一级上提供支持，所以效率很高，兼容性很好。LBA 模式不考虑扇区的物理位置（磁头号、磁道号），而是把它们全部组织起来统一编号。在这种编址方式下，原先的物理扇区被组织成逻辑扇区，且都有唯一的逻辑扇区号。

比如，某硬盘有6 个磁头，每面有1000 个磁道，每磁道有17 个扇区。那么：

逻辑0 扇区对应着0 面0 道1 扇区；

逻辑1 扇区对应着0 面0 道2 扇区；

……

逻辑16 扇区对应着0 面0 道17 扇区；

逻辑17 扇区对应着1 面0 道1 扇区；

逻辑18 扇区对应着1 面0 道2 扇区；

……

逻辑33 扇区对应着1 面0 道17 扇区；

逻辑34 扇区对应着2 面0 道1 扇区；

逻辑35 扇区对应着2 面0 道2 扇区；

……

要注意到，扇区在编号时，是以柱面为单位的。即，先是0 面0 道，接着是1 面0 道，直到把所有盘面上的0 磁道处理完，再接着处理下一个柱面。之所以这样做，是因为我们讲过，要加速硬盘的访问速度，最好是尽可能不移动磁头。

因为这里总共有102000 个扇区，故最后一个逻辑扇区的编号是101999，它对应着5 面999 道17 扇区，这也是整个硬盘上最后一个物理扇区。

这里面的计算方法是：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00060.jpeg)

这里，LBA 是逻辑扇区号，C、H、S 是想求得逻辑扇区号的那个物理扇区所在的磁道、磁头和扇区号。

采用LBA 模式的好处是简化了程序的操作，使得程序员不用关心数据在硬盘上的具体位置。对于本书来说，VHD 文件是按LBA 方式组织的，一开始的512 字节就是逻辑0 扇区，然后是逻辑1 扇区；最后一个逻辑扇区排在文件的最后（最后512 个字节除外，那是VHD 文件的标识部分）。

检测点4.2

1． 运行NASMIDE 程序，输入以下汇编指令并保存为文件4-2.asm（不要考虑这些指令的含义和功能）：

mov ax,0xb800

mov ds,ax

mov [0x00],’a’

mov [0x02],’s’

mov [0x04],’m’

jmp $

2． 将上面的4-2.asm 文件编译，得到二进制文件4-2.bin，并写入虚拟硬盘的主引导扇区。注意，该虚拟硬盘应当是VirtualBox 虚拟机的启动硬盘。

3． 启动你的VirtualBox 虚拟机。当虚拟机启动时，会像真实的计算机一样加载硬盘上的主引导扇区代码，并执行。此时，注意观察屏幕上都显示了什么内容。

[^1]: 比如，当你按下主机箱面板上的RESET 按钮时，就会导致RESET 引脚电平的变化，从而使计算机热启动。