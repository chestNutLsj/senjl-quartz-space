### 4.2.3　虚拟硬盘简介

坦白地说，之所以要采用固定尺寸的VHD 虚拟硬盘，是因为其简单性。我们知道，虚拟硬盘实际上是一个文件。固定尺寸的VHD 虚拟硬盘是一个具有“.vhd”扩展名的文件，它仅包括两个部分，前面是数据区，用来模拟实际的硬盘空间，后面跟着一个512 字节的结尾（2004 年前的规范里只有511 字节）。

要访问硬盘，运行中的程序必须至少向硬盘控制器提供4 个参数，分别是磁头号、磁道号、扇区号，以及访问意图（是读还是写）。

硬盘的读写是以扇区为最小单位的。所以，无论什么时候，要从硬盘读数据，或者向硬盘写数据，至少得是1 个扇区。

你可能想，我只有2 字节的数据，不足以填满一个扇区，怎么办呢？

这是你自己的事。你可以用无意义的废数字来填充，凑够一个扇区的长度，然后写入。读取的时候也是这样，你需要自己跟踪和把握从扇区里读到的数据，哪些是你真正想要的。换句话说，硬盘只是机械和电子的组合，它不会关心你都写了些什么。要是手机像人类一样智能，它一定会在坏人使用它的时候无法开机。

在VHD 规范里，每个扇区是512 字节。VHD 文件一开始的512 字节，就对应着物理硬盘的0 面0 道1 扇区。然后，VHD 文件的第二个512 字节，对应着0 面0 道2 扇区，后面的以此类推，一直对应到0 面0 道n 扇区。这里，n 等于每磁道的扇区数。

再往后，因为硬盘的访问是按柱面进行的，所以，在VHD 文件中，紧接着前面的数据块，下一个数据块对应的是1 面0 道1 扇区，就这样一直往后排列，当把第一个柱面全部对应完后，再从第二个柱面开始对应。

如图4-7 所示，为了标志一个文件是VHD 格式的虚拟硬盘，并为使用它的虚拟机提供该硬盘的参数，在VHD 文件的结尾，包含了512 字节的格式信息。为了观察这些信息，我们使用了前面已经介绍过的配书工具HexView。

如图4-7 所示，文件尾信息是以一个字符串“conectix”开始的。这个标志用来告诉试图打开它的虚拟机，这的确是一个合法的VHD 文件。该标志称为VHD 创建者标识，就是说，该公司（conectix）创建了VHD 文件格式的最初标准。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00056.jpeg)

图4-7　VHD 文件的格式信息

从这个标志开始，后面的数据包含了诸如文件的创建日期、VHD 的版本、创建该文件的应用程序名称和版本、创建该文件的应用程序所属的操作系统、该虚拟硬盘的参数（磁头数、每面磁道数、每磁道扇区数）、VHD 类型（固定尺寸还是动态增长）、虚拟硬盘容量等。

说到这里，也许你已经明白我为什么要在书中使用固定尺寸的VHD。是的，因为它简单。为了学习汇编语言，我们不得不在硬盘上直接写入程序。因为VHD 格式简单，所以我只花了很少的时间就开发了一个虚拟硬盘写入程序，作为配书工具让大家使用，这就是下一节将要介绍的FixVhdWr。

至于为什么要使用VirtualBox 虚拟机，是因为它支持VHD，而且是免费的。先前版本的VirtualBox 可以识别VHD，但不支持创建新的VHD，尽管微软公司很早就公开了VHD 规范。好消息是现在的VirtualBox 也可以创建VHD 了。