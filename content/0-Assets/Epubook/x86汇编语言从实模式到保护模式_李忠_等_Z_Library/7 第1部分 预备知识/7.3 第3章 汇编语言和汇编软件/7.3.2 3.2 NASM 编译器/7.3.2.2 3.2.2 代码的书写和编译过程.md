### 3.2.2　代码的书写和编译过程

和你已经司空见惯的其他Windows 应用程序不同，NASM 在运行之后并不会显示一个图形用户界面。相反地，它只能通过命令行使用。

比如，我们可以用Windows 记事本编写一个汇编语言源程序，并把它保存到NASM 工作目录下（就是在前面安装NASM 时所用的安装文件夹），文件名为exam.asm。作为惯例，汇编语言源程序文件的扩展名是“.asm”，不过，你当然可以使用其他扩展名。

一旦有了一个源程序，下一步就是将它的内容编译成机器代码。为此，可以从Windows 开始菜单里找到“Netwide Assembler xxx”，其中的“xxx”取决于你安装的NASM 版本。然后，选择其下的“Nasm Shell”，这将打开一个命令行窗口。

接着，在命令行提示符后输入“nasm –f bin exam.asm –o exam.bin”并按Enter 键，如图3-2所示。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00040.jpeg)

图3-2　在命令行方式下使用NASM 编译一个汇编源程序

NASM 需要一系列参数才能正常工作。-f 参数的作用是指定输出文件的格式（Format）。这样，-f bin 就是要求NASM 生成的文件只包含“纯二进制”的内容。换句话说，除了处理器能够识别的机器代码外，别的任何东西都不包含。这样一来，因为缺少操作系统所需要的加载和重定位信息，它就很难在Windows、DOS 和Linux 上作为一个普通的应用程序运行。不过，这正是本书所需要的。

紧接着，exam.asm 是源程序的文件名，它是将要被编译的对象。

-o 参数指定编译后输出（Output）的文件名。在这里，我们要求NASM 生成输出文件exam.bin。

用来编写汇编语言源程序，Windows 记事本并不是一个好工具。同时，在命令行编译源程序也令很多人迷糊。毕竟，很多年轻的朋友都是用着Windows 成长起来的，他们缺少在DOS 和UNIX 下工作的经历。

为了写这本书，我一直想找一个自己中意的汇编语言编辑软件。互联网是个大宝库，上面有很多这样的工具软件，但大多都包含了太多的功能，用起来自然也很复杂。我的愿望很简单，能够方便地书写汇编指令即可，同时还具有编译功能。毕竟我自己也不喜欢在命令行和图形用户界面之间来回切换。

在经历了一系列的失望之后，我决定自己写一个，于是就有了Nasmide 这个小程序，它同样位于配书文件包中。不过遗憾的是，这个小程序却并非是用汇编语言书写的。

现在，你可以双击nasmide.exe 来运行它。启动之后，如图3-3 所示，Nasmide 的软件界面分为三个部分。顶端是菜单，可以用来新建文件、打开文件、保存文件或者调用NASM 来编译当前文档。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00041.jpeg)

图3-3　Nasmide 程序的基本界面

中间最大的空白区域是编辑区，用来书写汇编语言源代码。

窗口底部那个窄的区域是消息显示区。在编译当前文档时，不管是编译成功，还是发现了文档中的错误，都会显示在这里。

基本上，你现在已经可以在Nasmide 里书写汇编语句了。不过，在此之前你最好先做一件事情。Nasmide 只是一个文本编辑工具，它自己没有编译能力。不过，它可以在后台调用NASM 来编译当前文档，前提是它必须知道NASM 安装在什么地方。

为此，你需要在菜单上选择“选项”→“编译环境设置”来打开如图3-4 所示的对话框。

如图3-4 所示，这个路径就是你在前面安装NASM 时，指定的安装路径，包括可执行文件名nasm.exe。

不同于其他汇编语言编译器，NASM 最让我喜欢的一个特点是允许在源程序中只包含指令，如图3-5 所示。用过微软公司MASM 的人都知道，在真正开始书写汇编指令前，先要穿靴戴帽，在源程序中定义很多东西，比如代码段和数据段等，弄了半天，实际上连一条指令还没开始写呢。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00042.jpeg)

图3-4　为Nasmide 指定NASM 编译器所在路径

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00043.jpeg)

图3-5　NASM 允许在源文件中只包含指令

如图3-5 所示，用Nasmide 程序编辑源程序时，它会自动在每一行内容的左边显示行号。对于初学者来说，一开始可能会误以为行号也会出现在源程序中。不要误会，行号并非源程序的一部分，当保存源程序的时候，也不会出现在文件内容中。

让Nasmide 显示行号，这是一个聪明的决定。一方面，我在书中讲解源程序时，可以说第几行到第几行是做什么用的；另一方面，当编译源程序的时候，如果发现了错误，错误信息中也会说明是第几行有错。这样，因为Nasmide 显示了行号，这就很容易快速找到出错的那一行。

在汇编源程序中，可以为每一行添加注释。注释的作用是说明某条指令或者某个符号的含义和作用。注释也是源程序的组成部分，但在编译的时候会被编译器忽略。如图3-5 所示，为了告诉编译器注释是从哪里开始的，注释需要以英文字母的分号“;”开始。

当源程序书写完毕之后，就可以进行编译了，方法是在Nasmide 中选择菜单“文件”→“编译本文档”。这时，Nasmide 将会在后台调用NASM 来完成整个编译过程，不需要你额外操心。如图3-5所示，即使只有三行的程序也能通过编译。编译完成后，会在窗口底部显示一条消息。

检测点3.1

1． 在你的计算机中启动Nasmide 程序，输入图3-10 中的三行代码，然后编译它们。看看消息显示区是否有编译成功的提示。

2． 选择填空：指令mov ax,0xf5fc 中，“mov”指示这是一条（ ）指令，0xf5fc 是（ ）。指令执行后，寄存器AX 中的内容是（ ）。

A.立即数 B.传送 C.0xf5fc D.加法 E.0xfcf5 F.寄存器