   

## 12.3　修改段寄存器时的保护

随着程序的执行，经常要对段寄存器进行修改。此时，处理器在变更段寄存器以及隐藏的描述符高速缓存器的内容时，要检查其代入值的合法性。

代码清单12-1 第55 行，这是一条直接远转移指令：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00478.jpeg)

这条指令会隐式地修改段寄存器CS。

同样要修改段寄存器的指令还出现在第59～68 行（以下粗体部分）：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00479.jpeg)

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00480.jpeg)

以上的指令涉及所有段寄存器，当这些指令执行时，处理器把指令中给出的选择子传送到段寄存器的选择器部分。但是，处理器的固件在完成传送之前，要确认选择子是正确的，并且该选择子选择的描述符也是正确的。

在当前程序中，选择子的TI 位都是0，故所有的描述符都在GDT 中。如图12-2 所示，GDT的基地址和界限，都在寄存器GDTR 中。描述符在内存中的地址，是用索引号乘以8，再和描述符表的线性基地址相加得到的，而这个地址必须在描述符表的地址范围内。换句话说，索引号乘以8 得到的数值，必须位于描述符表的边界范围之内。换句话说，处理器从GDT 中取某个描述符时，就要求描述符的8 个字节都在GDT 边界之内，也就是索引号×8＋7 小于等于边界。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00481.jpeg)

图12-2　索引号的检查

如果检查到指定的段描述符，其位置超过表的边界时，处理器中止处理，产生异常中断13，同时段寄存器中的原值不变。

以上仅仅是检查的第一步。要是通过了上述检查，并从表中取得描述符后，紧接着还要对描述符的类别进行确认。举个例子来说，若描述符的类别是只执行的代码段（表11-1），则不允许加载到除CS 之外的其他段寄存器中。

具体地说，首先，描述符的类别字段必须是有效的值，0000 是无效值的一个例子。

然后，检查描述符的类别是否和段寄存器的用途匹配。其规则如表12-1 所示。

表12-1　段的类别检查

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00482.jpeg)

最后，除了按表12-1 进行段的类别检查外，还要检查描述符中的P 位。如果P＝0，表明虽然描述符已被定义，但该段实际上并不存在于物理内存中。此时，处理器中止处理，引发异常中断11。一般来说，应当定义一个中断处理程序，把该描述符所对应的段从硬盘等外部存储器调入内存，然后置P 位。中断返回时，处理器将再次尝试刚才的操作。

如果P＝1，则处理器将描述符加载到段寄存器的描述符高速缓存器，同时置A 位（仅限于当前讨论的存储器的段描述符）。

注意，如表中所指示的那样，可读的代码段类似于ROM。可以用段超越前缀“cs：”来读其中的内容，也可以将它的描述符选择子加载到DS、ES、FS、GS 来做为数据段访问。代码段在任何时候都是不可写的。

一旦上述规则全部验证通过，处理器就将选择子加载到段寄存器的选择器。显然，只有可以写入的数据段才能加载到SS 的选择器，CS 寄存器只允许加载代码段描述符。另外，对于DS、ES、FS 和GS 的选择器，可以向其加载数值为0 的选择子，即

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00483.jpeg)

尽管在加载的时候不会有任何问题，但在，真正要用来访问内存时，就会导致一个异常中断。这是一个特殊的设计，处理器用它来保证系统安全，这在后面会讲到。不过，对于CS 和SS的选择器来说，不允许向其传送为0 的选择子。

继续回到代码清单12-1 中来，第55～68 行的指令执行之后，段寄存器CS 指向512 字节的32位代码段，基地址是0x00007C00；DS 指向512 字节的32 位数据段，该段是上述代码段的别名，因此基地址也是0x00007C00；ES、FS 和GS 指向同一个段，该段是一个4GB 的32 位数据段，基地址为0x00000000；SS 指向4KB 的32 位栈段，基地址为0x00007C00。

检测点12.1

1．若某段描述符中的段界限是0xFFFFC，当粒度为字节和4KB 时，实际使用的段界限是多少？

2．若GDT 的界限为0x87，寄存器AX 的内容为0x0088，则执行指令mov ds,ax 时，处理器会产生异常吗？