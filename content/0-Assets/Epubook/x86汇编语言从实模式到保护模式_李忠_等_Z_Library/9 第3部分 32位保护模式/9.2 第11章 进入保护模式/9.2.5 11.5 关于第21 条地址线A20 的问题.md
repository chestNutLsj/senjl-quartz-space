   

## 11.5　关于第21 条地址线A20 的问题

在即将进入保护模式之前，这里还涉及一个历史遗留问题，那就是处理器的第21 根地址线，编号A20。“A”是Address 的首字符，就是地址，A0 是第一根地址线，A31 是第32 根地址线，所以，A20 就是第21 根地址线。在8086 处理器上运行程序不存在A20 问题，因为它只有20 根地址线。

实模式下的程序只能寻址1MB 内存，那是因为它依赖16 位的段地址左移4 位，加上16 位的偏移地址来访问内存。当逻辑段地址达到最大值0xFFFF 时，再加一，就会因进位而绕回到0x0000，因为段寄存器只能保留16 位的结果。至于段内偏移地址，也是如此。

这个问题可以从另一个角度来解释得更清楚一点。无论如何，从8086 处理器外部来看，每次当物理地址达到最高端0xFFFFF 时，再加一，结果为0x100000。但因为它只能维持20 位的地址，故进位自然丢失，地址又绕回最低地址端0x00000。程序员，你是知道的，他们喜欢钻研，更喜欢利用硬件的某些特性来展示自己的技术，很难说在当年有多少程序在依赖这个回绕特性工作着。

到了80286 时代，处理器有24 条地址线，地址回绕好像不灵了，因为比0x0FFFFF 大的数是0x100000，80286 处理器可以维持24 位的地址数据，进位不会被丢弃。那个时代，正是商业机器公司IBM 生意火红的时候，主导着个人计算机市场。为了能在80286 处理器上运行8086 程序而不会因地址线而产生问题，它们决定在主板上动一动手脚。

其实问题的解决办法很简单，只需要强制第21 根地址线恒为“0”就可以了。这样，0x0FFFFF 加1 的进位被强制为“0”，结果是0x000000；再加1，是0x000001，……，永远和实模式一样。

于是，如图11-6 所示，IBM 公司使用一个与门来控制第21 根地址线A20，并把这个与门的控制阀门放在键盘控制器内，端口号是0x60。向该端口写入数据时，如果第1 位是“1”，那么，键盘控制器通向与门的输出就为“1”，与门的输出就取决于处理器A20 是“0”还是“1”。

不过，这种做法非常烦琐，因为要访问键盘控制器，需要先判断状态，要等待键盘控制器不忙，至少需要十几个步骤，需要的指令数量比本章的代码清单11-1 还多。

这种做法持续了若干年，直到80486 处理器推出后，才有了更快速的办法。相信在此期间，Intel 公司和IBM 公司都听到了不少的抱怨，为什么进入保护模式这么麻烦，一定要改改。从80486 处理器开始，处理器本身就有了A20M#引脚，意思是A20 屏蔽（A20 Mask），它是低电平有效的。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00430.jpeg)

图11-6　早期的A20 控制策略

如图11-7 所示，输入输出控制器集中芯片ICH 的处理器接口部分，有一个用于兼容老式设备的端口0x92，第7～2 位保留未用，第0 位叫做INIT_NOW，意思是“现在初始化”，用于初始化处理器，当它从0 过渡到1 时，ICH 芯片会使处理器INIT#引脚的电平变低（有效），并保持至少16 个PCI 时钟周期。通俗地说，向这个端口写1，将会使处理器复位，导致计算机重新启动。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00431.jpeg)

图11-7　改进后的A20 控制策略

端口0x92 的位1 用于控制A20 ， 叫做替代的A20 门控制（ Alternate A20 Gate ， ALT_A20_GATE），它和来自键盘控制器的A20 控制线一起，通过或门连接到处理器的A20M#引脚。和使用键盘控制器的端口不同，通过0x92 端口显得非常迅速，也非常方便快捷，因此称为Fast A20。

当INIT_NOW 从0 过渡到1 时，ALT_A20_GATE 将被置“1”。这就是说，计算机启动时，第21 根地址线是自动启用的。A20M#信号仅用于单处理器系统，多核处理器一般不用。特别是考虑到传统的键盘控制器正逐渐被USB 键盘代替，这些老式设备也许很快就会消失。

接着来看代码清单11-1。

端口0x92 是可读写的，第40～42 行，先从该端口读出原数据，接着，将第2 位（位1）置“1”，然后再写入该端口，这样就打开了A20。