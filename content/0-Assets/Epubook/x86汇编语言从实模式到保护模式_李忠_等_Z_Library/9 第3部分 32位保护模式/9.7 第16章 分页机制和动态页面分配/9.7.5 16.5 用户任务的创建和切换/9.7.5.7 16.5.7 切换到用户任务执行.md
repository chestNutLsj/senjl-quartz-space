### 16.5.7　切换到用户任务执行

第1069～1072 行，先显示一条消息，告诉屏幕前的人，正在执行任务切换。接着，使用call指令发起任务切换。call 指令的参数是TCB 中的TSS 选择子。任务切换时，内核任务的状态被保存到当前的TSS 中，接着，找到用户任务的TSS，从中取出各种参数，加载到处理器的各个寄存器中，包括CR3 寄存器、LDTR、段寄存器、指令指针和栈指针寄存器、通用寄存器等。于是，用户任务就开始执行了。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00711.jpeg)

图16-27　多任务环境下的页目录表和页表映射示意图

来看代码清单16-2。

第46、47 行，显示字符串，表示任务当前正工作在页功能开启的状态下。

接着，第49～59 行，以十六进制的形式，显示当前任务4GB 虚拟地址空间内的前88 个双字。每次先显示两个空格，然后再显示双字的值，这样形成的效果是每行8 个双字，共11 行。如图16-28 所示，这是当前任务的运行结果。

空格字符串在第38 行，用标号space 声明，并初始化为3 字节。空格的ASCII 码为0x20，因此，这一行等效于

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00712.jpeg)

结合代码清单16-2，再来看屏幕上显示的内容。0x0001F88E 是用户程序的总长度，即129166字节；第2 个双字是0x1F85B，是用户程序的入口点；第3 个双字是0x00000010，这是U-SALT表的起始线性地址；第4 个双字是0x000001F8，这是U-SALT 表的条目数。不要忘了，我们在SALT 表的中间插入了以下语句：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00713.jpeg)

这直接导致多出500 个表项。加上原有的4 个表项，共504（0x000001F8）个表项。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00714.jpeg)

图16-28　本章程序的运行结果截图

从源程序中可知，紧接着显示的是U-SALT 表的内容。不过，每个表项的前6 字节已经被内核改成调用门选择子和偏移量了。SALT 表的内容是按字节定义的，当按双字值显示在屏幕上时，会显得颠倒错乱，请读者在有时间的情况下自行分析。

第61 行，将控制返回到内核中。

回到代码清单16-1。

控制返回到代码清单16-1 的第445 行。在那里，先根据EFLAGS 寄存器的NT 位，判断用户任务（当前任务）当初是怎么发起的。如果是由call 指令发起的，那么，就用iretd 指令转换到前一个任务（内核）；如果是由jmp 指令发起的，则直接用jmp 指令转换回内核任务。

无论如何，当任务切换后，一定会转换回内核任务，因为当前就两个任务。一旦内核任务恢复执行，而且执行点在第1074 行，紧接着当初发起任务切换的那条指令之后。

第1074～1077 行，内核显示一条消息，表示处理器要停机了。于是，它说到做到，停机。