### 16.5.3　用户任务的虚拟地址空间分配

现在，回到代码清单16-1，开始加载用户程序并创建相应的任务。

首先要创建任务控制块（TCB）。这本来不是个问题，但由于现在每个任务都拥有了自己独立的4GB 虚拟地址空间，问题就来了。

一般来说，所有任务的TCB 都应当占用内核的地址空间，在内核的虚拟地址空间里分配。任务都是由内核负责管理和调度的，如果TCB 位于任务自己的地址空间里，而不是内核的地址空间里，那么，这同时也意味着，在内核的页目录表和页表中，没有指向TCB 所在页的表项，内核不可能访问到它。

第1055～1057 行，用于在内核的虚拟地址空间里分配4KB 的内存（页），这和上一次在内核中分配内存的做法是一样的。

第1059～1062 行，初始化TCB，为某些域赋初值。任务控制块（TCB）的结构如图16-25 所示，和上一章相比，已经大大简化了，只保留了少数项目。这也意味着，和以往相比，用户程序的加载过程会简单得多。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00705.jpeg)

图16-25　任务控制块（TCB）的结构

在TCB 中，有两个项目应该在创建用户任务前就予以填写和初始化，它们是LDT 当前界限值和下一个可用的线性地址。LDT 当前界限值应该被初始化为0xFFFF，这是计算机启动时，LDTR 寄存器中的默认界限值，LDTR 中的界限部分只有16 位。LDT 的界限是LDT 的长度减一，LDT 的初始长度为0，因此，其界限值是0xFFFF。

每个任务都有自己的4GB 虚拟内存空间，线性地址范围是0x00000000～0xFFFFFFFF，它是任务自己的空间，可以任意分配和使用。当然，实际可以使用的空间是前2GB，后2GB 被任务的全局部分占用， 映射并指向内核的页表。一般来说， 第一个可以分配的线性地址是0x00000000，要把这个数值填写到TCB 的“下一个可用线性地址”域中。

在填写了以上两个TCB 域后，第1062 行，将此TCB 挂到TCB 链上。该链的作用将在第17章中进行抢占式任务切换时才能体现出来。

第1064～1067 行，在当前栈中压入两个参数，分别是用户程序的TCB 基地址和起始逻辑扇区号，然后调用过程load_relocate_program 加载和重定位用户程序，并创建为一个任务。