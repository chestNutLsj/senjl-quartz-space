### 16.4.4　创建内核任务的TSS

从过程allocate_a_4k_page 返回后，返回点位于代码清单16-1 的第1028 行。

在为系统内核的任务状态段（TSS）分配了虚拟地址空间和页之后，这一行将标号core_ next_laddr 处的数据修改为下一个可分配的起始线性地址。下一次在内核的虚拟地址空间里分配内存时，将使用这个新值作为起始的线性地址。

第1031～1038 行，填写和初始化TSS 中的静态部分，有些内容，比如CR3 寄存器域，对任务的执行来说很关键，必须事先予以填写。

一旦分配了物理页，并填写了页目录项和页表项，就立即可以用那个线性地址来访问内存。此时，整个过程是相反的，页部件用那个线性地址访问页目录表和页表，生成物理地址。还有，尽管你在指令中给出的确实是线性地址，但并非是由段部件生成的线性地址。在Intel 处理器上，段机制是无法关闭的，因此，你必须使用0～4GB 的段，加上你的“线性地址”，才得使段部件生成真正的线性地址，尽管两个线性地址在数值上没有任何不同。

因此，要访问TSS，必须通过段寄存器ES 所指向的0～4GB 数据段。

第1041～1046 行，创建内核任务的TSS 描述符，并安装到GDT 中。TSS 描述符选择子保存在内核数据段中，位于第530 行，在那里，声明了标号program_man_tss 并初始化了1 个字。在任务切换时，需要使用它。

由于当前任务事实上正处于运行中，因此，只要后补手续即可使其完全合法。第1050 行，将当前任务的TSS 描述符传送到任务寄存器TR。