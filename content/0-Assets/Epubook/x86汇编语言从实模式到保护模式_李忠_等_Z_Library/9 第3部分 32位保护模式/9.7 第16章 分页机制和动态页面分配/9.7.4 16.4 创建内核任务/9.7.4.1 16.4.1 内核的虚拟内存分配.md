### 16.4.1　内核的虚拟内存分配

接下来的工作是使内核的一部分成为任务，并为创建用户任务和实施任务切换做准备。

首先是创建内核任务的任务状态段（TSS）。内核的主体部分占据着从线性地址0x80000000 开始的1MB 内存空间，即0x80000000 ～ 0x800FFFFF ， 在此之后的空间， 即0x80100000 ～ 0xFFFFFFFF，是可以自由分配的。

为了连续地、动态地分配内核的空间，内核需要记住下一个可用于分配的线性地址。为此，代码清单16-1 的第529 行，专门声明了标号core_next_laddr，并初始化了一个双字0x80100000，这就是初始的可分配线性地址。每当分配了新的内存空间后，该双字将修正为下一个可分配的地址。

在分页机制下，内存的分配既要在虚拟内存空间中进行，还要在页目录表和页表中进行。原因你是清楚的，线性地址最终要通过页目录表和页表转换成物理地址，如果没有分配一个物理页，对任何内存的访问都是无效的，会引发处理器异常中断。

第1026 行，先访问内核数据段，从标号处取得当前可用的线性地址，将来要作为内核TSS 的起始线性地址。然后，将EBX 寄存器中的线性地址作为参数，调用过程alloc_inst_a_page 去申请一个物理页。

该过程位于第358 行，是公共例程段内的过程，它的功能是在可用的物理内存中搜索空闲的页，并将它安装在当前的层次化分页结构中（页目录表和页表）。简单地说，就是寻找一个可用的页，然后，根据线性地址来创建页目录项和页表项，并将页的地址填写在页表项中。

该过程首先察看与该线性地址相对应的页目录项是否存在。线性地址的高10 位是页目录表的索引，将该值乘以4，就是当前页目录表中，与该线性地址对应的页目录项。第370 行，将EBX寄存器中的线性地址传送到ESI 寄存器作为副本；第371 行，用AND 指令保留线性地址的高10位，其他各位清零；第372 行，得到该线性地址在页目录表中对应的偏移量（目录项）。该指令等效于

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00697.jpeg)

无关的位已经清零，在这种情况下，右移22 次，再左移2 次，干脆右移20 次好了。

我们说过，可以用线性地址来访问当前页目录表，我们也知道，当前页目录表的线性地址是0xFFFFF000。因此，第373 行，将刚才计算出的偏移量和页目录表的线性基地址相加，得到的结果就是要访问的那个目录项的线性地址。

第375、376 行，测试该目录项的P 位，看它是否为“1”。如果为“1”，则表明对应的页表已经存在，只要在那个页表中添加一项即可；否则，必须先创建页表，并填写页目录项。

注意，尽管我们给出的就是线性地址，但是，那不是处理器段部件产生的线性地址，第366、367 行，令段寄存器DS 指向0～4GB 的内存段（段的基地址是0x00000000），此后，当我们用给出的“线性地址”作为段内偏移量访问内存，段部件才会输出真正的线性地址，尽管两者是相同的。总之，处理器的段管理机制是始终存在的，没有任何一种方法可以关闭它。

如果对应的页目录项不存在，那么，将执行第379～381 行的指令，以分配一个物理页作为页表，并将页的物理地址填写到页目录项内。为此，需要调用另一个过程allocate_a_4k_page 以得到一个可用的4KB 页。