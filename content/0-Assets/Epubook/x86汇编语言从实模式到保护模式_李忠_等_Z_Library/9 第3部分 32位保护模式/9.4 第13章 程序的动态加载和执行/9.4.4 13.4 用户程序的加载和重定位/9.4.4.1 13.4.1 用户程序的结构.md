### 13.4.1　用户程序的结构

用户程序必须符合规定的格式，才能被内核识别和加载。通常情况下，流行的操作系统会规定自己的可执行文件格式，一般都比较复杂，这种复杂性和操作系统自身的复杂性是息息相关的。

现在转到代码清单13-3，来看看用户程序的结构。

所有操作系统的可执行文件都包括文件头，这里也不例外。事实上，这也是我们熟悉的、一贯的做法。在文件头内的偏移0 处，是一个双字，指示了用户程序的大小，以字节为单位。

偏移量为0x04 处的双字是头部的长度，以字节为单位。

偏移量为0x08 处的双字是为栈保留的，和早先的做法不同，内核不要求用户程序提供栈空间，而改由内核动态分配，以减轻用户程序编写的负担。当内核分配了栈空间后，会把栈段的选择子填写到这里，用户程序开始执行时，可以从这里取得该选择子以初始化自己的栈；

偏移量为0x0c 处的双字是要求分配的栈大小，即，用户程序编写者建议的栈大小，以4KB为单位。如果是1，就是希望分配4KB 的栈空间；如果是2，就是希望分配8KB 的栈空间，依此类推。

偏移量为0x10 处的双字，是用户程序入口点的32 位偏移地址。

偏移量为0x14 处的双字，是用户程序代码段的起始汇编地址。当内核完成对用户程序的加载和重定位后，将把该段的选择子回填到这里（仅占用低字部分）。这样一来，它和0x10 处的双字一起，共同组成一个6 字节的入口点，内核从这里转移控制到用户程序。

偏移量为0x18 处的双字，是用户程序代码段的长度，以字节为单位。

偏移量为0x1c 处的双字，是用户程序数据段的起始汇编地址，当内核完成用户程序的加载和重定位后，将把该段的选择子回填到这里（仅占用低字部分）。

偏移量为0x20 处的双字，是用户程序数据段的长度，以字节为单位。

除了加载和重定位用户程序外，内核还应当提供一些例程供用户程序调用。操作系统对于普通用户来说，是赏心悦目的界面和快捷直观的操作方式，对程序员来说，则是一个巨大的例程库，节省了时间，减少了工作量，甚至不需要直接访问硬件。

操作系统提供的编程接口就是API，这是一大堆例程（过程），需要的时候直接调用即可。问题在于，它们在操作系统内部，对任何人来说都是不可见的，更别想知道它们的入口地址。但是，call 指令是需要直接或间接提供一个地址的。另一方面，即使你知道它们的地址，调用的时候也有风险，因为操作系统也需要升级换代，这些地址可能改变。当你的程序在新操作系统上工作时，就要出问题。

为了使开发人员能够利用它所提供的API，操作系统至少要公开它们。在早期的系统中，这些API 以中断号的方式公布，因为它们是通过软中断进入的。不过，另一种常见的办法是使用符号名。比如，操作系统提供了一个例程，用于显示光标跟随的字符串，那么，它可以公布一个符号名：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00532.jpeg)

当然，它肯定不会同时公布一个段地址和偏移地址，因为它也不能保证地址不会变化。在操作系统的开发手册中，会列出所有符号名。符号名在高级语言里就是库函数名。

回到代码清单13-3 中来。

内核要求，用户程序必须在头部偏移量为0x28 的地方构造一个表格，并在表格中列出所有要用到的符号名。每个符号名的长度是256 字节，不足部分用0x00 填充，这意味着每个符号名的长度最多可以是256 个字符。在用户程序加载后，内核会分析这个表格，并将每一个符号名替换成相应的内存地址，这就是过程的重定位。为了方便起见，我们把该表格叫做“符号-地址检索表”（Symbol-Address Lookup Table，SALT）。不要上网搜索这个词，也不要查别的资料，这不是一个标准，是我自己随心所欲、特立独行的产物。

第29～36 行声明了三个标号，并分别初始化了三个符号名，每一个256 字节，不足部分是用0 填充的。每个符号名都以“@”开始，这并没有任何特殊意义，仅仅在概念上用于表示“接口”的意思。为了计算需要填充多少个0，它们都使用了相似的表达式，比如：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00533.jpeg)

这里，先计算出符号名的实际字符数，即$-PrintString，再用256 减去实际字符数，就得到了伪指令db 的重复次数。

SALT 表可大可小，内核需要知道它在哪里结束。第26 行，用于初始化SALT 表的项数，也就是符号名的数量，它是用表格的总长度除以每个符号名的长度（256）得到的。

事实上，即使是大多数汇编语言，也不需要亲自构造文件头，那是链接器（Linker）的工作。但是，链接器是为流行的操作系统服务的，用于构造他们可以识别的可执行文件格式。我们不想把问题搞得太复杂，就本书的篇幅和宗旨来说，迎合“流行”所要花费的代价实在太大，管中窥豹、点到即止不是很好吗？