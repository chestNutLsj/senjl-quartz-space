   

# 第14章　任务和特权级保护

在保护模式下，通过将内存分成大小不等的段，并用描述符对每个段的用途、类型和长度进行指定，就可以在程序运行时由处理器硬件施加访问保护。比如，当程序试图让处理器去写一个可执行的代码段时，处理器就会阻止这种企图；再比如，当程序试图让处理器访问超过段界限的内存区域时，处理器也会引发异常中断。

段保护是处理器提供的基本保护功能，但对于现实的需求来说，仍是不够的。

首先，当一个程序老老实实地访问只属于它自己的段时，基本的段保护机制是很有效的。但是，一个失控的程序，或者一个恶意的程序，依然可以通过追踪和修改描述符表来达到它们访问任何内存位置的目的。比如说，如果用户程序知道GDT 的位置，它可以通过向段寄存器加载操作系统的数据段描述符，或者在GDT 中增加一个指向操作系统数据区的描述符，来修改只属于操作系统的私有数据。对于处理器那种和3 岁小孩相仿的智力，所有这一切都是合法的。

其次，32 位处理器是为多任务系统而设计的。所谓多任务系统，是指能够同时执行两个以上程序的系统，即使前一个程序没有执行完，其他程序也可以开始执行。在单处理器（核）的系统中，多个程序并不可能真的同时执行，但是，处理器可以在多个任务之间周期性地切换和轮转。这样，它们都处于走走停停的状态，快速的处理器加上高效的任务切换，在外界看来，多个任务都在同时运行中。

多任务系统，对任务之间的隔离和保护，以及任务和操作系统之间的隔离和保护都提出了要求，这可以看做对段保护机制的进一步强化。同时，在多任务系统中，操作系统居于核心软件的位置，为各个任务服务，负责任务的加载、创建和执行环境的管理，并执行任务之间的调度，对操作系统的保护显得尤为重要。事实上，对于这种要求，基本的段保护机制已经无能为力了。

综上所述，本章的学习目标是：

1．通过演示如何创建一个任务，并使之投入运行来学习任务的概念及其组成要素，包括任务的全局空间和局部空间、TSS、LDT、特权级等。

2．必须了解特别级不是指任务的特权级，而是指组成任务的各个部分的特权级。比如，任务的全局部分一般是0、1 和2 特权级别的，任务的私有部分一般是3 特权级别的。

3．必须清楚CPL、DPL 和RPL 的含义，以及不同特权级别之间的控制转移规则。

4．熟悉调用门的用法。

5．掌握一些在Bochs 下调试程序的新手段。

6．学习一些新的x86 处理器指令，包括lldt、ltr、pushf/pushfd、popf/popfd、ret n/retf n、arpl等，同时，了解象jmp 和call 这样的传统指令是如何被赋予一些新功能的。