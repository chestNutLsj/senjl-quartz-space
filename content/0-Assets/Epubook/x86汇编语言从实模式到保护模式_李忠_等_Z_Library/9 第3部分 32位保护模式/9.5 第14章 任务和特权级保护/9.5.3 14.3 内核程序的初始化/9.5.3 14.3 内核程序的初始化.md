   

## 14.3　内核程序的初始化

本章没有提供主引导程序，因为我们要继续使用上一章的主引导程序。毕竟，主引导程序只是用来加载内核程序，并执行前期的内核初始化工作。主引导程序工作在0 特权级。

现在，让我们来分析本章代码清单14-1，这是前一章内核程序的修改版本，使用了任务、LDT、TSS 和特权级等最新的处理器特性和工作机制。代码清单中，一开始的常数定义以及程序头部的格式和前一章也完全相同，这是可以理解的，作为主引导程序和内核程序的协议部分，它们总应该是稳定不变的。

文件起始部分的常数定义了内核所有段的选择子。很显然，这些选择子的RPL 字段都是0，内核请求访问自己的段，请求特权级应当为0。

内核的入口点在第775 行。在执行到这里的时候，主引导程序已经加载了内核，并对它进行了前期的初始化工作。

因为加载的是内核程序，而内核应当工作在0 特权级，所以主引导程序在初始化内核时，所创建的描述符，其目标特权级DPL 都为0，如图14-8 所示。注意，这些描述符都是在GDT中创建的，图中左边是各描述符在GDT 中的偏移量，右边是各个描述符的选择子。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00589.jpeg)

图14-8　内核加载完成后的GDT 布局

这些描述符所指向的段，有的是代码段，有的是数据段。如果是数据段，则只有内核自己才能访问，因为其描述符的DPL 是0，低特权级别的程序访问这些段时，会被阻止以防出现安全问题；如果是代码段，则通常只有0 特权级的程序才能将控制转移到该段，也就是说，只能从内核其他正在执行的部分转移到该段执行，因为它们的特权级别相同。

第779～809 行，用于在屏幕上显示初始的信息，包括一个欢迎信息和一个处理器品牌信息。