### 14.4.9　创建任务状态段TSS

回到代码清单14-1，我们来创建任务状态段TSS。

第684～688 行，申请104 字节的内存用于创建TSS。很显然，我们是要创建一个标准大小的TSS。照例，要把TSS 的基地址和界限登记到任务控制块（TCB）中，将来创建TSS 描述符时用得着。TSS 的界限值是16 位的，是它的大小（总字节数）减1，这就是第686 行的目的。

注意，界限值必须至少是103，任何小于该值的TSS，在执行任务切换时，都会引发处理器异常中断。

第691 行，将指向前一个任务的指针（任务链接域）填写为0，表明这是唯一的任务。

第693～709 行，登记0、1 和2 特权级栈的段选择子，以及它们的初始栈指针。所有的栈信息都在TCB 中，先从TCB 中取出，然后填写到TSS 中的相应位置。

第711、712 行，登记当前任务的LDT 描述符选择子。在任务切换时，处理器需要用这里的信息找到当前任务的LDT。LDT 对任务来说并不是必需的，如果高兴，也可以把属于某个任务的段定义在GDT 中。如果没有LDT，这里应该填写0。

第714、715 行，填写I/O 许可位映射区的地址。在这里，填写的是TSS 段界限（103），这意味着不存在该区域。