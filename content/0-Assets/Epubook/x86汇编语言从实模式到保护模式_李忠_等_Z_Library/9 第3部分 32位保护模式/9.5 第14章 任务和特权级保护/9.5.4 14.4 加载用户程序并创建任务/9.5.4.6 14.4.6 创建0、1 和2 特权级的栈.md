### 14.4.6　创建0、1 和2 特权级的栈

任务在运行时，需要调用内核或者操作系统的例程。这可以认为是从同一个任务的局部地址空间转移到全局地址空间工作。而且，在这个过程中涉及特权级的变化，需要通过调用门。

通过调用门的控制转移通常会改变当前特权级CPL，同时还要切换到与目标代码段特权级相同的栈。为此，必须为每个任务定义额外的栈。对于当前的3 特权级任务来说，应当创建特权级0、1 和2 的栈。而且，应当将它们定义在每个任务自己的LDT 中。

这些额外的栈是动态创建的，而且需要登记在任务状态段（TSS）中，以便处理器固件能够自动访问到它们。但是，现在的问题是还没有创建TSS，有必要先将这些栈信息登记在任务控制块（TCB）中暂时保存。

第622 行，从栈中取得当前任务的TCB 基地址，它是作为过程参数压在当前栈中的。

第625～628 行，申请创建0 特权级栈所需的4KB 内存，并在TCB 中登记该栈的尺寸。登记到TCB 中的尺寸值要求是以4KB 为单位的，所以，还要逻辑右移12 次，相当于除以4096，得到一个4KB 的倍数。

第629、630 行，先申请内存，然后用申请到的内存基地址加上栈的尺寸，得到栈的高端地址，并将此地址登记到TCB 中。一般来说，栈应当使用高端地址作为其线性基地址。

第631、634 行，用给定的段界限和段属性调用公共例程段内的过程make_seg_descriptor 创建描述符。段属性表明这是一个栈段，4KB 粒度。我们创建的是0 特权级栈，故要求描述符的DPL 为0。

第635、636 行，调用内核代码段内的近过程fill_descriptor_in_ldt 将刚创建的描述符安装到LDT 中。该过程要求使用EBX 作为参数提供TCB 的线性基地址，故在调用该过程前先将该地址传送到EBX 寄存器。

第637～639 行，将安装描述符后返回的段选择子登记在TCB 中。相应地，应当将该选择子的请求特权级RPL 设置为0。注意，过程返回的选择子本来就是RPL 为0 的，所以那条指令是作为注释存在的。同时登记的还有0 特权级栈指针的初始值。按老规矩，这个初始值应当为0。

第642～673 行是创建1、2 特权级的栈，并将它们的信息登记在TCB 中，并使用了和上面相同的方法，要注意，为它们分配的特权级别是各不相同的。