### 14.4.10　安装TSS 描述符到GDT 中

和局部描述符表（LDT）一样，也必须在GDT 中安装TSS 的描述符。这样做，一方面是为了对TSS 进行段和特权级的检查；另一方面，也是执行任务切换的需要。当call far 和jmp far 指令的操作数是TSS 描述符选择子时，处理器执行任务切换操作。

如图14-19 所示，这是TSS 描述符的格式，和LDT 描述符差不多，除了TYPE 位。

TSS 描述符中的B 位是“忙”位（Busy）。在任务刚刚创建的时候，它应该为二进制的1001，即，B 位是0，表明任务不忙。当任务开始执行时，或者处于挂起状态（临时被中断执行）时，由处理器固件把B 位置1。

任务是不可重入的。就是说，在多任务环境中，如果一个任务是当前任务，它可以切换到其他任务，但不能从自己切换到自己。在TSS 描述符中设置B 位，并由处理器固件进行管理，可以防止这种情况的发生。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00621.jpeg)

图14-19　TSS 描述符的格式

第720～725 行，先调用公共例程段内的过程make_seg_descriptor 创建TSS 描述符，它需要传入三个参数。先从TCB 中取出TSS 的基地址，传送到EAX 寄存器；EBX 寄存器的内容是TSS 的界限；ECX 寄存器的内容是描述符属性值，0x00408900 表明这是一个DPL 为0 的TSS 描述符，字节粒度。接着，调用公共例程段内的另一个过程set_up_gdt_descriptor 安装此描述符到GDT中，并将返回的描述符选择子登记在TCB 中。TSS 描述符选择子的RPL 字段为0。