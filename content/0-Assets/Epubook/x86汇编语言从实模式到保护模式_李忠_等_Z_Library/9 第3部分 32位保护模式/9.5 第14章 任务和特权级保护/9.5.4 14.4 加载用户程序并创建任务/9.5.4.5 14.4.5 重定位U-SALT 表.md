### 14.4.5　重定位U-SALT 表

接着回到代码清单14-1 中。

从第539 行开始，一直到第576 行结束，分别是创建用户程序代码段、数据段和栈段描述符，并将它们安装在LDT 中。除了往LDT 中安装描述符，以及其他一些细节上的差别外，这部分代码和上一章相比，大体上是一致的，都很好理解，不需要一一详述。但是，必须要说明的是，在这个过程中所创建的段描述符，其特权级DPL 都是3，而且，这些段描述符的选择子，其请求特权级RPL 也都是3。

从第579 行开始，到第620 行结束，用于重定位用户程序的U-SALT 表。和第13 章相比，绝大多数代码都是相同的，具体的工作流程也几乎没有变化。当然，因为涉及特权级，个别的差异还是有的。

U-SALT 位于用户程序头部段。为了访问它，第14 章的做法是先用段寄存器ES 指向用户程序头部段，再访问该段内的U-SALT 表。当然，前提是用户程序头部段的描述符已经安装并开始生效。

在本章中，用户程序各个段的描述符位于LDT 中，尽管已经安装，但还没有生效（还没有加载局部描述符表寄存器LDTR）。在这种情况下，只能通过4GB 的段来访问U-SALT。所以，第579、580 行用于令段寄存器ES 指向4GB 的内存段。在前面的代码中，是令EDI 寄存器指向用户程序起始加载地址的，这也就是用户程序头部段的起始线性地址。因为U-SALT 的条目数位于头部段内偏移0x24 处。故，程序中用以下指令来取得该条目数（第587 行）：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00607.jpeg)

同样的道理，因为U-SALT 表位于头部段内偏移0x28 处，要想得到U-SALT 表的线性基地址，使EDI 寄存器指向它，程序中使用的是以下指令（第588 行）：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00608.jpeg)

具体的重定位过程在第13 章里已经讲得很清楚了，无非就是找到名字相同的C-SALT 条目，把它的地址部分复制到U-SALT 的对应条目中。在第13 章里，复制的是16 位的代码段选择子和32 位的段内偏移。在本章中，这些地址不再是普通的段选择子和段内偏移，而是调用门选择子和段内偏移。

当初，在创建这些调用门时，选择子的RPL 字段是0。也就是说，这些调用门选择子的请求特权级是0。当它们被复制到U-SALT 中时，应当改为用户程序的特权级（3）。

为此，第605、606 行，因为ESI 寄存器指向当前条目的地址部分，所以4 字节之后的地方是该地址的选择子部分，需要首先传送到AX 寄存器；紧接着，修改它的RPL 字段，使该选择子的请求特权级为3。