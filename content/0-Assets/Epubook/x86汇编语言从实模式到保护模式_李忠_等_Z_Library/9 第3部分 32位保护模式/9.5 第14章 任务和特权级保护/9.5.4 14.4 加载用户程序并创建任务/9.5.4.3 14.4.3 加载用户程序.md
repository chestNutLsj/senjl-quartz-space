### 14.4.3　加载用户程序

当用户程序被读入内存，并处于运行或者等待运行的状态时，就视为一个任务。任务有自己的代码段和数据段（包括栈），这些段必须通过描述符来引用，而这些描述符可以放在GDT 中，也可以放在任务自己私有的LDT 中，但最好是放在LDT 中。GDT 用于存放各个任务公有的描述符，比如公共的数据段和公共例程。

每个任务都允许有自己的LDT，而且可以定义在任何内存位置。所以，我们现在要做三件事：

●分配一块内存，作为LDT 来用，为创建用户程序各个段的描述符做准备；

●将LDT 的大小和起始线性地址登记在任务控制块TCB 中；

●分配内存并加载用户程序，并将它的大小和起始线性地址登记到TCB 中。

第475、476 行，令段寄存器ES 指向4GB 内存段。

第478 行，先从栈中取得TCB 的线性首地址。注意，因为源操作数部分使用的是基址寄存器EBP，故该指令默认使用段寄存器SS 来访问内存（栈）。

接着，第481～484 行，申请分配160 字节的内存空间用于创建LDT，并登记LDT 的初始界限和起始线性地址到TCB 中。LDT 的界限也是16 位的，只允许8192 个描述符。和GDT 一样，界限值是表的总字节数减1，因为我们刚创建LDT，总字节数为0，所以，当前的界限值应当是0xFFFF（0 减去1）。

我们的用户程序很简单，不会划分为太多的段，160 字节的空间可以安装20 个描述符，应当足够了。如图14-12 所示，LDT 的线性起始地址是登记在TCB 内偏移0x0C 处，LDT 的界限是登记在TCB 内偏移0x0A 处。TCB 当初也是动态分配的，需要通过段寄存器ES 指向的4GB段来访问。

第487～500 行，先将用户程序头部读入内核缓冲区中，根据它的大小决定分配多少内存。具体的方法和策略在上一章已讲解过了，唯一需要说明的是，在调用过程sys_routine_seg_sel:read_ hard_disk_0 之前，用户程序的起始逻辑扇区号是从栈中取得的。

第502～504 行，根据用户程序的实际大小申请分配内存空间，并将线性基地址和用户程序的大小登记到TCB 中（参考图14-12）。

一旦知道了用户程序的总大小，接下来，第506～519 行的工作就是加载整个用户程序，这和上一章也是相同的。唯一不同的是，第515 行，从栈中重新取得用户程序的起始逻辑扇区号。