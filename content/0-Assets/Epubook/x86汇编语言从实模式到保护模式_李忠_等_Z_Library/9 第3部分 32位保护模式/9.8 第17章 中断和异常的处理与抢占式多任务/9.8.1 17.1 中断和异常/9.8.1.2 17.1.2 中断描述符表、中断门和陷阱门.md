### 17.1.2　中断描述符表、中断门和陷阱门

在实模式下，位于内存最低端的1KB 内存，是中断向量表（IVT），定义了256 种中断的入口地址，包括16 位段地址和16 位段内偏移量。当中断发生时，处理器要么自发产生一个中断向量，要么从int n 指令中得到中断向量，或者从外部的中断控制器接受一个中断向量。然后，它将该向量作为索引访问中断向量表。具体的做法是，将中断向量乘以4，作为表内偏移量访问中断向量表，从中取得中断处理过程的段地址和偏移地址，并转到那里执行。

在保护模式下，处理器对中断的管理是相似的，但并非使用传统的中断向量表来保存中断处理过程的地址，而是中断描述符表（Interrupt Descriptor Table，IDT）。顾名思义，在这个表里，保存的是和中断处理过程有关的描述符，包括中断门、陷阱门和任务门。

任务门的格式我们已经在前面的章节里介绍过了，中断门和陷阱门的格式如图17-1 所示。

事实上，调用门、任务门、中断门和陷阱门的描述符非常相似，从大的方面来说，因为都用于实施控制转移，故都包括16 位的目标代码段选择子，以及32 位的段内偏移量。由图17-1 中可见，中断门和陷阱门仅仅有一比特的差别。中断门和陷阱门描述符只允许存放在IDT 内，任务门可以位于GDT、LDT 和IDT 中。

和实模式下的中断向量表（IVT）不同，保护模式下的IDT 不要求必须位于内存的最低端。事实上，在处理器内部，有一个48 位的中断描述符表寄存器（Interrupt Descriptor Table Register，IDTR），保存着中断描述符表在内存中的线性基地址和界限。如图17-2 所示，和GDT 一样，因为整个系统中只需要一个IDT 就够了，所以，GDTR 与IDTR 不像LDTR 和TR，没有也不需要选择器部分。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00725.jpeg)

图17-1　中断门和陷阱门描述符的格式

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00726.jpeg)

图17-2　中断描述符表寄存器

这就意味着，中断描述符表IDT 可以位于内存中的任何地方，只要IDTR 指向了它，整个中断系统就可以正常工作。为了利用高速缓存使处理器的工作性能最大化，建议IDT 的基地址是8字节对齐的（地址的数值能够被8 整除）。处理器复位时，IDTR 的基地址部分为0，界限部分的值为0xFFFF。16 位的表界限值意味着IDT 和GDT、LDT 一样，表的大小可以是64KB，但是，事实上，因为处理器只能识别256 种中断，故通常只使用2KB，其他空余的槽位应当将描述符的P 位清零。最后，与GDT 不同的是，IDT 中的第一个描述符也是有效的。

如图17-3 所示，在保护模式下，当中断和异常发生时，处理器用中断向量乘以8 的结果去访问IDT，从中取得对应的描述符。因为IDT 在内存中的位置是由IDTR 指示的，所以这很容易做到。

注意，从图17-3 中可以看出，这里没有考虑分页，也没有考虑门描述符是任务门的情况，因为任务门的处理比较特殊。中断门和陷阱门中有目标代码段描述符的选择子，以及段内偏移量。取决于选择子的TI 位，处理器访问GDT 或者LDT，取出目标代码段的描述符。接着，从目标代码段的描述符中取得目标代码段所在的基地址，再同门描述符中的偏移量相加，就得到了中断处理程序的32 位线性地址。如果没有开启分页功能，该线性地址就是物理地址；否则，送页部件转换成物理地址。注意，当处理器用中断向量访问IDT 时，要访问的位置超出了IDT 的界限，则产生常规保护异常（#GP）。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00727.jpeg)

图17-3　保护模式下的中断处理过程示意图