### 17.1.4　中断任务

当中断和异常发生时，如果根据中断向量从IDT 中找到的描述符是任务门，则不是进行一般的中断处理过程，而是发起任务切换。如图17-5 所示，这是通过中断发起任务切换的原理。

用中断发起任务切换，直觉上的好处是方便。比如，因为硬件中断的发生是客观的，很容易用它来实现一个剥夺式的、抢占式的多任务系统（硬件调度机制）。

不过，这并不是它最主要的目的。想象一下，当前任务正在执行的时候，突然发生了终止类型的异常，比如双重故障（#DF），会怎么样。在这种情况下，要想用iretd 指令返回到那个任务继续正常执行已无可能。在这种情况下，如果把双重故障的处理程序定义成任务，会非常恰当。当双重故障发生时，执行任务切换，切换到内核任务中去，从容地把发生故障的任务从系统中抹去，回收内存空间，并重新调度其他任务的执行，会是最好的解决办法。具体地说，在中断机制中使用任务门可以获得以下好处：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00731.jpeg)

图17-5　通过中断发起的任务切换

●被中断的那个程序或任务的整个执行环境可以被完整地保存起来（保存到它的TSS 中）。

●由于接管控制的是一个新的任务，因此，可以使用一个全新的0 特权级栈。这可以有效地防止因当前任务的0 特权级栈遭到破坏而使系统崩溃。

●由于是切换到一个新任务，因此，它有一个独立的地址空间。

当然，和一般的中断处理过程相比，利用中断发起任务切换也有不利的一面，那就是速度很慢，毕竟要保存大量的机器状态，并进行一系列特权级和内存访问的检查工作。

因中断和异常而发起任务切换时，不再保存CS、EIP 的状态，但是，在任务切换工作完成后，处理器要把错误代码压入新任务的栈中（如果有错误代码的话）。

任务是不可重入的，因此，在进入中断任务之后和执行iretd 指令之前，必须关中断，以防止因相同的中断再次发生而产生常规保护异常（#GP）。

作为对任务门的保护，和中断门、陷阱门一样，只对通过int3、int n 和into 指令发起的任务切换实施特权级检查，即，只有在数值上符合以下条件，才允许通过以上指令发起任务切换：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00732.jpeg)

在其他异常和硬件中断的情况下，不检查任务门的特权级。另外，由于是任务切换，不对目标代码段的特权级别进行检查。