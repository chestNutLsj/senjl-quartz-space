### 17.1.3　中断和异常处理程序的保护

和通过调用门实施的控制转移一样，处理器要对中断和异常处理程序进行特权级保护。当目标代码段描述符的特权级（可以用门描述符中的段选择子，从GDT 或LDT 中找到）低于当前特权级CPL 时，即，在数值上，

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00728.jpeg)

时，不允许将控制转移到中断或异常处理程序，违反此规则将引发常规保护异常（#GP）。

不过，中断和异常处理程序的特权级保护也有一些特别之外。具体表现在：

●因为中断和异常的向量中没有RPL 字段，故当处理器进入中断或异常处理程序，或者通过任务门发起任务切换时，不检查RPL。

●中断门、陷阱门也有自己的描述符特权级DPL，即门的DPL，参见图17-1。但是，通常情况下不针对该DPL 进行检查，除了用软中断int n 和单步中断int3，以及into 引发的中断和异常。在这种情况下，当前特权级CPL 必须高于，或者和门的特权级DPL 相同，即，在数值上，

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00729.jpeg)

这主要是为了防止低特权级的软件通过软中断指令访问一些只为内核服务的例程，如页故障处理。相反地，对于硬件中断和处理器检测到异常情况而引发的中断处理，不检查门的DPL。

中断和异常是随机产生的，不可预测。但是，有一点是可以确定的，即，它总是发生在某个任务内，是在某个任务正在执行的时候产生的，即使整个系统内只有一个任务。

当中断和异常发生时，任务可能正在特权级别为0 的全局空间（内核）中执行，也可能正在特权级别为3 的局部空间内执行。因此，当处理器将控制转移到中断或异常处理程序时，如果处理程序运行在较高的特权级别上（数值上较低的），那么，将转换栈：

●根据处理程序的特权级别，从当前任务的TSS 中取得栈段选择子和栈指针。处理器把旧栈的选择子和栈指针压入新栈。毕竟，中断处理程序也是当前任务的一部分。

●处理器把EFLAGS、CS 和EIP 的当前状态压入新栈。

●对于有错误代码的异常，处理器还要把错误代码压入新栈，紧挨着EIP 之后，如图17-4（a）所示。

●如果中断处理程序的特权级别和当前特权级别一致，则不用转换栈。

●处理器把EFLAGS、CS 和EIP 的当前状态压入当前栈。

●对于有错误代码的异常，处理器还要把错误代码压入当前栈，紧挨着EIP 之后，如图17-4（b）所示。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00730.jpeg)

图17-4　控制转移到中断/异常处理程序时的两种栈使用情况

中断门和陷阱门的区别不大，通过中断门进入中断处理程序时，EFLAGS 寄存器的IF 位被处理器自动清零，以禁止嵌套的中断，当中断返回时，将从栈中恢复EFLAGS 寄存器的原始状态。陷阱中断的优先级较低，当通过陷阱门进入中断处理程序时，EFLAGS 寄存器的IF 位不变，以允许其他中断优先处理。

EFLAGS 寄存器的IF 位仅影响硬件中断，对NMI、异常和int n 形式的软件中断不起作用。