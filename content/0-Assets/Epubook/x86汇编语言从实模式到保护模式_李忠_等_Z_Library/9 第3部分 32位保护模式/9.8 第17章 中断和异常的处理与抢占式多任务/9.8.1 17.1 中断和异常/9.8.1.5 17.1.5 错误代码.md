### 17.1.5　错误代码

有些异常产生时，处理器会在异常处理程序或中断任务的栈中压入一个错误代码。通常，这意味着异常和特定的段选择子或中断向量有关。

如图17-6 所示，压入栈中的错误代码是32 位的，但高16 位不用。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00733.jpeg)

图17-6　错误代码的格式

EXT 位的意思是，异常是由外部事件引发的（External Event）。此位置位时，表示异常是由NMI、硬件中断等引发的。

IDT 位用于指示描述符的位置（Descriptor Location）。为“1”时，表示段选择子的索引部分（错误代码的位15～3）是指向中断描述符表（IDT）的；为“0”时，表示段选择子的索引部分指向GDT 或者LDT。

TI 位仅在IDT 位是“0”的情况下才有意义。此位是“0”时，表示段选择子的索引部分指向GDT，否则，指向LDT。

段选择子的索引部分用于指示GDT/LDT 内的段描述符，或者IDT 内的门描述符，它就是我们平时所用的段选择子的高13 位。

有时候，错误代码可能是全零（空），这表示异常的产生并非由于引用了一个特定的段。当然，也可能确实是在引用一个段的时候发生的，而且由于那个段的描述符是空描述符。所谓引用一个段，通常是执行了这样的指令：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00734.jpeg)

注意，当通过iret/iretd 指令从中断处理程序返回时，处理器并不会自动弹出错误代码。因此，对于那些有异常代码的异常处理过程来说，必须在执行iret/iretd 指令前，先从栈中移去（或弹出）错误代码。否则，处理器在执行iret/iretd 指令时，加载（弹出）到CS 和EIP 中的返回地址就是错的。

对于外部异常（通过处理器引脚触发），以及用软中断指令int n 引发的异常，处理器不会压入错误代码，即使它原本是一个有错误代码的异常。分配给外部中断的向量号在31～255 之间，出于特殊的目的，外部的8259A 或者I/O APIC 芯片可能会给出一个0～19 的向量号，比如13（常规保护异常#GP），并希望进行异常处理。在这种情况下，处理器并不会像通常那样压入错误代码。同样地，用软中断指令

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00735.jpeg)

有意引发的异常，也不会压入错误代码。