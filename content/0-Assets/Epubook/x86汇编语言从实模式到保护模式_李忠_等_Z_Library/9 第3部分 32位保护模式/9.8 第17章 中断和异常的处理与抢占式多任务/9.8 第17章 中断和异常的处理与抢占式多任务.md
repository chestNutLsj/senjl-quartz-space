   

# 第17章　中断和异常的处理与抢占式多任务

说实话，在开始这一章的写作任务之前，我从来没有意识到它这么重要。相反，我以为它可以很轻松。

一开始，在我的规划中，还有第18 章，名字我都想好了，叫“抢占式的多任务轮转和调度”，而且相信这样的名字会让很多喜欢钻研的人感兴趣。

但是，很快我就意识到，这两章的内容都很单一，而且这些内容互相交叉，联系很紧密。想想看，抢占式的多任务轮转，是离不开中断的。因此，我决定把原定的两章合为一章，就是这一章。

中断和异常中断的内容是很重要的。至少，你需要知道处理器会引发哪些异常，在什么情况下会引发异常，这对于编写正确的程序，以及调试这些程序来说，是非常重要的。但是，还记得上一章的习题吗？有一道题是选做的，要求用平坦内存模型来改写系统内核，我突然想到这是一道非常难的习题，也许没有一个初学者能够完成这个任务。进而我又想到，如果我把这一章的内核代码写成平坦内存模型的，将是一件了不起的事。之所以了不起，是因为它可以使读者们更加深入地，不，是彻底地理解分页机制的原理。于是，我花了一天的时间，终于把内核代码改成了平坦模型。

然后，我又发现，作为一本汇编语言教程，宏（Macro）是不可或缺的。绝大多数的汇编语言编译器都支持宏，绝大多数的教科书都要着重地讲到宏。因此，不讲宏，对不起读者，对不起汇编语言。

穿过这一章，这本书就结束了，让我们开始吧。本章的目标是：

1． 了解保护模式下x86 处理器中断和异常中断的工作机制，知道中断和异常中断的分类，认识中断描述符表IDT、中断门和陷阱门。

2． 使本章程序完全在平坦内存模型下工作，进一步加深对分页机制、TLB 以及虚拟地址空间等概念的理解，了解在平坦内存模型下进行汇编语言程序设计的特点。

3． 使用硬件中断实施抢占式多任务切换，彻底理解任务切换的原理和过程。在这个过程中，学习一种简单的任务调度算法，以及单向链表的遍历、节点的追加／插入／删除／移动算法。

4． 学习宏汇编技术的应用。

5． 学习几条新的x86 处理器指令，包括lidt、invlpg、bound 和ud2 等。