### 10.1.1　寄存器的扩展

在16 位处理器内，有8 个通用寄存器AX、BX、CX、DX、SI、DI、BP 和SP，其中，前4个还可以拆分成两个独立的8 位寄存器来用，即AH、AL、BH、BL、CH、CL、DH 和DL。如图10-1 所示，32 位处理器在16 位处理器的基础上，扩展了这8 个通用寄存器的长度，使之达到32 位。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00358.jpeg)

图10-1　32 位处理器内部的通用寄存器

为了在汇编语言程序中使用经过扩展（Extend）的寄存器，需要给它们命名，它们的名字分别是EAX、EBX、ECX、EDX、ESI、EDI、ESP 和EBP。可以在程序中使用这些寄存器，即使是在实模式下：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00359.jpeg)

但是，就像以上指令所示的那样，指令的源操作数和目的操作数必须具有相同的长度，个别特殊用途的指令除外。因此，像这样的搭配是不允许的，在程序编译时，编译器会报告错误：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00360.jpeg)

如果目的操作数是32 位寄存器，源操作数是立即数，那么，立即数被视为32 位的：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00361.jpeg)

32 位通用寄存器的高16 位是不可独立使用的，但低16 位保持同16 位处理器的兼容性。因此，在任何时候它们都可以照往常一样使用：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00362.jpeg)

可以在32 位处理器上运行16 位处理器上的软件。但是，它并不是16 位处理器的简单增强。事实上，32 位处理器有自己的32 位工作模式，在本书中，32 位模式特指32 位保护模式。在这种模式下，可以完全、充分地发挥处理器的性能。同时，在这种模式下，处理器可以使用它全部的32 根地址线，能够访问4GB 内存。

如图10-2 所示，在32 位模式下，为了生成32 位物理地址，处理器需要使用32 位的指令指针寄存器。为此，32 位处理器扩展了IP，使之达到32 位，即EIP。当它工作在16 位模式下时，依然使用16 位的IP；工作在32 位模式下时，使用的是全部的32 位EIP。和往常一样，即使是在32 位模式下，EIP 寄存器也只由处理器内部使用，程序中是无法直接访问的。对IP 和EIP 的修改通常是用某些指令隐式进行的，这些指令包括JMP、CALL、RET 和IRET 等等。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00363.jpeg)

图10-2　32 位处理器的指令指针、标志和段寄存器

另外，在16 位处理器中，标志寄存器FLAGS 是16 位的，在32 位处理器中，扩展到了32位，低16 位和原先保持一致。关于EFLAGS 中的各个标志位，将在后面的章节中逐一介绍。

在32 位模式下，对内存的访问从理论上来说不再需要分段，因为它有32 根地址线，可以自由访问任何一个内存位置。但是，IA-32 架构的处理器是基于分段模型的，因此，32 位处理器依然需要以段为单位访问内存，即使它工作在32 位模式下。

不过，它也提供了一种变通的方案，即，只分一个段，段的基地址是0x00000000，段的长度（大小）是4GB。在这种情况下，可以视为不分段，即平坦模型（Flat Mode）。

每个程序都有属于自己的内存空间。在16 位模式下，一个程序可以自由地访问不属于它的内存位置，甚至可以对那些地方的内容进行修改。这当然是不安全的，也不合法，但却没有任何机制来限制这种行为。在32 位模式下，处理器要求在加载程序时，先定义该程序所拥有的段，然后允许使用这些段。定义段时，除了基地址（起始地址）外，还附加了段界限、特权级别、类型等属性。当程序访问一个段时，处理器将用固件实施各种检查工作，以防止对内存的违规访问。

如图10-2 所示，在32 位模式下，传统的段寄存器，如CS、SS、DS、ES，保存的不再是16位段基地址，而是段的选择子，即，用于选择所要访问的段，因此，严格地说，它的新名字叫做段选择器。除了段选择器之外，每个段寄存器还包括一个不可见部分，称为描述符高速缓存器，里面有段的基地址和各种访问属性。这部分内容程序不可访问，由处理器自动使用。

有关32 位模式下的段和段的访问方法，将在后面的章节中予以详述，你在看这段文字的时候，也许有迷迷糊糊的感觉，没关系，这是正常的，到后面你就会感觉豁然开朗了。

最后，32 位处理器增加了两个额外的段寄存器FS 和GS。对于某些复杂的程序来说，多出两个段寄存器可能会令它们感到高兴。