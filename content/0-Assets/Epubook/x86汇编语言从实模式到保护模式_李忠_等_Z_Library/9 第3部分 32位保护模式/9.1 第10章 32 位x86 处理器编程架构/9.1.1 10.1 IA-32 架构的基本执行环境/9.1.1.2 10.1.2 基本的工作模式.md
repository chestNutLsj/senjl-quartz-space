### 10.1.2　基本的工作模式

8086 具有16 位的段寄存器、指令指针寄存器和通用寄存器（CS、SS、DS、ES、IP、AX、BX、CX、DX、SI、DI、BP、SP），因此，我们称它为16 位的处理器。尽管它可以访问1MB 的内存，但是只能分段进行，而且由于只能使用16 位的段内偏移量，故段的长度最大只能是64KB。8086 只有一种工作模式，即实模式。当然，这个名称是后来才提出来的。

1982 年的时候，Intel 公司推出了80286 处理器。这也是一款16 位的处理器，大部分的寄存器都和8086 处理器一样。因此，80286 和8086 一样，因为段寄存器是16 位的，而且只能使用16位的偏移地址，在实模式下只能使用64KB 的段；尽管它有24 根地址线，理论上可以访问224，即16MB 的内存,但依然只能分成多个段来进行。

但是，80286 和8086 不一样的地方在于，它第一次提出了保护模式的概念。在保护模式下，段寄存器中保存的不再是段地址，而是段选择子，真正的段地址位于段寄存器的描述符高速缓存中，是24 位的。因此，运行在保护模式下的80286 处理器可以访问全部16MB 内存。

80286 处理器访问内存时，不再需要将段地址左移，因为在段寄存器的描述符高速缓存器中有24 位的段物理基地址。这样一来，段可以位于16MB 内存空间中的任何位置，而不再限于低端1MB 范围内，也不必非得是位于16 字节对齐的地方。不过，由于80286 的通用寄存器是16位的，只能提供16 位的偏移地址，因此，和8086 一样，即使是运行在保护模式下，段的长度依然不能超过64KB。对段长度的限制妨碍了80286 处理器的应用，这就是16 位保护模式很少为人所知的原因。

实模式等同于8086 模式，在本书中，实模式和16 位保护模式统称16 位模式。在16 位模式下，数据的大小是8 位或者16 位的；控制转移和内存访问时，偏移量也是16 位的。

1985 年的80386 处理器是Intel 公司的第一款32 位产品，而且获得了极大成功，是后续所有32 位产品的基础。本书中的绝大多数例子，都可以在80386 上运行。和8086/80286 不同，80386处理器的寄存器是32 位的，而且拥有32 根地址线，可以访问232，即4GB 的内存。

80386，以及所有后续的32 位处理器，都兼容实模式，可以运行实模式下的8086 程序。而且，在刚加电时，这些处理器都自动处于实模式下，此时，它相当于一个非常快速的8086 处理器。只有在进行一番设置之后，才能运行在保护模式下。

在保护模式下，所有的32 位处理器都可以访问多达4GB 的内存，它们可以工作在分段模型下，每个段的基地址是32 位的，段内偏移量也是32 位的，因此，段的长度不受限制。在最典型的情况下，可以将整个4GB 内存定义成一个段来处理，这就是所谓的平坦模式。在平坦模式下，可以执行4GB 范围内的控制转移，也可以使用32 位的偏移量访问任何4GB 范围内的任何位置。32 位保护模式兼容80286 的16 位保护模式。

除了保护模式，32 位处理器还提供虚拟8086 模式（V86 模式），在这种模式下，IA-32 处理器被模拟成多个8086 处理器并行工作。V86 模式是保护模式的一种，可以在保护模式下执行多个8086 程序。传统上，要执行8086 程序，处理器必须工作在实模式下。在这种情况下，为32 位保护模式写的程序就不能运行。但是，V86 模式提供了让它们在一起同时运行的条件。

V86 模式曾经很有用，因为在那个时候，8086 程序很多，而32 位应用程序很少，这个过渡期是必需的。现在，这种工作模式已经基本无用了。

在本书中，32 位模式特指IA-32 处理器上的32 位保护模式。不存在所谓的32 位实模式，实模式的概念实质上就是8086 模式。