### 8.3.5　通过硬盘控制器端口读扇区数据

现在，让我们来看看硬盘。

硬盘读写的基本单位是扇区。就是说，要读就至少读一个扇区，要写就至少写一个扇区，不可能仅读写一个扇区中的几个字节。这样一来，就使得主机和硬盘之间的数据交换是成块的，所以硬盘是典型的块设备。

从硬盘读写数据，最经典的方式是向硬盘控制器分别发送磁头号、柱面号和扇区号（扇区在某个柱面上的编号），这称为CHS 模式。这种方法最原始，最自然，也最容易理解。

实际上，在很多时候，我们并不关心扇区的物理位置，所以希望所有的扇区都能统一编址。这就是逻辑扇区，它把硬盘上所有可用的扇区都一一从0 编号，而不管它位于哪个盘面，也不管它属于哪个柱面。

关于硬盘和逻辑扇区的知识前面已经有所介绍，这里不再赘述。最早的逻辑扇区编址方法是LBA28，使用28 个比特来表示逻辑扇区号，从逻辑扇区0x0000000 到0xFFFFFFF，共可以表示228＝268435456 个扇区。每个扇区有512 字节，所以LBA28 可以管理128 GB 的硬盘。

硬盘技术发展得非常快，最新的硬盘已经达到几百个吉字节的容量，LBA28 已经落后了。在这种情况下，业界又共同推出了LBA48，采用48 个比特来表示逻辑扇区号。如此一来，就可以管理131072 TB 的硬盘容量了。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00275.jpeg)

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00276.jpeg)

在本章中，我们将采用LBA28 来访问硬盘。

前面说过，个人计算机上的主硬盘控制器被分配了8 位端口，端口号从0x1f0 到0x1f7。假设现在要从硬盘上读逻辑扇区，那么，整个过程如下。

第1 步，设置要读取的扇区数量。这个数值要写入0x1f2 端口。这是个8 位端口，因此每次只能读写255 个扇区：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00277.jpeg)

注意，如果写入的值为0，则表示要读取256 个扇区。每读一个扇区，这个数值就减一。因此，如果在读写过程中发生错误，该端口包含着尚未读取的扇区数。

第2 步，设置起始LBA 扇区号。扇区的读写是连续的，因此只需要给出第一个扇区的编号就可以了。28 位的扇区号太长，需要将其分成4 段，分别写入端口0x1f3、0x1f4、0x1f5 和0x1f6 号端口。其中，0x1f3 号端口存放的是0～7 位；0x1f4 号端口存放的是8～15 位；0x1f5 号端口存放的是16～23 位，最后4 位在0x1f6 号端口。假定我们要读写的起始逻辑扇区号为0x02，可编写代码如下：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00278.jpeg)

注意以上代码的最后4 行，在现行的体系下，每个PATA/SATA 接口允许挂接两块硬盘，分别是主盘（Master）和从盘（Slave）。如图8-11 所示，0x1f6 端口的低4 位用于存放逻辑扇区号的24～27位，第4 位用于指示硬盘号，0 表示主盘，1 表示从盘。高3 位是“111”，表示LBA 模式。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00279.jpeg)

图8-11　端口1f6 各位的含义

第3 步，向端口0x1f7 写入0x20，请求硬盘读。这也是一个8 位端口：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00280.jpeg)

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00281.jpeg)

第4 步，等待读写操作完成。端口0x1f7 既是命令端口，又是状态端口。在通过这个端口发送读写命令之后，硬盘就忙乎开了。如图8-12 所示，在它内部操作期间，它将0x1f7 端口的第7位置“1”，表明自己很忙。一旦硬盘系统准备就绪，它再将此位清零，说明自己已经忙完了，同时将第3 位置“1”，意思是准备好了，请求主机发送或者接收数据（图8-12）。完成这一步的典型代码如下:

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00282.jpeg)

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00283.jpeg)

图8-12　端口0x1f7 部分状态位的含义

来看看指令and al,0x88。0x88 的二进制形式是10001000，这意味着我们想用这条指令保留住寄存器AL 中的第7 位和第3 位，其他无关的位都清零。此时，如果寄存器AL 中的二进制数是00001000（0x08），那就说明可以退出等待状态，继续往下操作，否则继续等待。

第5 步，连续取出数据。0x1f0 是硬盘接口的数据端口，而且还是一个16 位端口。一旦硬盘控制器空闲，且准备就绪，就可以连续从这个端口写入或者读取数据。下面的代码假定是从硬盘读一个扇区（512 字节，或者256 字节），读取的数据存放到由段寄存器DS 指定的数据段，偏移地址由寄存器BX 指定：

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00284.jpeg)

最后，0x1f1 端口是错误寄存器，包含硬盘驱动器最后一次执行命令后的状态（错误原因）。