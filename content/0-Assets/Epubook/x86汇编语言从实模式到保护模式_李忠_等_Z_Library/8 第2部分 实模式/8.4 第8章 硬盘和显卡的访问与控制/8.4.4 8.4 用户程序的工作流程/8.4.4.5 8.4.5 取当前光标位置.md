### 8.4.5　取当前光标位置

显卡的操作非常复杂，内部的寄存器也不是一般地多。为了不过多占用主机的I/O 空间，很多寄存器只能通过索引寄存器间接访问。

索引寄存器的端口号是0x3d4，可以向它写入一个值，用来指定内部的某个寄存器。比如，两个8 位的光标寄存器，其索引值分别是14（0x0e）和15（0x0f），分别用于提供光标位置的高8 位和低8 位。

指定了寄存器之后，要对它进行读写，这可以通过数据端口0x3d5 来进行。

好，现在言归正传。过程put_char 看起来并不太复杂，但实际上判断和分支较多。为了便于读者理解这段代码，也为了方便讲解，图8-19 给出了它的工作流程图。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00325.jpeg)

图8-19　过程put_char 的流程图

庞大复杂的建筑必须得有图纸才能施工，而绘制图纸的过程中你经常发现自己有更好的设计思路，更能知道如何盖这栋房子。编写复杂的程序前先画一画流程图，是程序员的基本素养，这有助于问题的解决。

代码清单8-2 第43～48 行，在过程put_char 的开始部分先将用到的部分寄存器压栈保存，其中包括两个段寄存器DS 和ES。

第51～53 行，通过索引端口告诉显卡，现在要操作0x0e 号寄存器。

第54～56 行，通过数据端口从0x0e 号端口读出1 字节的数据，并传送到寄存器AH 中，这是屏幕光标位置的高8 位。

同样地，第58～62 行，从0x0f 号寄存器读出光标位置的低8 位。现在，寄存器AX 中是完整的光标位置数据。第63 行，将这个数值传送到寄存器BX 中保存，因为马上就要用到寄存器AX。