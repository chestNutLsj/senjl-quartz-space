### 9.1.2　可屏蔽中断

和NMI 不同，更多的时候，发往处理器的中断信号通常不会意味着灾难。当然，有时候也会非常紧急，比如，在一个由计算机控制的车床上，当零件快速通过铣具时，处理器应当立即处理中断，并向铣具发送信号，告诉它应当如何切削。

这类中断有两个特点，第一是数量很多，毕竟有很多外部设备；第二是它们可以被屏蔽，这样处理器就像是没听见、没看见一样，不会对它们进行处理。所以，这类硬件中断称为可屏蔽中断。尽管不处理中断就会把零件铣坏，但是否允许处理器看见该中断，是你自己的事，这是处理器赋予你的权利。

可屏蔽中断是通过INTR 引脚进入处理器内部的，像NMI 一样，不可能为每一个中断源都提供一个引脚。而且，处理器每次只能处理一个中断。在这种情况下，需要一个代理，来接受外部设备发出的中断信号。还有，多个设备同时发出中断请求的几率也是很高的，所以该代理的任务还包括对它们进行仲裁，以决定让它们中的哪一个优先向处理器提出服务请求。

如图9-2 所示，在个人计算机中，用得最多的中断代理就是8259 芯片，它就是通常所说的中断控制器，从8086 处理器开始，它就一直提供着这种服务。即使是现在，在绝大多数单处理器的计算机中，也依然有它的存在。

Intel 处理器允许256 个中断，中断号的范围是0～255，8259 负责提供其中的15 个，但中断号并不固定。之所以不固定，是因为当初设计的时候，允许软件根据自己的需要灵活设置中断号，以防止发生冲突。该中断控制器芯片有自己的端口号，可以像访问其他外部设备一样用in 和out 指令来改变它的状态，包括各引脚的中断号。正是因为这样，它又叫可编程中断控制器（Programmable Interrupt Controller，PIC）。

![img](../0-Assets/Epubook/x86汇编语言从实模式到保护模式_李忠_等_Z_Library/images/00333.jpeg)

图9-2　单处理器系统的中断机制

不知道是怎么想的，反正每片8259 只有8 个中断输入引脚，而在个人计算机上使用它，需要两块。如图9-2 所示，第一块8259 芯片的代理输出INT 直接送到处理器的INTR 引脚，这是主片（Master）；第二块8259 芯片的INT 输出送到第一块的引脚2 上，是从片（Slave），两块芯片之间形成级联（Cascade）关系。

如此一来，两块8259 芯片可以向处理器提供15 个中断信号。当时，接在8259 上的15 个设备都是相当重要的，如PS/2 键盘和鼠标、串行口、并行口、软磁盘驱动器、IDE 硬盘等。现在，这些设备很多都已淘汰或者正在淘汰中，根据需要，这些中断引脚可以被其他设备使用。

如图9-2 所示，8259 的主片引脚0（IR0）接的是系统定时器/计数器芯片；从片的引脚0 （IR0）接的是实时时钟芯片RTC，该芯片是本章的主角，很快就会讲到。总之，这两块芯片的固定连接即使是在硬件更新换代非常频繁的今天，也依然没有改变。

在8259 芯片内部，有中断屏蔽寄存器（Interrupt Mask Register，IMR），这是个8 位寄存器，对应着该芯片的8 个中断输入引脚，对应的位是0 还是1，决定了从该引脚来的中断信号是否能够通过8259 送往处理器（0 表示允许，1 表示阻断，这可能出乎你的意料）。当外部设备通过某个引脚送来一个中断请求信号时，如果它没有被IMR 阻断，那么，它可以被送往处理器。注意，8259 芯片是可编程的，主片的端口号是0x20 和0x21，从片的端口号是0xa0 和0xa1，可以通过这些端口访问8259 芯片，设置它的工作方式，包括IMR 的内容。

中断能否被处理，除了要看8259 芯片的脸色外，最终的决定权在处理器手中。回到前面第6章，参阅图6-2，你会发现，在处理器内部，标志寄存器有一个标志位IF，这就是中断标志（Interrupt Flag）。当IF 为0 时，所有从处理器INTR 引脚来的中断信号都被忽略掉；当其为1 时，处理器可以接受和响应中断。

IF 标志位可以通过两条指令cli 和sti 来改变。这两条指令都没有操作数，cli（CLear Interrupt flag）用于清除IF 标志位，sti（SeT Interrupt flag）用于置位IF 标志。

检测点9.1

写一个小的主引导程序，在程序中使用sti 和cli 指令，并用Bochs 观察IF 位的变化。

在计算机内部，中断发生得非常频繁，当一个中断正在处理时，其他中断也会陆续到来，甚至会有多个中断同时发生的情况，这都无法预料。不用担心，8259 芯片会记住它们，并按一定的策略决定先为谁服务。总体上来说，中断的优先级和引脚是相关的，主片的IR0 引脚优先级最高，IR7 引脚最低，从片也是如此。当然，还要考虑到从片是级联在主片的IR2 引脚上。

最后，当一个中断事件正在处理时，如果来了一个优先级更高的中断事件时，允许暂时中止当前的中断处理，先为优先级较高的中断事件服务，这称为中断嵌套。