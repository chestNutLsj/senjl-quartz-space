### 2.4.1　自顶向下分析方法

我们在介绍自顶向下的分析方法时考虑的文法适合使用自顶向下分析技术。在本节后面的内容中，我们将考虑构造自顶向下语法分析器的一般方法。图2-16中的文法生成C或Java语句的一个子集。我们分别用黑体终结符if和for表示关键字“`if`”和“`for`”，以强调这些字符序列被视为一个单元，也就是单个终结符号。此外，终结符expr代表表达式。一个更完整的文法将使用非终结符号expr，并带有多个关于非终结符号expr的产生式。类似地，other是一个代表其他语句构造的终结符号。

![053-1](../Images/image03989.jpeg)

图2-16　C和Java中某些语句的文法

在自顶向下地构造一棵如图2-17所示的语法分析树时，从标号为开始非终结符stmt的根结点开始，反复执行下面两个步骤：

![053-2](../Images/image03990.jpeg)

图2-17　根据图2-16中的文法得到的语法分析树

1）在标号为非终结符号A的结点N上，选择A的一个产生式，并为该产生式体中的各个符号构造出N的子结点。

2）寻找下一个结点来构造子树，通常选择的是语法分析树最左边的尚未扩展的非终结符。

对于某些文法，上面的步骤只需要对输入串进行一次从左到右的扫描就可以完成。输入中当前被扫描的终结符号通常称为向前看（lookahead）符号。在开始时，向前看符号是输入串的第一个（即最左的）终结符号。图2-18演示了构造如下输入串的语法分析树的过程：

for（；expr；expr）other

得到的语法分析树如图2-17所示。一开始，向前看符号是终结符号for，语法分析树的已知部分只包含标号为开始非终结符号stmt的根结点，如图2-18a所示。我们的目标是以适当的方法构造出语法分析树的其余部分，使得这棵树生成的符号串与输入符号串匹配。

为了与输入串匹配，图2-18a中的非终结符号stmt必须推导出一个以向前看符号for开头的串。在图2-16所示的文法中，stmt只有一个产生式可以推导出这样的串，所以我们选择这个产生式，并构造出根结点的各个子结点，并使用该产生式体中的符号作为这些子结点的标号。这棵语法分析树的这次扩展如图2-18b所示。

在图2-18所示的三个快照中，都包含一个指向输入串中向前看符号的箭头和一个指向当前正被考虑的语法分析树结点的箭头。一旦一个结点的子结点全部构造完毕，我们就要考虑该结点的最左子结点。在图2-18b中，根结点的子结点刚刚构造完毕，下一个要考虑的结点是标号为for的最左子结点。

![054-1](../Images/image03991.jpeg)

图2-18　从左到右扫描输入串时进行的自顶向下语法分析

如果当前正考虑的语法分析树结点的标号是一个终结符号，而且此终结符号与向前看符号匹配，那么语法分析树的箭头和输入的箭头都前进一步。输入中的下一个终结符成为新的向前看符号，同时考虑语法分析树的下一个子结点。在图2-18c中，语法分析树的箭头指向根的下一个子结点，输入中的箭头已经前进到下一个终结符号，即“（”。再下一步将使得语法分析树的箭头指向标号为非终结符号optexpr的子结点，并将输入的箭头指向终结符号“；”。

在标号为optexpr的非终结符号结点上，我们需要再次为一个非终结符号选择产生式。以∈为体的产生式（即∈产生式）需要特殊处理。当前，我们将∈产生式当作默认选择，只有在没有其他产生式可用时才会选择它们。我们将在2.4.3节中再次讨论∈产生式。对于非终结符号optexpr和向前看符号“；”，我们使用optexpr的∈产生式，因为“；”和optexpr仅有的另一个产生式不匹配，那个产生式的体是终结符号expr。

一般来说，为一个非终结符号选择产生式是一个“尝试并犯错”的过程。也就是说，我们首先选择一个产生式，并在这个产生式不合适时进行回溯，再尝试另一个产生式。一个产生式“不合适”是指使用了该产生式之后，我们无法构造得到一棵与当前输入串相匹配的语法分析树。但是在称为预测语法分析的特殊情形下不需要进行回溯。我们接下来将讨论这个方法。