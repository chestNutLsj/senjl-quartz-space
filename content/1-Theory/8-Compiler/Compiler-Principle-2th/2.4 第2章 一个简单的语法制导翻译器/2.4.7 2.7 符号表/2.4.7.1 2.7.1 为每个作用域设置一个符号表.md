### 2.7.1　为每个作用域设置一个符号表

术语“标识符x的作用域”实际上指的是x的某个声明的作用域。术语作用域（scope）本身是指一个或多个声明起作用的程序部分。

作用域是非常重要的，因为在程序的不同部分，可能会出于不同的目的而多次声明相同的标识符。像`x`和`i`这样常见的名字会被重复使用。再例如，子类可以重新声明一个方法名字以覆盖父类中的相应方法。

如果程序块可以嵌套，那么同一个标识符的多次声明就可能出现在同一个块中。当stmts能生成一个程序块时，下面的语法规则会产生嵌套的块：

block → ′{′ decls stmts ′}′

（我们对这个语法中的花括号使用了引号，这么做的目的是将它们和用于语义动作的花括号区分开来。）在图2-38给出的文法中，decls生成一个可选的声明序列，stmts生成一个可选的语句序列。更进一步，一条语句可以是一个程序块，所以我们的语言支持嵌套的语句块。而标识符可以在这些块中重新声明。

块的符号表的优化

块的符号表的实现可以利用作用域的最近嵌套规则。嵌套的结构确保可应用的符号表形成一个栈。在栈的顶部是当前块的符号表。栈中这个表的下方是包含这个块的各个块的符号表。因此，符号表可以按照类似于栈的方式来分配和释放。

有些编译器维护了一个散列表来存放可访问的符号表条目。也就是说，存放那些没有被内嵌块中的某个声明掩盖起来的条目。这样的散列表实际上支持常量时间的查询，但是在进入和离开块时需要插入和删除相应的条目。在从一个块B离开时，编译器必须撤销所有因为B中的声明而对此散列表作出的修改。它可以在处理B的时候维护一个辅助的栈来跟踪对这个散列表的所做的修改。

语句块的最近嵌套（most-closely）规则是说，一个标识符x在最近的x声明的作用域中。也就是说，从x出现的块开始，从内向外检查各个块时找到的第一个对x的声明。

例2.15　下列伪代码用下标来区分对同一标识符的不同声明：

---

1）{ int x1；int y1；
2）  {  int w2；bool y2；int z2；
3）       …w2…；…x1…；…y2…；…z2…；
4）  }
5）   …w0…；…x1…；…y1…；
6）}

---

下标并不是标识符的一部分，它实际上是该标识符对应的声明的行号。因此，x的所有出现都位于第1行上声明的作用域中。第3行上出现的y位于第2行上y的声明的作用域中，因为y在内层块中被再次声明了。然而，第5行上出现的y位于第1行上y的声明的作用域中。

假设第5行上w的出现位于这个程序片段之外某个w的声明的作用域中，它的下标表示一个全局的或者位于这个块之外的声明。

最后，z在最内层的块中声明并使用。它不能在第5行上使用，因为这个内嵌的声明只能作用于最内层的块。

实现语句块的最近嵌套规则时，我们可以将符号表链接起来，也就是使得内嵌语句块的符号表指向外围语句块的符号表。

例2.16　图2-36显示了对应于例2.15中伪代码的符号表。B1对应于从第1行开始的语句块；B2对应着从第2行开始的语句块。图的顶端是符号表B0，它记录了全局的或由语言提供的默认声明。在我们分析第2行至第4行时，环境是由一个指向最下层的符号表（即B2的符号表）的指针表示的。当我们分析第5行时，B2的符号表变得不可访问，环境指针转而指向B1的符号表，此时我们可以访问上一层的全局符号表B0，但不能访问B2的符号表。

![070-1](../Images/image04020.jpeg)

图2-36　对应于例2.15的符号表链

图2-37中是链接符号表的Java实现。它定义了一个类`Env`（环境“environment”的缩写）[^9]。类`Env`支持三种操作：

![070-2](../Images/image04021.jpeg)

图2-37　类`Env`实现了链接符号表

- 创建一个新符号表。图2-37中第6行至第8行所示的构造函数`Env（p）`创建一个`Env`对象，该对象包含一个名为`table`的散列表。这个对象的字段`prev`被设置为参数`p`，而这个参数的值是一个环境，因此这个对象被链接到环境。虽然形成链表的是`Env`对象，但是将它们说成是链接的符号表比较方便。
- 在当前表中加入一个新的条目。散列表保存了键-值对，其中
- - 键（key）是一个字符串，也可以说是一个指向字符串的引用。我们也可以使用指向对应于标识符的词法单元对象的引用作为键。
    - 值（value）是一个`Symbol`类的条目。第9行到第11行的代码不需要知道一个条目的内部结构。也就是说，这个代码是独立于`Symbol`类的字段和方法的。
- 得到一个标识符的条目。它从当前块的符号表开始搜索链接符号表。第12行至第18行中这个操作的代码返回一个符号表条目或`null`。

因为会有多个语句块嵌套在同一外围语句块中，所以将这些符号表链接起来就可以形成一个树形结构。图2-36中的虚线提醒我们链接的符号表可以形成一棵树。