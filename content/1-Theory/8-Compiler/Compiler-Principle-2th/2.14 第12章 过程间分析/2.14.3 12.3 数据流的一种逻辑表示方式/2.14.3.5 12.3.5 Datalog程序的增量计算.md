### 12.3.5　Datalog程序的增量计算

有一个可行的方法可以提高算法12.15的效率。请注意，一个新的IDB事实只能在第i轮被发现的条件如下：它是对某一个规则进行常量替换后的结果，并且其中至少有一个子目标经过变换变成刚刚在第i-1轮发现的新事实。这个论断的证明如下：如果子目标中的所有事实在第i-2轮的时候都是已知的，那么这个“新”的事实应该在第i-1轮进行同样的常量替换时就已经被发现了。

为了利用这个性质，我们为每个IDB断言p引入一个断言newP，该断言只对上一轮中新发现的p事实成立。每一个在其子目标中包含了一个或多个IDB的规则都被替换为一组规则。这组规则中的每一个都是通过把原来规则体中的某一个IDB断言q替换为newQ而得到的。最后，对于所有的规则，我们把规则头的断言h替换为newH。得到的这些规则被称为具有增量式形式（incremental form）。

像算法12.15那样，对应于每个IDB断言p的关系累积了所有的p的事实。在每一轮中，我们

1）应用新的规则对newP断言求值。

2）然后从newP中减去p，保证newP中的事实确实是新的。

3）把这些newP的事实加入到p中。

4）把所有newX关系表设置为空，准备进行下一轮计算。

这个想法将在算法12.18中正式描述。在此之前，我们将先给出一个例子。

例12.17　再次考虑例子12.12中的Datalog程序。该程序的规则的增量形式在图12-17中给出。规则1的规则体中没有IDB子目标，因此除了规则头之外没有任何改变。但是规则2中有两个IDB子目标，因此它变成了两个不同的规则。在每个规则中，path在规则体中的某次出现被替换为newPath。这两个规则合起来保证了上面描述的思想得以实施，即根据规则连接起来的两条路径中至少有一条是在上一轮中发现的。

![603-1](../Images/image05075.jpeg)

图12-17　Datalog程序path的增量式规则

算法12.18　Datalog程序的增量求值。

输入：一个Datalog程序和各个EDB断言的事实集合。

输出：各个IDB断言的事实集合。

方法：对于程序中的每个断言p，令Rp表示使此断言为真的事实的关系。如果p是一个EDB断言，那么Rp就是该断言对应的事实集合。如果p是一个IDB断言，我们将计算得到Rp。另外，对于每个IDB断言p，令RnewP为对应于断言p的“新”事实的关系。

1）把程序的规则修改为上面描述的增量形式。

2）执行图12-18中的算法。

![603-2](../Images/image05076.jpeg)

图12-18　Datalog程序的求值

集合表示法的增量求值

以增量的方式来解决基于集合理论的数据流问题也是可行的。比如，在到达定值问题中，只有当一个定值刚被发现在基本块B的前驱p的OUT［P］中时，这个定值才能够在本次计算中出现在IN［B］中。我们之所以没有尝试以增量的方式来解决这样的数据流问题，因为位向量的实现方式已经非常高效了。一般来说，直接计算整个向量要比决定一个事实是否为新事实更加容易。