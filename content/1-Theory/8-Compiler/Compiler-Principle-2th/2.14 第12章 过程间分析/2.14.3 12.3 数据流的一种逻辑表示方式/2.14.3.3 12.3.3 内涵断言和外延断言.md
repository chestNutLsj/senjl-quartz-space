### 12.3.3　内涵断言和外延断言

按照Datalog程序的惯例，我们把断言分成两类：

1）EDB断言，或者说外延数据库（extensional database）断言，是事先定义的断言。也就是说，它们的真值事实要么通过一个关系或表给出，要么根据断言的含义给出（比如一个比较断言的情况）。

2）IDB断言，或者说内涵数据库（intensional database）断言，只能通过规则定义。

一个断言要么是IDB，要么是EDB，且只能是其中之一。这个规定的结果是，任何出现在一个或多个规则头中的断言必然是一个IDB断言。出现在规则体中的断言可以是IDB，也可以是EDB。比如，在例子12.12中，edge是一个EDB断言，path是一个IDB断言。回忆一下，我们给出了一些关于edge的事实，比如edge（1, 2），但是所有的path事实都是通过规则推导出来的。

当Datalog程序用于表示数据流算法时，其中的EDB断言是根据流图本身计算得到的。IDB断言被表示成规则，而数据流问题的解决方法就是根据这些规则和给定的EDB事实中推导出所有可能的IDB事实。

例12.13　让我们考虑可以如何在Datalog中表示到达定值问题。首先，在语句层次上（而不是在基本块层次上）考虑问题是有道理的。也就是说，从一个基本块构造它的gen和kill集合的计算过程将会和到达定值本身的计算集成在一起。因此，图12-13中给出的基本块b1是很典型的。请注意，如果一个基本块内有n个语句，那么我们用编号1，2，…，n来标记块内的程序点。第i个定值在第i点上出现，而在0点上没有定值出现。

![601-1](../Images/image05071.jpeg)

图12-13　一个语句中包含指针的基本块

程序中的一个点可以表示为一个二元组（b, n），其中b是一个基本块，而n是0到基本块b内的语句数量之间的一个整数。我们的表示方法需要两个EDB断言：

1）def（B, N, X）为真当且仅当基本块B中的第N个语句可以对变量X定值。比如，在图12-13中，def（b1, 1, x）为真，def（b1, 3, x）为真且def（b1, 2, Y）对所有可能在这个点上被指针p指向的变量Y都为真。现在我们将假设Y可以是任何具有p所指类型的变量。

2）succ（B, N, C）为真当且仅当在流图中基本块C是基本块B的后继，且B具有N个语句。也就是说，控制流可以从B的点N到达C的点0。比如，假设b2是图12-13中基本块b1的前驱，且b2具有5个语句，那么succ（b2, 5, b1）为真。

这个Datalog程序有一个IDB断言rd（B, N, C, M, X）。这个断言为真当且仅当在基本块C上的第M个语句中对变量X的定值到达了基本块B的点N。定义断言rd的规则在图12-14中显示。

![601-2](../Images/image05072.jpeg)

图12-14　断言rd的规则集合

规则1说明，如果基本块B的第N个语句对X定值，那么X的这个定值到达B的第N个点（即紧跟在这个语句之后的点）。我们前面给出了到达定值问题的集合理论表示方法，而这个规则对应于该表示方法中的概念gen。

规则2表示除非一个定值被某个语句杀死，否则它可以穿越这个语句。而杀死一个定值的唯一方法是100%肯定地对其中的变量重新定值。详细地说，规则2说明来自基本块C中的第M个语句的对变量X的定值到达基本块B中的点N的条件是

1）它到达了前一个结点，即B中的点N-1。

2）同时至少有一个不同于X的变量Y可能在B的第N个语句中定值。

最后，规则3表示了流图的控制流。它说基本块C中第M个语句中对X的定值到达基本块B的第0点的条件是存在某个具有N个语句的基本块D，使得这个对X的定值到达D的结尾处，并且B是D的一个后继。

例12.13中的EDB断言succ显然可以从流图中获得。如果我们保守地估计一个指针可能指向任何地方，那么可以从流图中得到def断言。如果我们希望把一个指针所指向的范围限定在具有适当类型的变量中，那么我们可以从符号表中获取类型信息，从而使用一个较小的关系def。另一种可选的方法是把def变成一个IDB断言，并通过规则来定义它。这些规则将使用更基本EDB断言，而这些断言本身可以从流图和符号表中获得。

例12.14　假设我们引入两个新的EDB断言：

1）assign（B, N, X）为真当且仅当基本块B的第N个语句的左部为X。请注意，X可以是一个变量，也可以是一个具有左值的简*p。

2）如果X的类型为T，那么type（X, T）为真。同样，X可以是具有左值的任意表达式，而T可以是任何合法的类型表达式。

然后，我们就可以写出def的规则，使得def成为一个IDB断言。图12-15是对图12-14的一个扩展，它增加了两个def的可能规则。规则4说明，如果基本块B的第N个语句对X赋值，那么这个语句就对X定值。规则5说明，如果基本块B的第N个语句对*P赋值，且X是具有P所指类型的任何变量，那么这个语句也可能对X定值。其他类型的赋值语句需要其他的def规则。

![602-1](../Images/image05073.jpeg)

图12-15　断言rd和def的规则

现在举例说明如何使用图12-15中的规则进行推导。让我们重新考虑图12-13中的基本块b1。第一个语句把一个值赋给变量x，因此事实assign（b1, 1, x）出现在EDB中。第三个语句也对x赋值，因此assign（b1, 3, x）也是一个EDB事实。第二个语句通过p间接赋值，因此第三个EDB事实是assign（b1, 2, *p）。规则4允许我们推导出def（b1, 1, x）和def（b1, 3, x）。

假设p的类型是指向整数的指针（*int），且x和y都是整数。那么我们可以使用规则5，令B=b1，N=2，P=p，T=int，且X等于x或y，推导得到def（b1, 2, x）和def（b1, 2, y）。类似地，我们可以对其他类型为整数或可转变为整数的变量推导出同样的结果。