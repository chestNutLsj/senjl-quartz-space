### 12.4.4　在Datalog中的表示方法

现在我们基于上面的讨论把一个控制流无关的指针别名分析正式表示出来。现在忽略过程调用，并将关注四种可能影响指针的语句：

1）对象创建：h：T v=new T();　这个语句创建了一个新的堆对象，并且变量v可以指向它。

2）复制语句：`v=w;`　这里v和w是两个变量。这个语句使得v指向w当前所指的堆对象，即w被复制到v中。

3）字段保存：`v.f=w;`　v所指向的对象类型必须有一个字段f，并且这个字段必须是某一种引用类型。令v指向堆对象h，并令w指向g。这个语句使得h中的字段f现在指向g。请注意，变量v的值没有改变。

4）字段读取：`v=w.f;`　这里w是一个指向某个具有字段f的堆对象的变量，而f指向某个堆对象h。这个语句使得变量v指向h。

请注意，源代码中的复合字段访问，比如`v=w.f.g`，可以被分解为两个基本的字段读取语句：

![608-1](../Images/image05081.jpeg)

现在，我们把这个分析用Datalog规则正式表示出来。首先，只需要计算两个IDB断言：

1）pts（V, H）表示变量V可能指向一个堆对象H。

2）hpts（H, F, G）表示堆对象H的字段F可能指向堆对象G。

EDB关系根据程序本身构造得到。因为在控制流无关的分析中，程序中语句的位置和分析无关，所以只需要在EDB中确定程序中是否存在某种形式的语句。在接下来的内容中，我们将做一个方便的简化。我们没有定义专门的EDB关系来存放从程序中获取的信息，而是使用带引号的语句的方式来指明一个或者多个EDB关系。这些关系表示程序中存在这样的语句。比如，“H:T V=new T()”是一个EDB事实，它表示在语句H中有一个赋值使得变量V指向一个新的类型为T的对象。在实践中，我们假设有一个对应的EDB关系，其中包含的基础原子和程序中这种形式的语句一一对应。

根据这种约定，我们在编写Datalog程序时要做的全部工作就是为上面的四种语句中的每一种写出一个规则。相应的程序在图12-21中给出。规则1说明如果语句H是把一个新对象赋给V的赋值语句，变量V就可能指向堆对象H。规则2说明如果存在一个复制语句`V=W`，并且W可以指向H，那么V也可以指向H。

![609-1](../Images/image05082.jpeg)

图12-21　控制流无关指针分析的Datalog程序

规则3说明，如果存在一个形如`V.F=W`的语句，W可以指向G，并且V可以指向H，那么H的字段F可以指向G。最后，规则4说明，如果存在一个形如`V=W.F`的语句，W可以指向G，并且G的字段F可以指向H，那么V可以指向H。请注意，pts和hpts是相互递归的，但是这个Datalog程序可以用任何一个在12.3.4节中讨论的迭代算法进行求值。