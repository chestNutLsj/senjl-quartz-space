### 12.4.5　使用类型信息

因为Java是类型安全的，变量只能指向和它的声明类型相兼容的类型。比如，把一个属于一个变量的声明类型的超类的对象赋给这个变量将引发一个运行时刻异常。考虑图12-22中的简单例子，其中S是T的子类。如果p为真，这个程序将引发一个运行时刻异常，因为a不能被赋予一个类型为T的对象。这样，因为类型约束的原因，我们可以静态地断定a只能指向h而不能指向g。

![609-2](../Images/image05083.jpeg)

图12-22　具有类型错误的Java程序

因此，我们在分析技术中引入三个EDB断言。这些断言反映了被分析代码中的重要类型信息。我们将使用下面的断言：

1）vType（V, T）表示变量V被声明为类型T。

2）hType（H, T）表示堆对象H在分配时具有类型T。如果一个被创建的对象是由某个核心代码例程返回的，那么有可能不能精确决定它的类型。此时，被创建对象的类型可以被保守地设定为所有可能的类型。

3）assignable（T, S）表示类型为S的对象可以被赋值给一个类型为T的变量。这个信息通常是从程序中子类型的声明中收集的，同时也包含了关于语言中预定义类的信息。assignable（T, T）总是取真值。

我们可以修改图12-21中的规则，使得只有当被赋值变量被赋予的堆对象的类型是可赋值类型时才可以进行推理。新的规则在图12-23中显示。

![609-3](../Images/image05084.jpeg)

图12-23　向控制流无关指针分析增加类型约束

我们首先修改规则2。新规则的最后三个子目标表示我们可以断定V可以指向H的条件是V和堆对象H的类型分别是T和S，并且类型为S的对象可以被赋给指向类型T的变量。规则4中也增加了一个类似的附加约束。请注意，在规则3中没有附加约束，因为所有的保存运算必须通过变量进行，而这些变量的类型已经被检查过了。在其中加入的任何类型约束只能多处理一种情况，即基对象为null常量的情况。