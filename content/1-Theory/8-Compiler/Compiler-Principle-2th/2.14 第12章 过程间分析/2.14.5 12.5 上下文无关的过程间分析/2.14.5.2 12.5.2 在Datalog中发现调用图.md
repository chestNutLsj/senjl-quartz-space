### 12.5.2　在Datalog中发现调用图

为了写出上下文无关的过程间分析的Datalog规则，我们引入三个EDB断言，每个断言都能够从源代码中轻易获得：

1）actual（S, I, V）表示V是调用点S上的第I个实在参数。

2）formal（M, I, V）表示V是方法M中声明的第I个形式参数。

3）cha（T, N, M）表示在一个类型为T的接收对象上调用N时实际调用的方法是M（cha是class hierarchy analysis（类层次结构分析）的缩写）。

调用图的每个边都被表示为一个IDB断言invokes。当我们找到的调用图的边越来越多时，根据参数被传入及返回值被传出的情况，我们会得到越来越多的指针指向关系。这个效果被总结为图12-27中的规则。

![611-2](../Images/image05090.jpeg)

图12-27　发现调用图的Datalog程序

第一个规则计算了调用点的调用目标。也就是说，“S：V.N（...）”表明存在一个标号为S的调用点，它调用了由V指向的接收对象的名为N的方法。这些子目标表示，如果V可以指向实际类型为T的堆对象H，并且M是在调用T类型的对象时所使用的方法，那么调用点S可能调用方法M。

第二个规则说明，如果调用点S可以调用方法M，那么M的每个形式参数都可能指向本次调用中相应的实在参数所指向的任何对象。处理返回值的规则留作练习请读者自行完成。

把这两个规则和12.4节中解释的规则组合起来，我们就建立了一个使用调用图的上下文无关的指针指向分析方法。其中的调用图是在分析的同时动态生成的。这个分析的副作用是使用上下文无关和控制流无关的指针指向分析生成了一个调用图。相对于那个只根据类型声明和语法分析得到的调用图，这个调用图要精确得多。