### 12.2.5　SQL注入

SQL注入是一种黑客攻击方法。黑客可以通过操纵一个Web应用的用户输入，从而获得对数据库的未授权访问。比如，银行可能希望只要它的用户能够提供正确的口令，他就可以在线完成业务处理。这类系统的一个常用体系结构是让用户在一个Web表单中输入字符串，然后把这些字符串组成某个用SQL语言编写的数据库查询的一部分。如果系统开发者不小心，用户提供的字符串可能以不可预料的方式改变这个SQL语句的含义。

例12.10　假设一个银行向它的客户提供了对一个关系

![597-1](../Images/image05064.jpeg)

的访问。也就是说，这个关系是一个由多个三元组组成的表，每个三元组包含一个客户的名字、账户口令和该账户的余额。系统的本意是使得客户只有在提供了他们的名字和正确口令之后才能够看到账户余额。让一个黑客看到账户余额并不是可能发生的最糟糕的事情，但是这个简单例子是更复杂情况的典型代表，更复杂的情况是黑客可以使用那个账户付账。

系统可以按照如下方式实现一次余额查询：

1）用户调用一个Web表单，在表单中输入他们的名字和口令。

2）名字被拷贝到一个变量n，口令被拷贝到另一个变量p。

3）然后，可能在某些其他过程中，执行下列SQL查询：

![597-2](../Images/image05065.jpeg)

我们向不熟悉SQL的读者解释一下这个查询含义。该语句的含义是：“在表`AcctData`中找出一行，要求第一个分量（名字）等于变量n中的当前字符串，而第二个分量（口令）等于变量p中的当前字符串；然后打印这一行的第三个分量（余额）。”请注意，这个SQL语句使用了单引号而不是双引号来分割符号串，n和p之前的冒号表明它们是外围语言的变量。

假设一个黑客想找到Charles Dickens的账户余额，他向n和p提供了下面的值：

![597-3](../Images/image05066.jpeg)

这个奇怪的字符串的作用是把上面的查询转变成

![597-4](../Images/image05067.jpeg)

在很多数据库系统中，--是一个注释引导符号，其作用是把该行中跟在其后的所有内容看作一个注释。结果，现在这个查询语句要求数据库系统打印出每个名字为`′Charles Dickens′`的个人的账户余额，而不考虑在name-password-balance三元组中和该名字一起出现的口令。也就是说，删除注释之后，这个查询变成了：

![597-5](../Images/image05068.jpeg)

在例子12.10中，这个“坏”字符串被保存在两个变量中，它们可能在过程之间传递。但是，在更加真实的情况中，这些字符串可能被多次复制，或者和其他字符串组成完整的查询语句。如果我们不对整个程序进行全面的过程间分析，就不能指望能够检测到导致SQL注入攻击的代码错误。