### 7.4.1　存储管理器

存储管理器总是跟踪堆区中的空闲空间。它具有两个基本的功能：

- 分配。当程序为一个变量或对象请求内存时[^3]，存储管理器产生一段连续的具有被请求大小的堆空间。如果有可能，它使用堆中的空闲空间来满足分配请求；如果没有被请求大小的空间块可供分配，它试图从操作系统中获得连续的虚拟内存来增加堆区的存储空间。如果空间已经用完，存储管理器将空间耗尽的信息传回给应用程序。
- 回收。存储管理器把被回收的空间返还到空闲空间的缓冲池中，这样它可以复用该空间来满足其他的分配请求。存储管理器通常不会将内存返回给操作系统，即使当这个程序不再需要那么多的堆空间时也不会归还给操作系统。

如果下面的（a）、（b）两个条件都成立，内存的管理就会相对简单：（a）所有分配请求都要求相同大小的存储块，（b）存储空间按照可预见的方式被释放，比如先分配先回收。对于有些语言（比如Lisp）而言条件a成立。纯的Lisp语言只使用一种数据元素——一个双指针单元，所有的数据结构都在该元素的基础上构建。条件b在某些情况下也可能成立，最常见的情况是可以在运行时刻栈中分配的数据。然而，对于大部分的语言而言，这两个条件一般都不成立。相反地，我们需要为不同大小的数据元素分配空间，并且没有好方法可以预测所有已分配对象的生命期。

因此，存储管理器必须准备以任何顺序来处理任何大小的空间分配和回收请求。这些请求小到一个字节，大到该程序的整个地址空间。

下面是我们期望存储管理器具有的特性：

- 空间效率。存储管理器应该能够使一个程序所需的堆区空间的总量达到最小。这样做就可以在一个固定大小的虚拟地址空间中运行更大的程序。空间效率是通过使存储碎片达到最少而得到的，该技术将在7.4.4节中讨论。
- 程序效率。存储管理器应该充分利用存储子系统，使程序可以运行得更快。我们将在7.4.2节中看到，根据数据对象在存储中所处的不同位置，执行一条指令所花费的时间可能相差很大。幸运的是，程序通常会表现出“局部性”，7.4.3节将讨论这种现象，它指的是通常的程序在访问内存时具有的非随机性聚集的特性。通过关注对象在存储中的放置方法，存储管理器可以更好地利用空间，并且有希望使程序运行得更快。
- 低开销。因为存储分配和回收在很多程序中是常用的操作，因此使得这些操作尽可能地高效是非常重要的。也就是说，我们希望最小化开销（overhead），即花费在分配和回收上的执行时间在总运行时间中所占的比例。请注意，分配的开销由小型请求决定，管理大型对象的开销相对不重要，因为通常会在它上面执行大量的计算，这个开销被分摊了。