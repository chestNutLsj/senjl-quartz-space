### 7.4.2　一台计算机的存储层次结构

存储管理和编译器优化必须在充分了解存储行为的基础上完成。现代机器的设计使得程序员不需要考虑内存子系统的细节就能够写出正确的程序。然而，程序的效率不仅取决于被执行的指令的数量，还取决于执行其中每条指令所花费的时间。不同情况下执行一条指令所花费的时间可能会有明显的不同，因为访问不同的存储区域所花费的时间从几纳秒到几毫秒不等。因此，数据密集型程序可以从能够充分利用存储子系统的优化技术中得到很大的好处。我们将在7.4.3节看到，这种优化可以利用程序的“局部性”现象，即一般程序的非随机行为。

内存访问时间上的巨大差异源于硬件技术的根本性局限。我们可以制造出一个小而快的存储器件或者大而慢的存储器件，但是无法制造出既大又快的存储器件。现在，制造一个具有纳秒级访问时间的千兆容量的存储器件仍然是不可能的，而纳秒级正是高性能处理器的运行速度。因此，在实践中，现代计算机都以存储层次结构（memory hierarchy）的方式安排它们的存储。如图7-16所示的一个存储层次结构由一系列存储元素组成，较小较快的元素“更加接近”处理器，较大但较慢的元素则离存储器比较远。

![308-1](../Images/image04489.jpeg)

图7-16　典型的内存层次结构的配置

一个处理器通常具有少量寄存器，寄存器中的内容由软件控制。然后，它具有一层或多层高速缓存，这些高速缓存通常使用静态RAM制造，其大小从几千字节到几兆字节不等。层次结构中的下一层是物理（主）内存，它由数百兆到几千兆的动态RAM构成。物理内存由下一层的虚拟内存提供支持，虚拟内存由几千兆字节的磁盘实现。在一次内存访问中，机器首先在最近（最底层的）的存储中寻找数据，如果数据不在那里则到上一层中寻找，以此类推。

寄存器个数很少，因此寄存器的使用会根据特定应用进行裁剪，并由编译器生成的代码进行管理。存储层次结构中的所有其他层都是自动管理的。这样做不仅简化了编程任务，并且相同的程序可以在具有不同存储配置的机器上高效工作。对于每次存储访问，机器从最低层开始逐层搜索每一层存储，直到找到数据为止。高速缓存是完全通过硬件进行管理的，这么做是为了能够跟上相对较快的RAM访问时间。因为磁盘访问速度相对较慢，虚拟内存是由操作系统进行管理的，辅以一个称为“转换旁视缓冲”的硬件结构。

数据以连续存储块的方式进行传输。为了分摊访问的开销，内存层次结构中较慢的层次通常使用较大的块。在主存和高速缓存之间的数据是按照被称为高速缓存线（cache line）的块进行传输的，高速缓存线的长度通常在32～256字节之间。在虚拟内存（硬盘）和主内存之间的数据是以被称为“页”（page）的内存块进行传输的，页的大小通常在4～64KB之间。