### 8.5.2　寻找局部公共子表达式

检测公共子表达式的方法是这样的。当一个新的结点M将被加入到DAG中时，我们检查是否存在一个结点N，它和M具有同样的运算符和子结点，且子结点顺序相同。如果存在这样的结点，N计算的值和M计算的值是一样的，因此可以用N替换M。在6.1.1节中，这个技术被称为检测公共子表达式的“值编码”方法。

例8.10　下面的基本块的DAG见图8-12。

![358-2](../Images/image04555.jpeg)

图8-12　例8.10中的基本块的DAG

![358-1](../Images/image04556.jpeg)

当我们为第三个语句`c=b+c`构造结点的时候，我们知道`b+c`中`b`的使用指向图8-12中标号为-的结点。因为这个结点是`b`的最近的定值。因此，我们不会把语句1和语句3所计算的值混淆。

然而，对应于第四个语句`d=a-d`的结点的运算符是-，且它的子结点是标记有变量`a`和`d0`的结点。因为运算符和子结点都和语句2对应的结点相同，我们不需要创建这个结点，而是把`d`加到这个标记为-的结点的定值变量表中。

因为在图8-12的DAG中只有三个非叶子结点，看起来例8.10中的基本块可以替换为一个只有三个语句的基本块。实际上，假如`b`在这个基本块的出口点不活跃，我们不需要计算变量`b`，可以使用`d`来存放图8-12中标号为-的结点所代表的值。这个基本块就变成了：

![359-4](../Images/image04557.jpeg)

但是，如果`b`和`d`都在出口处活跃，我们就必须使用第四个语句把值从一个变量复制到另一个。[^2]

例8.11　当我们寻找公共子表达式的时候，我们实际上是寻找不管如何计算一定能得到相同结果值的表达式。因此，DAG方法不能看到下面的事实，即下面的语句序列

![359-2](../Images/image04558.jpeg)

中，第一和第四个语句实际上计算的是同一个表达式的值，即`b0+c0`。也就是说，虽然`b`和`c`在第一个和第四个语句之间改变了，但它们的和仍保持不变，因为b+c=（b-d）+（c+d）。这个序列的DAG见图8-13。它没有显示出任何公共子表达式。但是，如8.5.4节中将要讨论的，在DAG中应用代数恒等式可以揭示出这样的等值关系。

![359-1](../Images/image04559.jpeg)

图8-13　例8.11中的基本块的DAG