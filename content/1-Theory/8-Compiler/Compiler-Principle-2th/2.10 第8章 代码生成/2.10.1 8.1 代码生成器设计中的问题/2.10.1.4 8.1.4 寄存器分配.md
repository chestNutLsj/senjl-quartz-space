### 8.1.4　寄存器分配

代码生成的关键问题之一是决定哪个值放在哪个寄存器里面。寄存器是目标机上运行速度最快的计算单元，但是我们通常没有足够的寄存器来存放所有的值。没有存放在寄存器中的值必须存放在内存中。使用寄存器运算分量的指令总是要比那些运算分量在内存中的指令短并且快。因此，有效利用寄存器非常重要。

寄存器的使用经常被分解为两个子问题：

1）寄存器分配：对于源程序中的每个点，我们选择一组将被存放在寄存器中的变量。

2）寄存器指派：我们指定一个变量被存放在哪个寄存器中。

即使对于单寄存器机器，找到一个从寄存器到变量的最优指派也是很困难的。从数学上讲，这个问题是NP完全的。而且，目标机的硬件和/或操作系统可能要求代码遵守特定的寄存器使用规则，从而使这个问题变得更加复杂。

例8.1　有些机器要求为某些运算分量和结果使用寄存器对（即一个偶数号寄存器和相邻的奇数号寄存器）。比如，在某些机器上，整数乘法和整数除法就涉及寄存器对。乘法指令的形式如下：

![344-2](../Images/image04511.jpeg)

其中被乘数`x`是偶数/奇数寄存器对中的奇数号寄存器，而乘数`y`则可以存放在任意位置。乘法结果占据了整个偶数/奇数寄存器对。除法指令的形式如下：

![344-3](../Images/image04512.jpeg)

其中，被除数占据了整个偶数/奇数寄存器对，`x`是其中的偶数号寄存器；而除数是`y`。相除之后，偶数号寄存器保存余数，而奇数号寄存器保存商。

现在，考虑图8-2中的两个三地址代码序列。图8-2a和图8-2b之间的唯一差别是第二个语句的运算符。图8-2a和图8-2b对应的最短汇编代码序列如图8-3所示。

![344-4](../Images/image04513.jpeg)

图8-2　两个三地址代码序列

![344-5](../Images/image04514.jpeg)

图8-3　最优机器代码序列

`R`i表示第i号寄存器。`SRDA`表示双算术右移（Shift-Right-Double-Arithmetic），而`SRDA R0 32`把被除数从`R0`中移入`R1`并把`R0`清空，使得所有位都等于被除数的正负号位。`L`，`ST`和`A`分别表示加载、保存和相加。需要注意的是，把`a`加载到哪个寄存器的最优选择依赖于最终会对`t`做什么样的运算。

寄存器的分配和指派的策略将在8.8节讨论。8.10节将给出对某些类型的机器，我们可以构造出使用最少的寄存器来完成表达式求值的代码序列。