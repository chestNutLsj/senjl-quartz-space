### 4.9.1　语法分析器生成工具Yacc

按照图4-57中演示的方法就可以使用Yacc来构造一个翻译器。首先要准备好一个文件，比如translate.y，文件中包含了对将要构造的翻译器的规约。UNIX系统命令

![198-1](../Images/image04272.jpeg)

![198-2](../Images/image04273.jpeg)

图4-57　用Yacc创建一个输入/输出翻译器

使用算法4.63中给出的LALR方法将文件translate.y转换成为一个名为y.tab.c的C程序。程序y.tab.c是一个用C语言编写的LALR语法分析器，另外还包括由用户准备的C语言例程。其中的LALR分析表是按照4.7节中描述的方法压缩的。使用命令

![198-3](../Images/image04274.jpeg)

⊖ 函数库的名字ly和具体系统相关。

对y.tab.c进行编译，并和包含LR语法分析程序的库ly连接，我们就得到了想要的目标程序a.out。这个程序执行了由最初的Yacc程序translate.y所描述的翻译工作。如果需要其他过程，它们可以和其他的C程序一样，和y.tab.c一起编译并加载。

一个Yacc源程序由三个部分组成：

![198-4](../Images/image04275.jpeg)

例4.69　为了说明如何编写一个Yacc源程序，我们构造一个简单的桌上计算器。该计算器读入一个算术表达式，对表达式求值，然后打印出表达式的结果。我们将从下面的算术表达式文法开始构造这个桌上计算器：

E→E + T | T

T→T * F | F

F→（E）| digit

其中的词法单元digit是一个0～9之间的数字。根据这个文法得到的Yacc桌上计算器程序显示在图4-58中。

声明部分

一个Yacc程序的声明部分分为两节，它们都是可选的。在第一节中放置通常的C声明，这个声明用%{和}%括起来。那些由第二和第三部分中的翻译规则及过程使用的临时变量都在这里声明。在图4-58中，这一节只包含include语句

![199-1](../Images/image04276.jpeg)

这个语句使得C语言的预处理器将标准头文件<ctype.h>包含进来，这个头文件中包含了断言`isdigit`。

在声明部分中还包括对词法单元的声明。在图4-58中，语句

![199-2](../Images/image04277.jpeg)

声明`DIGIT`是一个词法单元。在这一节中声明的词法单元可以在Yacc规约的第二和第三部分中使用。如果向Yacc语法分析器传送词法单元的词法分析器是使用Lex创建的，那么如3.5.2节中讨论的，Lex生成的词法分析器也可以使用这里声明的词法单元。

![199-3](../Images/image04278.jpeg)

图4-58　一个简单的桌上计算器的Yacc规约

翻译规则部分

我们将翻译规则放置在Yacc规约中第一个%%对之后的部分。每个规则由一个文法产生式和一个相关联的语义动作组成。我们前面写作

<产生式头>→<产生式体>1 | <产生式体>2 | … | <产生式体>n

的一组产生式在Yacc中被写成：

![199-4](../Images/image04279.jpeg)

在一个Yacc产生式中，如果一个由字母和数位组成的字符串没有加引号且未被声明为词法单元，它就会被当作非终结符号处理。带引号的单个字符，比如‘`c`’，会被当作终结符号`c`以及它所代表的词法单元所对应的整数编码（即`Lex`将把‘`c`’的字符编码当作整数返回给语法分析器）。不同的产生式体用竖线分开，每个产生式头以及它的可选产生式体及语义动作之后跟一个分号。第一个产生式的头符号被看作开始符号。

一个Yacc语义动作是一个C语句的序列。在一个语义动作中，符号$$表示和相应产生式头的非终结符号关联的属性值，而$i表示和相应产生式体中第i个文法符号（终结符号或非终结符号）关联的属性值。当我们按照一个产生式进行归约时就会执行和该产生式相关联的语义动作，因此语义动作通常根据$i的值来计算$$的值。在上面的Yacc规范中，我们将两个E产生式

E→E + T | T

和它们的相关语义动作写作：

![200-1](../Images/image04280.jpeg)

请注意，第一个产生式中的非终结符号`term`是该产生式体中的第三个文法符号，而+是第二个文法符号。与第一个产生式关联的语义动作将产生式体中的`expr`和`term`的值相加，并把结果赋给产生式头上的非终结符号`expr`。我们省略了第二个产生式的语义动作，因为对于体中只包含一个文法符号的产生式，默认的语义动作就是拷贝属性值。总的来说，默认动作是`{$$=$1；}`。

请注意，我们向这个Yacc规范中加入了一个新的开始符号产生式

![200-2](../Images/image04281.jpeg)

这个产生式说明桌面计算器的输入是一个跟着换行符的表达式。和这个产生式相关的语义动作打印出了输入表达式的十进制取值和一个换行符。

辅助性C语言例程部分

一个Yacc规约的第三部分由辅助性C语言例程组成。这里必须提供一个名为`yylex()`的词法分析器。用Lex来生成`yylex()`是一个常用的选择，见4.9.3节。在需要时可以添加错误恢复例程这样的过程。

词法分析器`yylex()`返回一个由词法单元名和相关属性值组成的词法单元。如果要返回一个词法单元名字，比如DIGIT，那么这个名字必须先在Yacc规约的第一部分进行声明。一个词法单元的相关属性值通过一个Yacc定义的变量`yylval`传送给语法分析器。

图4-58中的词法分析器是非常原始的。它使用C函数`getchar()`逐个读入字符。如果字符是一个数位，这个数位的值就存放在变量`yylval`中，返回词法单元的名字DIGIT。否则，字符本身被当作词法单元名返回。