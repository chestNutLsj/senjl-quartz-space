### 4.9.2　使用带有二义性文法的Yacc规约

现在让我们修改这个Yacc规约，使得这个桌面计算器更加有用。首先，我们将允许桌面计算器对一个表达式序列进行求值，其中每个表达式占一行。我们还将允许表达式之间出现空行。我们将第一个规则修改为：

![200-3](../Images/image04282.jpeg)

在Yacc中，像第三行那样的空白产生式表示∈。

其次，我们将扩展表达式的种类，使得它的语言可以包含数字，而不是单个数位，并且包含算术运算符+、-（包括双目和单目）、*和/。描述这类表达式的最容易的方式是使用下面的二义性文法：

E→E + E | E - E | E * E | E / E | - E |（E）| number

得到的Yacc规约如图4-59所示。

![201-1](../Images/image04283.jpeg)

图4-59　一个更加先进的桌上计算器的Yacc规约

因为图4-59中Yacc规约的文法是二义性的，LALR算法将会出现语法分析动作冲突。Yacc会报告产生的语法分析动作冲突的数量。使用`-v`选项调用Yacc可以得到关于项集和语法分析动作冲突的描述。这个选项会产生一个附加的文件`y.output`，它包含文法的项集的内核，对LALR算法产生的语法分析动作冲突的描述，以及LR语法分析表的一个可读表示形式。这个可读表示形式显示了Yacc是如何解决这些语法分析动作冲突的。只要Yacc报告发现了语法分析动作冲突，那么最好创建并查阅`y.output`文件，了解为什么会产生这些语法分析动作冲突，并检查Yacc是否已经正确解决了它们。

除非另行指定，否则Yacc会使用下面的两个规则来解决所有的语法分析动作冲突：

1）解决一个归约/归约冲突时，选择在Yacc规约中列在前面的那个冲突产生式。

2）解决移入/归约冲突时总是选择移入。这个规则正确地解决了因为悬空else二义性而产生的移入/归约冲突。

因为这些默认规则不可能总是编译器作者需要的，所以Yacc提供了一个通用的机制来解决移入/归约冲突。在声明部分，我们可以给终结符号赋予优先级和结合性。声明

![201-2](../Images/image04284.jpeg)

使得+和-具有相同的优先级，并且都是左结合的。我们可以把一个运算符声明为右结合的，比如：

![202-1](../Images/image04285.jpeg)

我们可以声明一个运算符是非结合性的二目运算符（即这个运算符的两次出现不能合并到一起），方法如下：

![202-2](../Images/image04286.jpeg)

词法单元的优先级是根据它们在声明部分的出现顺序而定的。优先级最低的词法单元最先出现。同一个声明中的词法单元具有相同的优先级。因此，图4-59中的声明

![202-3](../Images/image04287.jpeg)

赋予词法单元UMINUS的优先级要高于前面五个终结符号的优先级。

除了给各个终结符号赋予优先级，Yacc也可以给和某个冲突相关的各个产生式赋予优先级和结合性，来解决移入/归约冲突。如果它必须在移入一个输入符号a和按照A→α进行归约之间进行选择，那么当这个产生式的优先级高于a的优先级时，或者当两者的优先级相同但产生式是左结合的时，Yacc就选择归约；否则就选择移入动作。

通常，一个产生式的优先级被设定为它的最右终结符号的优先级。在大多数情况下，这是一个明智的选择。比如，给定产生式

E→ E + E | E * E

我们将在向前看符号为+时按照E→E + E进行归约，因为产生式体中的+和这个向前看符号具有相同的优先级，且它是左结合的。在向前看符号为*时，我们将选择移入，因为这个向前看符号的优先级高于产生式体中+的优先级。

在那些最右终结符号不能为产生式提供正确优先级的情况下，我们可以在产生式后增加一个标记

![202-4](../Images/image04288.jpeg)

来指明该产生式的优先级。此时这个产生式的优先级和结合性将和这个终结符号相同，而这个终结符号的优先级和结合性应该在声明部分定义。Yacc不会报告那些已经使用这个优先级/结合性机制解决了的移入/归约冲突。

这里的“终结符号”可以仅仅作为一个占位符，就像图4-59中的`UMINUS`那样。这个终结符号不会被词法分析器返回，声明它的目的仅仅是为了定义一个产生式的优先级。在图4-59中，声明

![202-8](../Images/image04289.jpeg)

赋予词法单元UMINUS一个高于*和/的优先级。在翻译规则部分，产生式

![202-5](../Images/image04290.jpeg)

后面的标记

![202-6](../Images/image04291.jpeg)

使得这个产生式中的单目减运算符具有比其他运算符更高的优先级。