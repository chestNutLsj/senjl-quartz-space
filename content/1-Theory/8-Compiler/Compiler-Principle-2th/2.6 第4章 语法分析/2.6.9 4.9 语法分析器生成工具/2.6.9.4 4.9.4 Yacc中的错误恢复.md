### 4.9.4　Yacc中的错误恢复

Yacc的错误恢复使用了错误产生式的形式。首先，用户定义了哪些“主要”非终结符号将具有相关的错误恢复动作。通常的选择是非终结符号的某个子集，包括那些用于生成表达式、语句、块和函数的非终结符号。然后，用户在文法中加入形如A→error α的错误产生式，其中A是一个主要非终结符号，α是一个可能为空的文法符号串；error是Yacc的一个保留字。Yacc把这样的错误产生式当作普通产生式，根据这个规约生成一个语法分析器。

然而，当Yacc生成的语法分析器碰到一个错误时，它就以一种特殊的方法来处理那些对应项集包含错误产生式的状态。当碰到一个错误时，Yacc就会从它的栈中不断弹出符号，直到它碰到一个满足如下条件的状态：该状态对应的项集包含一个形如A→·error α的项。然后语法分析器就好像在输入中看到了error，将虚构的词法单元error移入栈中。

当α为∈时，语法分析器立刻就执行一次归约到A的动作，并调用和产生式A→error相关的语义动作（这可能是一个用户定义的错误恢复例程）。然后语法分析器抛弃一些输入符号，直到它找到某个使它可以继续进行正常的语法分析的符号为止。

如果α不为空，Yacc将向前跳过一些输入符号，寻找可以被归约为α的子串。如果α全部由终结符号组成，那么它就在输入中寻找这个终结符号串，并将它们移入到栈中进行“归约”。此时，语法分析器栈的顶部是error α。然后语法分析器将把error α归约为A，并继续进行正常的语法分析。

比如，一个形如

stmt→ error；

的错误产生式规定语法分析器在碰到一个错误的时候要跳到下一个分号之后，并假装已经找到了一个语句。这个错误产生式的语义例程不需要处理输入，而是可以直接生成诊断消息并做出一些处理，比如设置一个标志来禁止生成目标代码。

例4.70　图4-61在图4-59所示的Yacc桌上计算器中增加了错误产生式

![203-3](../Images/image04295.jpeg)

这个错误产生式使得这个桌上计算器在输入中发现一个语法错误时停止正常的语法分析工作。当碰到错误时，桌上计算器的语法分析器开始从它的栈中弹出符号，直到它在栈中发现一个在输入为error时执行移入动作的状态。状态0就是这样的一个状态（在这个例子里面，它是唯一一个这样的状态），因为它的项包括了

`lines→·error′\n′`

同时，状态0总是在栈的底部。语法分析器将词法单元error移入栈中，然后向前跳过输入符号，直到它发现一个换行符为止。此时，语法分析器将换行符移入到栈中，将error`′\n′`归约为lines，并发出诊断消息“请重新输入前一行”。专门的Yacc例程`yyerrok`将语法分析器的状态重新设置为正常操作模式。

![204-1](../Images/image04296.jpeg)