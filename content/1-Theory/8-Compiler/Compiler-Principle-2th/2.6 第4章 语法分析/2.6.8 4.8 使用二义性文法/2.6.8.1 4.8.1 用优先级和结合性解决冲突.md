### 4.8.1　用优先级和结合性解决冲突

考虑带有运算符+和*的有二义性的表达式文法（4.3）。为方便起见，这里再次给出此文法：

E→E + E | E * E |（E）| id

这个文法是二义性的，因为它没有指明运算符+和*的优先级和结合性。无二义性的文法（4.1）（包含产生式E→E + T和T→T * F）生成同样的语言，但是指定+的优先级低于*，并且两个运算符都是左结合的。出于两个原因，我们愿意使用这个二义性文法。第一，我们将会看到的，可以很容易地改变运算符+和*的优先级和结合性，既不需要修改文法（4.3）的产生式，也不需要改变相应语法分析器的状态数目。第二，相应无二义性文法的语法分析器将把部分时间用于归约产生式E→T和T→F。这两个产生式的功能就是保证结合性和优先级。二义性文法（4.3）的语法分析器不会把时间浪费在对这些单产生式（即产生式体中只包含一个非终结符号的产生式）的归约上。

使用E′→E增广之后的二义性表达式文法（4.3）的LR（0）项集显示在图4-48中。因为文法（4.3）是二义性的，在我们试图用这些项集生成一个LR语法分析表时会出现分析动作冲突。对应于项集I7和I8的两个状态就产生了这样的冲突。假设我们使用SLR方法来构造语法分析动作表。I7在输入+或*上产生了冲突，不能确定应该按照E→E+E归约还是应该移入。这个冲突无法解决，因为+和*都在FOLLOW（E）中。因此在输入为*或+时，这两种动作都被要求执行。I8也产生了类似的冲突，即在输入为+或*时，不能确定应该按照E→E*E归约还是应该移入。实际上，任意一种LR语法分析表构造方法都会产生这样的冲突。

![193-1](../Images/image04261.jpeg)

图4-48　一个增广表达式文法的LR（0）项集

然而，这些问题可以使用+和*的优先级和结合性信息来解决。考虑输入id + id * id。它使得基于图4-48的语法分析器在处理完id+id之后进入状态7。更明确地说，语法分析器进入如下的格局：

![194-1](../Images/image04262.jpeg)

为方便起见，我们同时将对应于状态1、4和7的符号显示在“前缀”列中。

如果*的优先级高于+，我们知道语法分析器应该将*移入栈中，准备将这个*和它两边的id符号归约为一个表达式。图4-37显示了根据等价的无二义性文法得到的SLR语法分析器。这个分析器也做出同样的选择。另一方面，如果+的优先级高于*，我们知道语法分析器应该将E+E归约为E。因此，+和*之间的相对优先关系可以被用于解决状态7上的冲突，确定在输入*上应该按照E→E+E归约还是应该移入。

假如输入是id + id +id，语法分析器在处理了输入id +id之后，仍然能获得栈内容为0 1 4 7的格局。在输入为+时，状态7中仍然有一个移入/归约冲突。然而，现在运算符+的结合性可以决定如何解决这个冲突。如果+是左结合的，正确的动作是按照E→E+E进行归约。也就是说，第一个+号两边的id必须被分在一组。这个选择仍然和相应无二义性文法的SLR语法分析器的做法一致。

概括地讲，假设+是左结合的，状态7在输入+时的动作应该是按照E→E+E进行归约。假设*的优先级高于+，状态7在输入*上的动作应该是移入。类似地，假设*是左结合的，并且它的优先级高于+。因为只有当栈中最上端的三个符号是E*E时，状态8才能出现在栈顶。我们可以认为状态8在输入*和+上的动作都是按照E→E*E归约。对于输入为+的情况，理由是*的优先级高于+；而对于输入为*的情况，理由是*是左结合的。

![194-2](../Images/image04263.jpeg)

图4-49　文法（4.3）的语法分析表

按照这个方式进行处理，我们可以得到图4-49所示的LR语法分析表。产生式1～4分别是E→E+E、E→E*E、E→（E）和E→id。很有意思的是，如果从图4-37所示的无二义性表达式文法（4.1）的SLR分析表中删除单产生式E→T和T→F的归约动作，我们可以得到一个相似的语法动作表。在使用LALR和规范LR语法分析技术时，我们也可以使用类似的方法来处理这种二义性文法。