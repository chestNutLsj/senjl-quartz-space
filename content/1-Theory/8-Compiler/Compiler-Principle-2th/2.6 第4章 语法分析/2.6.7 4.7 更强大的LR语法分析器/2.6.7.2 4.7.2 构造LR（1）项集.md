### 4.7.2　构造LR（1）项集

构造有效LR（1）项集族的方法实质上和构造规范LR（0）项集族的方法相同。我们只需要修改两个过程：CLOSURE和GOTO。

为了理解CLOSURE操作的新定义，特别是理解为什么b必须在FIRST（βa）中，我们考虑对某些可行前缀γ有效的项集合中的一个形如［A→α·Bβ，a］的项，那么必然存在一个最右推导![181-5](../Images/image04240.jpeg)，其中γ=δα。假设βax推导出终结符号串by，那么对于某个形如B→η的产生式，我们有推导![181-6](../Images/image04241.jpeg)。因此，［B→·η，b］是γ的有效项。请注意，b可能是从β推导得到的第一个终结符号，也可能在![182-1](../Images/image04242.jpeg)的推导过程中β推导出了∈，因此b也可能是a。总结这两种情况，我们说b可以是FIRST（βax）中的任意终结符号，其中FIRST是在4.4节中定义的函数。请注意，x不可能包含by的第一个终结符号，因此FIRST（βax）=FIRST（βa）。现在我们给出LR（1）项集的构造方法。

算法4.53　LR（1）项集族的构造方法。

输入：一个增广文法G′。

输出：LR（1）项集族，其中的每个项集对文法G′的一个或多个可行前缀有效。

方法：过程CLOSURE和GOTO，以及用于构造项集的主例程items见图4-40。

![182-2](../Images/image04243.jpeg)

图4-40　为文法G′构造LR（1）项集族的算法

例4.54　考虑下面的增广文法：

S′→S

S→C C　（4.55）

C→c C | d

我们首先计算{［S′→·S，$］}的闭包。在求闭包时，我们将项［S′→·S，$］和过程CLOSURE中的项［A→α·Bβ，a］相匹配。也就是说，A=S′，α=∈，B=S，β=∈和a=$。函数CLOSURE告诉我们，对于每个产生式B→γ和FIRST（βa）中的终结符号b，将项［B→·γ，b］加入到闭包中。对于当前的文法，B→γ就是S→CC，并且因为β是∈且a是$，b只能是$。因此，我们增加［S→·CC，$］。

我们继续计算闭包，对于在FIRST（C$）中的b，加入所有的项［C→·γ，b］。也就是说，将［S→·CC，$］和［A→α·Bβ，a］相匹配，我们有A=S，α=∈，B=C，β=C且a=$。因为C不会推导出空串，所以FIRST（C$）=FIRST（C）。因为FIRST（C）包含终结符号c和d，所以我们加入项［C→·cC，c］、［C→·cC，d］、［C→·d，c］和［C→·d，d］。在这些项中，紧靠在点右边的都不是非终结符号，因此我们已经完成了第一个LR（1）项集。这个初始项集是：

I0：S′→·S，$

S→·CC，$

C→·cC，c/d

C→·d，c/d

为表示方便，我们省略了方括号，并且使用［C→·cC，c/d］作为两个项［C→·cC，c］和［C→·cC，d］的缩写。

现在我们对不同的X值计算GOTO（I0，X）。对于X=S，我们必须求［S′→S·，$］的闭包。因为点在最右端，所以无法加入新的项。因此我们得到下一个项集

I1：S′→S·，$

对于X=C，我们求［S→C·C，$］闭包。我们以$作为第二个分量加入C产生式，之后不能再加入新的项，得到：

I2：S→C·C，$

C→·cC，$

C→·d，$

接下来，令X=c。我们必须求{［C→c·C，c/d］}的闭包。我们将c/d作为第二个分量加入C产生式，得到：

I3：C→c·C，c/d

C→·cC，c/d

C→·d，c/d

最后，令X=d，我们得到项集：

I4：C→d·，c/d

我们已经完成了I0上的GOTO函数。我们没有从I1得到新的项集，但是I2有相对于C、c和d的GOTO后继。对于GOTO（I2，C），我们有

I5：S→CC·，$

它不需要进行闭包运算。为了计算GOTO（I2，c），我们对{［C→c·C，$］}求闭包，得到

I6：C→c·C，$

C→·cC，$

C→·d，$

请注意，I6和I3只在第二个分量上有所不同。我们会经常看到一个文法的多个LR（1）项集具有相同的第一分量，但第二分量不同。当我们为同一个文法构造规范LR（0）项集族时，每一个LR（0）项集将和一个或多个LR（1）项集的第一分量集合完全一致。我们将在讨论LALR语法分析技术的时候更加深入地讨论这个现象。

继续计算I2的GOTO函数，GOTO（I2，d）就是

I7：C→d·，$

现在转而处理I3，I3在c和d上的GOTO值分别是I3和I4。GOTO（I3，C）是

I8：C→cC·，c/d

I4和I5没有GOTO值，因为它们的项中的点都在最右端。I6在c和d上的GOTO值分别是I6和I7，而GOTO（I6，C）是

I9：C→cC·，$

其余的各个项集都没有GOTO值，因此我们完成了所有项集的计算。图4-41显示了这10个项集和它们之间的goto关系。

![184-1](../Images/image04244.jpeg)

图4-41　文法（4.55）的GOTO图