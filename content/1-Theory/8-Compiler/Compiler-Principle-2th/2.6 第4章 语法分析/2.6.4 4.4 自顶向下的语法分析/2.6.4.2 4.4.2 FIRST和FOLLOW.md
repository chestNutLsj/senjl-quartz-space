### 4.4.2　FIRST和FOLLOW

自顶向下和自底向上语法分析器的构造可以使用和文法G相关的两个函数FIRST和FOLLOW来实现。在自顶向下语法分析过程中，FIRST和FOLLOW使得我们可以根据下一个输入符号来选择应用哪个产生式。在恐慌模式的错误恢复中，由FOLLOW产生的词法单元集合可以作为同步词法单元。

FIRST（α）被定义为可从α推导得到的串的首符号的集合，其中α是任意的文法符号串。如果![155-1](../Images/image04180.jpeg)∈，那么∈也在FIRST（α）中。比如在图4-15中，![155-2](../Images/image04181.jpeg)，因此c在FIRST（A）中。

![155-3](../Images/image04182.jpeg)

图4-15　终结符号c在FIRST（A）中且a在FOLLOW（A）中

我们先简单介绍一下如何在预测分析中使用FIRST。考虑两个A产生式A→α | β，其中FIRST（α）和FIRST（β）是不相交的集合。那么我们只需要查看下一个输入符号a，就可以在这两个A产生式中进行选择。因为a只能出现在FIRST（α）或FIRST（β）中，但不能同时出现在两个集合中。比如，如果a在FIRST（β）中，就选择A→β。在4.4.3中定义LL（1）文法时将深入研究这个思想。

对于非终结符号A，FOLLOW（A）被定义为可能在某些句型中紧跟在A右边的终结符号的集合。也就是说，如果存在如图4-15所示形如![155-4](../Images/image04183.jpeg)的推导，终结符号a就在FOLLOW（A）中，其中α和β是文法符号串。请注意，在这个推导的某个阶段，A和a之间可能存在一些文法符号。但如果这样，这些符号会推导得到∈并消失。另外，如果A是某些句型的最右符号，那么$也在FOLLOW（A）中。回忆一下，$是一个特殊的“结束标记”符号，我们假设它不是任何文法的符号。

计算各个文法符号X的FIRST（X）时，不断应用下列规则，直到再没有新的终结符号或∈可以被加入到任何FIRST集合中为止。

1）如果X是一个终结符号，那么FIRST（X）= X。

2）如果X是一个非终结符号，且X→Y1Y2…Yk是一个产生式，其中k≥1，那么如果对于某个i，a在FIRST（Yi）中且∈在所有的FIRST（Y1）、FIRST（Y2）、…、FIRST（Yi-1）中，就把a加入到FIRST（X）中。也就是说，![155-5](../Images/image04184.jpeg)。如果对于所有的j=1，2，…，k，∈在FIRST（Yj）中，那么将∈加入到FIRST（X）中。比如，FIRST（Y1）中的所有符号一定在FIRST（X）中。如果Y1不能推导出∈，那么我们就不会再向FIRST（X）中加入任何符号，但是如果![155-6](../Images/image04185.jpeg)，那么我们就加上FIRST（Y2），依此类推。

3）如果X→∈是一个产生式，那么将∈加入到FIRST（X）中。

现在，我们可以按照如下方式计算任何串X1X2…Xn的FIRST集合。向FIRST（X1X2…Xn）加入F（X1）中所有的非∈符号。如果∈在FIRST（X1）中，再加入FIRST（X2）中的所有非∈符号；如果∈在FIRST（X1）和FIRST（X2）中，加入FIRST（X3）中的所有非∈符号，依此类推。最后，如果对所有的i，∈都在FIRST（Xi）中，那么将∈加入到FIRST（X1X2…Xn）中。

计算所有非终结符号A的FOLLOW（A）集合时，不断应用下面的规则，直到再没有新的终结符号可以被加入到任意FOLLOW集合中为止。

1）将$放到FOLLOW（S）中，其中S是开始符号，而$是输入右端的结束标记。

2）如果存在一个产生式A→αBβ，那么FIRST（β）中除∈之外的所有符号都在FOLLOW（B）中。

3）如果存在一个产生式A→αB，或存在产生式A→αBβ且FIRST（β）包含∈，那么FOLLOW（A）中的所有符号都在FOLLOW（B）中。

例4.30　再次考虑非左递归的文法（4.28）。那么：

1）FIRST（F）=FIRST（T）=FIRST（E）={（，id}。要知道为什么，请注意F的两个产生式的体以终结符号id和左括号开头。T只有一个产生式，而该产生式的体以F开头。又因为F不能推导出∈，所以FIRST（T）必然和FIRST（F）相同。对于FIRST（E）也可以做同样的论证。

2）FIRST（E′）={+，∈}。理由是E′的两个产生式中，一个产生式的体以终结符号+开头，且另一个产生式的体为∈。只要一个非终结符号推导出∈，我们就会把∈放到该终结符号的FIRST集合中。

3）FIRST（T′）={*，∈}。它的论证过程和FIRST（E′）的论证过程类似。

4）FOLLOW（E）= FOLLOW（E′）= {），$}。因为E是开始符号，FOLLOW（E）一定包含$。产生式体（E）说明了右括号为什么在FOLLOW（E）中。对于E′，请注意这个非终结符号只出现在E产生式的体的尾部，因此FOLLOW（E′）必然和FOLLOW（E）相同。

5）FOLLOW（T）=FOLLOW（T′）={+，），$}。请注意，T在产生式体中出现时只有E′跟在后面。因此，FIRST（E′）中除∈之外的所有符号一定都在FOLLOW（T）中。这解释了+出现在FOLLOW（T）中的原因。然而，因为FIRST（E′）包含∈（即![156-1](../Images/image04186.jpeg)），且E′就是在E产生式的体中跟在T后面的全部符号，因此FOLLOW（E）中的所有符号都在FOLLOW（T）中。这解释了符号$和右括号出现在FOLLOW（T）中的原因。至于T′，因为它只出现在T产生式的尾部，因此必然有FOLLOW（T′）=FOLLOW（T）。

6）FOLLOW（F）={+，*，），$}。论证过程和第5点中对T的论证过程类似。