### 4.4.5　预测分析中的错误恢复

在讨论错误恢复时要考虑一个由分析表驱动的预测分析器的栈，因为这个栈明确地显示了语法分析器期望用哪些终结符号及非终结符号来匹配余下的输入。这个技术也可以在递归下降语法分析过程中使用。

当栈顶的终结符号和下一个输入符号不匹配时，或者当非终结符号A处于栈顶，a是下一个输入符号，且M［A，a］为error（即相应的语法分析表条目为空）时，预测语法分析过程就可以检测到语法错误。

恐慌模式

恐慌模式的错误恢复是基于下面的思想。语法分析器忽略输入中的一些符号，直到输入中出现由设计者选定的同步词法单元集合中的某个词法单元。它的有效性依赖于同步集合的选取。选取这个集合的原则是应该使得语法分析器能够从实践中可能遇到的错误中快速恢复。下面是一些启发式规则：

1）首先将FOLLOW（A）中的所有符号都放到非终结符号A的同步集合中。如果我们不断忽略一些词法单元，直到碰到了FOLLOW（A）中的某个元素，然后再将A从栈中弹出，那么很可能语法分析过程就能够继续进行。

2）只使用FOLLOW（A）作为A的同步集合是不够的。比如，C语言用分号表示一个语句结束，那么语句开头的关键字可能不会出现在代表表达式的非终结符号的FOLLOW集合中。因此，在一个赋值语句之后遗漏分号可能会使得语法分析器忽略下一个语句开头的关键字。一个语言的各个构造之间常常存在某个层次结构。比如，表达式出现在语句内部，而语句出现在块内部，等等。我们可以把较高层构造的开始符号加入到较低层构造的同步集合中去。比如，我们可以把语句开头的关键字加入到生成表达式的非终结符号的同步集合中去。

3）如果我们把FIRST（A）中的符号加入到非终结符号A的同步集合中，那么当FIRST（A）中的某个符号出现在输入中时，我们就有可能可以根据A继续进行语法分析。

4）如果一个非终结符号可以生成空串，那么可以把推导出∈的产生式当作默认值使用。这么做可能会延迟对某些错误的检测，但是不会使错误被漏检。这个方法可以减少我们在处理错误恢复时需要考虑的非终结符号的数量。

5）如果栈顶的一个终结符号不能和输入匹配，一个简单的想法是将该终结符号弹出栈，并发出一个消息称已经插入了这个终结符号，同时继续进行语法分析。从效果上看，这个方法是将所有其他词法单元的集合作为一个词法单元的同步集合。

例4.36　当按照常用的表达式文法（4.28）对表达式进行语法分析时，使用FIRST和FOLLOW符号作为同步集合就能够很好地完成任务。图4-17中此文法的语法分析表在图4-22中再次给出。图4-22中使用“synch”来表示根据相应非终结符号的FOLLOW集合得到的同步词法单元。各个非终结符号的FOLLOW集合是从例子4.30中得到的。

图4-22中的分析表将按照如下方式使用。如果语法分析器查看M［A，a］并发现它是空的，那么输入符号a就被忽略。如果该条目是“synch”，那么在试图继续分析时，栈顶的非终结符号被弹出。如果栈顶的词法单元和输入符号不匹配，那么我们就按上述方式从栈中弹出这个单元。

![161-1](../Images/image04199.jpeg)

图4-22　加入到图4-17的预测分析表中的同步词法单元

对于错误输入+id* + id，语法分析器以及图4-22中的错误恢复机制的工作过程如图4-23所>示。

![161-2](../Images/image04200.jpeg)

图4-23　一个预测分析器所做的语法分析和错误恢复步骤

上面的关于恐慌模式错误恢复的讨论没有考虑有关错误消息的重要问题。编译器的设计者必须提供足够的包含有用信息的错误消息，它不仅描述相应的错误，还必须引导人们注意错误被发现的地方。

短语层次的恢复

短语层次错误恢复的实现方法是在预测语法分析表的空白条目中填写指向处理例程的指针。这些例程可以改变、插入或删除输入中的符号，并发出适当的错误消息。它们也可能执行一些出栈操作。改变栈中符号或将新符号压入栈中可能会引起一些问题，其原因有多个。首先，由语法分析器执行的动作可能根本不对应于语言中任何句子的推导过程。第二，我们必须保证分析器不会陷入无限循环。防止出现无限循环的一个好办法是保证任何恢复动作最终都会消耗掉某个输入符号（当到达输入结尾处时，则需要保证栈中的内容会变少）。