### 3.4.1　状态转换图

作为构造词法分析器的一个中间步骤，我们首先将模式转换成具有特定风格的流图，称为“状态转换图”。在本节中，我们用手工方式将正则表达式表示的模式转化为状态转换图，在3.6节中，我们将看到可以使用自动化的方法根据一组正则表达式集合构造出状态转换图。

状态转换图（transition diagram）有一组被称为“状态”（state）的结点或圆圈。词法分析器在扫描输入串的过程中寻找和某个模式匹配的词素，而转换图中的每个状态代表一个可能在这个过程中出现的情况。我们可以将一个状态看作是对我们已经看到的位于lexemeBegin指针和forward指针之间的字符的总结，它包含了我们在进行词法分析时需要的全部信息。

状态图中的边（edge）从图的一个状态指向另一个状态。每条边的标号包含了一个或多个符号。如果我们处于某个状态s，并且下一个输入符号是a，我们就会寻找一条从s离开且标号为a的边（该边的标号中可能还包括其他符号）。如果我们找到了这样的一条边，就将forward指针前移，并进入状态转换图中该边所指的状态。我们假设所有状态转换图都是确定的，这意味着对于任何一个给定的状态和任何一个给定的符号，最多只有一条从该状态离开的边的标号包含该符号。从3.5节开始，我们将放松对确定性的要求，令词法分析器的设计者更加容易完成任务，但同时提高了对实现者的技巧要求。一些关于状态转换图的重要约定如下：

1）某些状态称为接受状态或最终状态。这些状态表明已经找到了一个词素，虽然实际的词素可能并不包括lexemeBegin指针和forward指针之间的所有字符。我们用双层的圈来表示一个接受状态，并且如果该状态要执行一个动作的话——通常是向语法分析器返回一个词法单元和相关属性值——我们将把这个动作附加到该接受状态上。

2）另外，如果需要将forward回退一个位置（即相应的词素并不包含那个在最后一步使我们到达接受状态的符号），那么我们将在该接受状态的附近加上一个*。我们的例子都不需要将forward指针回退多个位置，但万一出现这种情况，我们将为接受状态附加相应数目的*。

3）有一个状态被指定为开始状态，也称初始状态，该状态由一条没有出发结点的、标号为“start”的边指明。在读入任何输入符号之前，状态转换图总是位于它的开始状态。

例3.9　图3-13给出了能够识别所有与词法单元relop匹配的词素的状态转换图。我们从初始状态0开始。如果我们看到的第一个输入符号是<，那么在所有与relop模式匹配的词素中，我们只能选择<、<>或<=。因此我们进入状态1并查看下一个字符。如果这个字符是＝，我们识别出词素<=，进入状态2并返回属性值为`LE`的relop词法单元。其中的符号常量`LE`代表了这个具体的比较运算符。如果在状态1，下一个字符是>，那么我们就会得到词素<>，从而进入状态3并返回一个词法单元，表明已经找到一个不等运算符。而对于其他字符，识别得到的词素是<，我们进入状态4并向语法分析器返回这个信息。请注意，状态4有一个*号，说明我们必须将输入回退一个位置。

![098-1](../Images/image04068.jpeg)

图3-13　词法单元relop的状态转换图

另一方面，如果在状态0时我们看到的第一个字符是＝，那么这个字符必定是要识别的词素。我们立即从状态5返回这个信息。其余的可能性是第一个字符为>的情况。那么我们应该进入状态6，并根据下一字符确定词素是>=（如果我们看到下一个字符为＝）还是>（对于任何其他字符）。注意，如果在状态0时我们看到的是不同于<、=或>的字符，我们就不可能看到一个relop的词素，因此这个状态转换图将不会被使用。