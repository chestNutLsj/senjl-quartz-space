### 3.9.4　计算followpos

最后，我们来了解一下如何计算函数followpos。只有两种情况会使得一个正则表达式的某个位置会跟在另一个位置之后：

1）如果n是一个cat结点，且其左右子结点分别为c1、c2，那么对于lastpos（c1）中的每个位置i，firstpos（c2）中的所有位置都在followpos（i）中。

2）如果n是star结点，并且i是lastpos（n）中的一个位置，那么firstpos（n）中的所有位置都在followpos（i）中。

例3.35　现在让我们继续考虑那个贯穿全节的例子。回顾一下，firstpos和lastpos已经在图3-59中计算出来了。followpos的计算规则1要求我们查看每个cat结点，并将它的右子结点的firstpos中的每个位置放到它的左子结点的lastpos中的各个位置的followpos中。对于图3-59中最下面的cat结点，该规则说位置3在followpos（3）和followpos（2）中。其上一个cat结点说4在followpos（3）中，余下的两个cat结点告诉我们5在followpos（4）中，6在followpos（5）中。

我们还必须对star结点应用规则2。该规则告诉我们位置1和2既在followpos（1）中又在followpos（2）中，因为这个结点的firstpos和lastpos都是{1，2}。图3-60给出了全部的followpos集合。

![128-1](../Images/image04128.jpeg)

图3-60　函数followpos

我们可以创建一个有向图来表示函数followpos，其中每个位置有一个对应的结点，从位置i到位置j有一条有向边当且仅当j在followpos（i）中。图3-61显示的有向图表示了图3-60所示的followpos函数。

![128-2](../Images/image04129.jpeg)

图3-61　表示函数followpos的有向图

毫不奇怪，表示followpos函数的有向图几乎就是相应的正则表达式的不包含∈转换的NFA。

如果我们进行下面的处理，这个图就变成了这样的一个NFA。

1）将根结点的firstpos中的所有位置设为开始状态。

2）在每条从i到j的有向边上添加位置i上的符号作为标号。

3）把和结尾#相关的位置当作唯一的接受状态。