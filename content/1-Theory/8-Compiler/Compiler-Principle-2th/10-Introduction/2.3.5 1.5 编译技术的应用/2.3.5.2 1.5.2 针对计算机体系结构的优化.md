### 1.5.2　针对计算机体系结构的优化

计算机体系结构的快速发展也对新编译器技术提出了越来越多的需求。几乎所有的高性能系统都利用了两种技术：并行（parallelism）和内存层次结构（memory hierarchy）。并行可以出现在多个层次上：在指令层次上，多个运算可以被同时执行；在处理器层次上，同一个应用的多个不同线程在不同的处理器上运行。内存层次结构是应对下述局限性的方法：我们可以制造非常快的内存，或者非常大的内存，但是无法制造非常大又非常快的内存。

并行性

所有的现代微处理器都采用了指令级并行性。但是，这种并行性可以对程序员隐藏起来。程序员写程序的时候就好像所有指令都是顺序执行的。硬件动态地检测顺序指令流之间的依赖关系，并且在可能的时候并行地发出指令。在有些情况下，机器包含一个硬件调度器。该调度器可以改变指令的顺序以提高程序的并行性。不管硬件是否对指令进行重新排序，编译器都可以重新安排指令，以使得指令级并行更加有效。

指令级的并行也显式地出现在指令集中。VLIW（Very Long Instruction Word，非常长指令字）机器拥有可并行执行多个运算的指令。Intel IA64是这种体系结构的一个有名的例子。所有的高性能通用微处理器还包含了可以同时对一个向量中的所有数据进行运算的指令。人们已经开发出了相应的编译器技术，从顺序程序出发为这样的机器自动生成代码。

多处理器也已经日益流行，即使个人计算机也拥有多个处理器。程序员可以为多处理器编写多线程的代码，也可以通过编译器从传统的顺序程序自动生成并行代码。这样的编译器对程序员隐藏了一些细节，包括如何在程序中找到并行性，如何在机器中分发计算任务，以及如何最小化处理器之间的同步和通信。很多科学计算和工程性应用需要进行高强度的计算，因此可以从并行处理中得到很大的好处。人们已经开发了并行技术以便自动地把顺序的科学计算程序翻译成为多处理器代码。

内存层次结构

一个内存层次结构由几层具有不同速度和大小的存储器组成。离处理器最近的层速度最快但是容量最小。如果一个程序的大部分内存访问都能够由层次结构中最快的层满足，那么程序的平均内存访问时间就会降低。并行性和内存层次结构的存在都会提高一个机器的潜在性能。但是，它们必须被编译器有效利用才能够真正为一个应用提供高性能计算。

内存层次结构可以在所有的机器中找到。一个处理器通常有少量的几百个字节的寄存器，几层包含了几K到几兆字节的高速缓存，包含了几兆到几G字节的物理寄存器，最后还包括多个几G字节的外部存储器。相应地，层次结构中相邻层次间的存取速度会有两到三个数量级上的差异。系统性能经常受到内存子系统的性能（而不是处理器的性能）的限制。虽然一般来说编译器注重优化处理器的执行，现在人们更多地强调如何使得内存层次结构更加高效。

高效使用寄存器可能是优化一个程序时要处理的最重要的问题。和寄存器必须由软件明确管理不同，高速缓存和物理内存是对指令集合隐藏的，并由硬件管理。人们发现，由硬件实现的高速缓存管理策略有时并不高效。当处理具有大型数据结构（通常是数组）的科学计算代码时更是如此。我们可以改变数据的布局或数据访问代码的顺序来提高内存层次结构的效率。我们也可以通过改变代码的布局来提高指令高速缓存的效率。