### 10.5.5　软件流水线化的目标和约束

软件流水线化的主要目标是使一个长时间运行的循环的吞吐量最大，次要目标之一是使生成代码保持合理的大小。换句话说，经过软件流水线化的循环应该有一个较小的流水线稳定状态。我们可以要求每个迭代的相对调度方案相同，并要求各个迭代启动的时间间隔相同，从而得到一个较小的稳定状态。因为循环的吞吐量是启动间隔的倒数，所以软件流水线化的目标是使这个间隔最小化。

一个数据依赖图G=（N,E）的软件流水线调度方案可以描述为

1）一个启动间隔T。

2）一个相对调度方案S。对每个运算，它给定了该运算相对于它所处迭代的开始时刻的执行时间。

因此，如果从0开始计算时钟周期的话，第i个迭代的一个运算n将会在第i×T+S（n）个时钟周期上运行。和所有其他的调度问题一样，软件流水线化有两种约束：资源和数据依赖关系。下面我们详细讨论每一种约束。

模数资源预约

令一个机器的资源表示为R=［r1,r2,…］，其中ri表示第i种资源的可用数目。如果一个循环的单次迭代需要ni个单元的第i种资源，那么一条流水线化的循环的平均启动间隔至少是maxi（ni/ri）个时钟周期。软件流水线化要求在任何一对相邻迭代之间的启动间隔是一个常量值。因此，它的启动间隔至少是maxi「ni/ri个时钟周期。如果maxi（ni/ri）小于1，那么把源代码少量展开几次就有助于提高代码效率。

例10.17　让我们回到图10-20所示的经过软件流水线化处理的循环。回顾一下，目标机器可以在每个时钟周期内发出一个加载指令、一个算术运算指令、一个保存指令和一个循环回归分支指令。因为这个循环有两个加载运算、两个算术运算和一个保存运算，所以根据资源约束，这个循环的最小启动间隔是2个时钟周期。

图10-24显示了四个连续迭代在不同时刻的资源需求。随着被启动迭代数量的增加，所需的资源也越来越多，最终达到稳定状态下的最大资源需求。令RT为表示单个迭代所需资源的资源预约表，并令RTS表示循环的稳定状态所需要的资源。RTS把每隔T个时钟周期启动的四个相邻迭代所需的资源组合起来。RTS表的第0行所需的资源是RT［0］、RT［2］、RT［4］和RT［6］所需资源的总和。类似地，表中第1行所需资源对应于RT［1］、RT［3］、RT［5］和RT［7］所需资源的总和。也就是说，稳定状态下第i行所需资源可以由下面的公式给出：

![488-1](../Images/image04833.jpeg)

图10-24　例10.13中的代码的四个连续迭代的资源需求

![488-2](../Images/image04834.jpeg)

我们把表示稳定状态的资源预约表称为这条流水线化的循环的模数资源预约表（modular resource-reservation）。

为了检查软件流水线调度方案是否存在冲突，我们只需要检查模数资源预约表中指出的资源需求。如果在稳定状态下的资源需求可以被满足，那么在序言和尾声中，即在稳定状态循环之前和之后的代码部分中，资源需求也一定可以被满足。

总的来说，给定一个启动间隔T和单个迭代的一个资源预约表RT，流水线化的调度方案在一个资源向量为R的机器上没有资源冲突，当且仅当RTS［i］≤R对i=0,1,…,T-1都成立。

数据依赖约束

在软件流水线化中的数据依赖关系和我们至今为止遇到的依赖关系不同，因为它们可能会形成环。一个运算可能会依赖于前一个迭代中同一个运算的结果。现在仅仅在依赖边上加上一个表示延时的标号已经不够了，我们还需要区分同一个运算在不同迭代中的实例。如果在第i次迭代中的运算n2必须在第i-δ次迭代中的运算n1执行至少d个时钟之后才可以执行，那么我们给依赖边n1→n2加上标号<δ,d>。令S是软件流水线化的调度方案，它是一个从数据依赖图中的结点到整数的函数，并令T为启动时间间隔的目标，那么

（δ×T）+S（n2）-S（n1）≥d

其中的迭代距离δ必须是非负的。而且，给定一个由数据依赖图的边组成的环，至少一个边具有正的迭代距离。

例10.18　考虑下面的循环，并假设我们不知道p和q的值：

![489-1](../Images/image04835.jpeg)

我们必须假设任何一对`*（p++）`和`*（q++）`都可能访问同一个内存位置。因此，所有的读和写运算都必须按照原来的串行顺序进行。假设本例中目标机器和例10.12中描述的机器有同样的特性，这段代码的数据依赖边如图10-25所示。但是，请注意我们忽略了循环控制指令。本来应该有这条指令的，它要么计算并测试i的值，要么根据`R1`或`R2`的值来完成这个测试。

![489-2](../Images/image04836.jpeg)

图10-25　例10.18的数据依赖图

如下例所示，两个相关运算之间的迭代距离可以大于1：

![489-3](../Images/image04837.jpeg)

在第i个迭代中写入的值在两个迭代之后才会被用到。因此在保存A［i］的运算和加载A［i-2］的依赖边之间的迭代距离是2。

一个循环中出现的数据依赖环还对循环的执行吞吐量增加了另一个限制。比如，图10-25中的数据依赖环限定了两个连续迭代中的加载运算之间必须有至少4个时钟周期的延时。也就是说，循环的执行不可能快过每4个时钟周期一次迭代。

一个被流水线化的循环的启动间隔不小于

![489-4](../Images/image04838.jpeg)

个时钟周期。

总结一下，每个被软件流水线化的循环的启动间隔受到每个迭代的资源使用情况限制。也就是说，对于每一类资源，启动间隔必须不小于一次迭代所需该类资源的数目除以机器上该类资源的可用数量所得的商。另外，如果循环中存在数据依赖环，那么它的启动间隔还必须不小于这个环中的延时总数除以环中迭代距离之和得到的商。这些量的最大值定义了启动间隔的下界。