### 9.8.2　数据流问题的公式化

这个分析寻找关于某些参考变量的仿射表达式。这些参考变量包括（1）用于对各个循环所执行的迭代进行计数的参考变量，（2）在必要时存放区域入口处的值的参考变量。这个分析也可以找到归纳变量、循环不变表达式以及常量。这里常量可以看作是仿射表达式的退化情况。请注意，这个分析不能够找到所有的常量，因为它只跟踪参考变量的表达式。

数据流值：符号化映射

这个分析使用的数据流值的域是符号化映射，它是将程序中的变量映射到值的函数。这个值可以是一个参考值的仿射函数或者表示非仿射表达式的特殊符号NAA。如果只有一个变量，那么相应半格的底元素值就是一个把该变量映射为NAA的映射。n个变量的半格就是各个变量的半格的积。我们使用mNAA来表示这个半格的底元素，它把所有变量都映射为NAA。就像在常量传播中所做的那样，我们可以把顶层数据流值定义为把所有变量都映射为一个未知值的符号化映射。但是，在基于区域的分析中我们不需要顶元素的值。

例9.59　图9-58显示了例9.58的代码中和各个基本块关联的符号化映射。我们将在稍后看到如何发现这些映射，它们是在图9-56的流图上进行基于区域的数据流分析的结果。

![455-2](../Images/image04768.jpeg)

图9-58　例9.58中的程序的符号化映射

![455-3](../Images/image04769.jpeg)

图9-59　将图9-55的代码中的赋值语句替换为关于参考变量i和j的仿射表达式之后的代码

和程序入口相关联的符号化映射是mNAA。在B1的出口处，a的值被设置为0。在B2的入口处，在第一次迭代时a的值是0，然后在每一次外层循环的迭代中都增加一。因此，在进入第i次迭代时其值为i-1，在迭代结束时为i。因为变量b、c、d在外层循环入口处的值未知，所以在B2入口处的符号化映射把b、c、d映射到NAA。到现在为止，它们的值依赖于外层循环的迭代次数。在B2出口处的符号化映射反映了该基本块中对a、b和c赋值的语句的运行效果。其他的符号化映射可以用类似的方法推导得到。一旦我们确认图9-58中的映射是有效的，就可以把图9-55中对a、b、c和d的赋值替换为适当的仿射表达式。也就是说，我们可以把图9-55替换为图9-59中的代码。

单个语句的传递函数

这个数据流问题中的传递函数根据符号化映射计算得到新的符号化映射。为了计算一个赋值语句的传递函数，我们解释该语句的语义，并决定被赋值的变量能否被表示为赋值语句右边的值的仿射表达式。所有其他变量的值保持不变。

一个语句s的传递函数记为fs，其定义如下：

1）如果s不是一个赋值语句，那么fs就是一个单元函数。

2）如果s是一个对x赋值的语句，那么

![456-1](../Images/image04770.jpeg)

其中表达式c0+c1m（y）+c2m（z）用来表示所有可能出现在对x赋值的语句的右部、关于变量y和z的各种形式的表达式。这些表达式向x赋予的值是变量之前的值的一次仿射变换的结果。这些表达式是c0，c0+y，c0-y，y+z，x-y，c1*y和y/（1/c1）。请注意，在很多情况下，c0、c1和c2中的一个或者多个的值为0。

例9.60　如果该赋值语句是`x=y+z`，那么c0=0而c1=c2=1。如果该赋值表达式是`x=y/5`，那么c0=c2= 0而c1=1/5。

关于值映射上的传递函数的注意事项

我们定义符号化映射上的传递函数的方法中有一个微妙之处，即可以选择不同的方式来表示一个计算的效果。如果m是一个传递函数的输入映射，那么m（x）实际上表示的是“变量x在入口处可能具有的任何值”。我们努力尝试把该传递函数的结果表示为输入映射中用到的参考变量的仿射表达式。

你应该知道对f（m）（x）这样的表达式的正确解释，其中f是一个传递函数，m是一个映射，而x是一个变量。按照数学上的约定，我们从左边开始应用函数，也就是说我们首先计算f（m），结果是一个映射。因为映射也是函数，随后我们可以把它应用于一个变量x并得到一个值。

传递函数的组合

令f1和f2是两个以其输入映射m来定义的传递函数。为了计算![447-3](../Images/image04733.jpeg)，我们把f2的定义中的m（vi）的值替换为f1（m）（vi）的定义。我们把所有对NAA的运算都替换为NAA。也就是：

1）如果f2（m）（v）=NAA，那么（![447-3](../Images/image04733.jpeg)）（m）（v）=NAA。

2）如果f2（m）（v）=c0+∑icim（vi），那么

![456-2](../Images/image04771.jpeg)

例9.61　例9.58中的各个基本块的传递函数可以通过把组成它们的语句的传递函数组合起来计算得到。这些传递函数在图9-60中定义。

数据流问题的解决方法

我们使用INi，j［B3］和OUTi，j［B3］来表示在内层循环的第j次迭代和外层循环的第i次迭代时基本块B3的输入和输出数据流值。对于其他的基本块，我们使用INi［Bk］和OUTi［Bk］来表示在外层循环的第i次迭代时的相应数据流值。我们还可以看到，图9-58中显示的符号化映射满足传递函数给出的约束。这些约束在图9-61中列出。

![457-1](../Images/image04772.jpeg)

图9-60　例9.58的传递函数

![457-2](../Images/image04773.jpeg)

图9-61　嵌套循环的每次迭代上满足的约束

第一个约束说明，一个基本块的输出映射是通过把基本块的传递函数应用到输入映射上而得到的。其余的约束说明，在程序执行的时候，一个基本块的输出映射必须大于或等于后继基本块的输入映射。

请注意，我们的迭代数据流算法不能给出上面的解，因为它无法用已执行的迭代次数来表达数据流值。正如我们将在下一节看到的，可以用基于区域的分析来找出这样的解。