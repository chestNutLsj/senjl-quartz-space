### 9.6.6　自然循环

在一个源程序中，循环可以有很多种描述方法：它们可以被写成for循环、while循环或repeat循环；它们甚至还可以用标号和goto语句来定义。从程序分析的角度来看，循环在源代码中以什么形式出现并不重要，重要的是它们是否具有易于被优化的性质。我们特别关心的是一个循环是否只有一个唯一的入口结点。如果是这样，编译器的分析可以假设某些初始条件在循环的每次迭代的开头成立。这种优化机会引发了定义“自然循环”的需求。

自然循环（natural loop）通过两个重要的性质来定义。

1）它必须具有一个唯一的入口结点，称为循环头（header）。这个入口结点支配了循环中的所有结点，否则它就不会成为循环的唯一入口。

2）必然存在一条进入循环头的回边，否则控制流就不可能从“循环”中直接回到循环头，也就是说实际上并没有循环。

给定一个回边n→d，我们定义该边的自然循环（natural loop of the edge）是d加上那些不经过d就能够到达n的结点的集合。结点d是这个循环的循环头。

算法9.46　构造一条回边的自然循环。

输入：一个流图G和一条回边n→d。

输出：由回边n→d的自然循环中的所有结点组成的集合loop。

方法：令loop等于｛n，d｝。把d标记为“visited”，以便搜索过程不至于越过结点d。从结点n开始对输入的反向控制流图进行深度优先的搜索。把所有访问到的结点都加入loop。这个过程可以找到所有不经过d就可以到达n的结点。

例9.47　在图9-38中有五条回边，这些边的头结点支配了它们的尾结点。它们是：10→7，7→4，4→3，8→3和9→1。请注意，这些边恰好就是所有的被认为在流图中形成循环的边。

回边10→7有自然循环｛7，8，10｝，因为8和10是不经过7就能到达10的结点。回边7→4的自然循环由｛4，5，6，7，8，10｝组成，因此包含了回边10→7的循环。因此，我们假设后者是包含在前者中的一个内部循环。

回边4→3和8→3的自然循环具有同样的头，即结点3；它们恰巧具有同样的结点集合：｛3，4，5，6，7，8，10｝。因此，我们将把这两个循环合并成为一个。这个循环包含了前面找到的两个较小的循环。

最后，回边9→1的自然循环是整个流图，因此是最外层的循环。在这个例子中，四个循环是逐层嵌套的。然而，通常会有两个互不包含的循环。

因为一个可归约的流图中的所有后退边都是回边，我们可以把每条后退边和一个自然循环关联起来。这个结论对于不可归约流图不成立。比如，图9-45中的不可归约流图中有一个由结点2和3组成的环。环中的边都不是回边，因此这个环不满足自然循环的定义。我们并不把这个环当作自然循环，因此也不会优化它。这种情况是可接受的，因为假设所有循环都有唯一的入口点可以使循环分析变得更加简单。而且不管怎么说，不可归约的程序在实践中很少见到。

如果我们只把自然循环当作“循环”，那么可以得到下面的有用性质，即除非两个循环具有同样的循环头，否则它们要么是分离的，要么一个嵌套在另一个中。这样我们就很自然地得到了最内层循环（innermost loop）的定义，即不包含其他循环的循环。

当两个自然循环像图9-46中那样具有相同的循环头时，很难说谁是内层的循环。因此，如果两个自然循环具有相同的循环头且没有哪一个循环真正包含在另一个循环中，它们将被合并在一起，当作一个循环处理。

![440-1](../Images/image04727.jpeg)

图9-46　具有相同循环头的两个循环

例9.48　在图9-46中的回边3→1和4→1的自然循环分别是｛1，2，3｝和｛1，2，4｝。我们将把它们合并成一个循环｛1，2，3，4｝。

然而，假如图9-46中有另一个回边2→1，它的循环是｛1，2｝。这个循环将是第三个以1为循环头的自然循环。这个循环真包含于循环｛1，2，3，4｝，因此它不会和其他两个自然循环合并，而是作为包含在｛1，2，3，4｝中的内层循环进行处理。