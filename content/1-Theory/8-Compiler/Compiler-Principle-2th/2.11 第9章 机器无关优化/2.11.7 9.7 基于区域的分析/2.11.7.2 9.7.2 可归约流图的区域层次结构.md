### 9.7.2　可归约流图的区域层次结构

在接下来的内容中，我们将假设流图是可归约的。如果我们偶尔必须处理不可归约流图的话，我们可以使用一种被称为“结点分割”的技术。该技术将在9.7.6节中讨论。

为了构造区域的层次结构，我们需要找出自然循环。回顾一下9.6.6节，在一个可归约流图中，任何两个自然循环要么不相交，要么一个循环嵌套在另一个循环里。在对一个流图进行“分析”并得到它的区域层次结构的过程在一开始的时候把每个基本块本身看作一个区域。我们把这些区域称为叶子区域（leaf region）。然后，我们把自然循环从内到外（即从最内层的循环开始）排序。处理一个循环时，我们用两个步骤把整个循环替换为一个结点：

1）首先，循环L的循环体（所有的结点以及除了到达循环头的回边之外的所有边）被替换为一个结点，该结点代表一个区域R。原先到达L的循环头的边现在进入代表R的结点。从L的任意出口结点出发的边被替换为从代表R的结点到达同一个目标结点的边。但是，如果该边是一个回边，那么它变成了R上的一个圈。我们把R称为循环体区域（body region）。

2）然后，我们构造一个代表整个自然循环L的区域R′，R′称为一个循环区域（loop region）。R和R′之间的唯一区别在于后者包含了到达L的循环头的回边。换句话说，在流图中用R′替换R时，我们要做的是删除从R到其自身的边。

我们按照这个方法不断进行处理，把越来越大的循环替换成为单个结点。在处理时先把循环替换成为带有圈的结点，再替换成为不带圈的结点。因为可归约流图中的循环要么相互嵌套，要么相互不相交，所以在按照这个归约过程构造得到的一系列流图中，循环区域结点可以表示对应的自然循环的所有结点。

各个自然循环最终都会归约成为单一的结点。此时，要么这个流图被归约为单个结点；要么还有多个结点但是不包含循环，即归约得到的流图是一个包含多个结点的无环图。在前一种情况下，我们已经完成了对区域层次结构的构造；而在后一种情况下，我们需要为整个流图再构造一个循环体区域。

例9.51　考虑图9-48a中的控制流图。在这个流图中有一条从B4到B2的回边。相应的区域层次结构在图9-48b中显示，图中显示的边是区域流图的边。图中总共有8个区域：

![445-1](../Images/image04730.jpeg)

图9-48　例9.51的控制流图

1）区域R1，…，R5是叶子区域，分别代表了基本块B1到B5。每个基本块也是它的区域的出口基本块。

2）循环体区域R6表示流图中唯一循环的循环体。它由区域R2、R3和R4组成，并包括了三个区域之间的边：B2→B3、B2→B4和B3→B4。这个区域有两个基本块：B3和B4，因为它们有不包含在区域内的、离开它们的边。图9-49a显示了把R6归约为一个结点之后得到的流图。请注意，虽然边R3→R5和R4→R5都被替换为边R6→R5，记住R6→R5实际上代表了两条原来的边是很重要的。因为我们最终要沿着这条边传播传递函数，所以需要记住从B3或B4出发的传递函数将到达R5的头结点。

![445-2](../Images/image04731.jpeg)

图9-49　把图9-48的流图归约为单个区域的步骤

3）循环区域R7代表整个自然循环。它包含了一个子区域R6和一条回边B4→B2。它也有两个出口结点，仍然是B3和B4。图9-49b中显示了把整个自然循环归约为R7之后得到的流图。

4）最后，区域R8是顶层区域。它包含三个区域：R1、R7和R5，以及三条区域之间的边B1→B2、B3→B5和B4→B5。当我们把流图归约为R8的时候，它就变成单个结点。因为没有回边到达它的头结点B1，因此不需要再执行一个最后的步骤，把这个区域R8归约成为一个循环区域。

我们用下面的算法来概括按照层次结构分解一个可归约流图的过程。

算法9.52　构造一个可归约流图的自底向上的区域序列。

输入：一个可归约流图G。

输出：G的区域的列表，该列表可用于基于区域的数据流问题。

方法：

1）一开始，列表中以某种顺序包含了由G的各个基本块组成的所有叶子区域。

2）不断选择满足如下条件的自然循环L：如果L中包含了其他的自然循环，那么这些被包含的循环对应的循环体区域和循环区域已经被加入到列表中。首先把由L的循环体（即循环L中除了到达L的循环头的各条回边之外的其余部分）组成的区域加入到列表中，然后再加入L的循环区域。

3）如果整个流图本身不是一个自然循环，在列表的最后加入由整个流图组成的区域。

为什么叫做“可归约的”

现在我们可以知道可归约流图得名的原因了。虽然我们不会证明下面的性质，但本书中用涉及流图的回边来定义的“可归约流图”和其他几个按照能否把一个流图机械地归约成一个结点的定义方式实际上是等价的。在9.7.2节中描述的把自然循环塌缩成为一个结点的过程是上述机械化归约过程的一种。可归约流图的另一个有趣的定义是可以按照下列方法被归约成为一个结点的所有流图：

T1：删除从一个结点到达自身的边。

T2：如果结点n有唯一的前驱m，并且n不是流图的入口结点，那么把m和n合并。