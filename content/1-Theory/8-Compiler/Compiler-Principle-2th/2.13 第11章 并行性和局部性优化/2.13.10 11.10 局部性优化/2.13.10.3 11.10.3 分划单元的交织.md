### 11.10.3　分划单元的交织

一个循环中的不同分划单元经常读取同样的数据，或者读写同样的高速缓存线。在本节和接下来的两节中，我们将讨论当发现了分划单元之间的复用时如何优化局部性。

最内层块的复用

我们采用一个简单的模型，即如果一个数据在少量迭代之后就被复用，那么就可以在高速缓存中找到这个数据。如果最内层循环具有很大或未知的界限，那么只有最内层循环的迭代之间的复用才能够带来更好的局部性。分块处理过程创建了具有较小且已知界限的内层循环，使得我们可以充分利用整个计算块之内或块之间的复用。因此，分块技术具有促进更多维度复用的作用。

例11.69　考虑图11-5中显示的矩阵乘法代码以及图11-7中该代码的分块版本。矩阵乘法在它的三维迭代空间中的每一个维度上都有复用。在原来的代码中，最内层循环具有n个迭代，其中n是未知的，且可能很大。我们的简单模型假设只有跨越最内层循环迭代的被复用数据才可以在高速缓存中找到。

在分块版本中，最内层的三个循环执行了一个三维的计算任务块。这个三维块的每条边长都是B个迭代。这个块的大小是由编译器选择的。这个大小必须足够小，使得在计算分块时读写的所有高速缓存线能够一起放到高速缓存中。因此，跨越自外而内的第三层循环的迭代的复用数据可以在高速缓存中找到。

我们把具有较小且已知界限的最内层循环集合称为最内层分块（innermost block）。如果有可能，我们期望最内层块包含所有可能带有数据复用的迭代空间的维度。把分块边长最大化并不重要。以矩阵乘法为例，三维分块技术把对每个矩阵的数据访问量降低了B2倍。如果存在数据复用，使用高维度小边长的分块要比低维度大边长的分块更好。

我们可以对具有复用关系的循环进行分块，从而优化最内层完全可交换循环嵌套结构的局部性。我们也可以把分块概念泛化，以利用在较外层并行循环的迭代之间找到的复用。请注意，分块技术主要是交错地执行内层循环的少量实例。在矩阵乘法中，最内层循环的每个实例计算出结果数组的一个元素，总共有n2个这样的元素。分块技术把一个块的实例执行交织起来，每次计算每个实例中的B个迭代。类似地，我们可以把并行循环中的迭代交替执行，以利用它们之间的数据复用。

下面我们定义了两个基本方法，它们可以降低跨越迭代的复用之间的距离。我们从最外层循环开始反复应用这两个基本方法，直到所有的复用都被移动到最内层块的相邻位置上。

在一个并行循环中交织内层循环

考虑一个外层可并行化循环包含一个内层循环的情况。为了利用外层循环迭代之间的数据复用，我们把固定多个内层循环的实例交织在一起执行，如图11-63所示。通过创建二维内层分块，这个转换降低了外层循环的连续迭代之间的数据复用之间的距离。

![578-1](../Images/image05037.jpeg)

图11-63　把内层循环的4个实例交织执行

把一个循环

![578-2](../Images/image05038.jpeg)

变成

![578-3](../Images/image05039.jpeg)

的步骤称为条状挖掘（stripmining）。当图11-63中的外层循环的界限较小且已知时，我们不需要对它进行条状挖掘，而是直接交换原程序中的两个循环。

交织执行一个并行循环中语句

考虑一个可并行化循环包含一个语句序列s1,s2,…,sm的情况。如果其中的一些语句本身也是循环，那么连续迭代的语句之间可能还是相隔了很多运算。我们可以使用交织运行这些语句的方法来利用迭代之间的数据复用，如图11-64所示。这个转换在不同的语句之间分布那些经过了条状挖掘的循环。如果外层循环只有少量的固定多个迭代，我们不需要对循环进行条状挖掘，而是直接在各个语句上分布原来的循环。

![578-4](../Images/image05040.jpeg)

图11-64　交织语句的转换

我们使用si（j）来表示语句si在第j个迭代中的运行。代码的执行不是按照图11-65a中显示的原执行顺序，而是按照图11-65b中显示的顺序执行。

![579-1](../Images/image05041.jpeg)

图11-65　分布一个经过条状挖掘的循环

例11.70　我们现在回到多网格的例子，说明如何利用外层并行循环的迭代之间的数据复用。我们观察到，图11-62的代码的最内层循环中的引用DW［1,k,j,i］、DW［1,k-1,j,i］和DW［1,k+1,j,i］的空间局部性很差。根据11.5节中讨论的复用分析可知，下标变量为i的循环具有空间局部性，而下标为k的循环具有组复用性。下标为k的循环已经是最内层循环了，因此我们感兴趣的是交织执行来自一个具有连续i值的分划块中的对DW的运算。

我们应用这个转换来交织这个循环中的语句，得到图11-66中的代码，然后应用这个转换来交织内层循环，得到图11-67中的代码。请注意，当我们把来自下标为i的循环的B个迭代交错执行时，我们需要把变量AP、AM、T扩展为数组，以便一次存放B个结果。

![579-2](../Images/image05042.jpeg)

图11-66　对图11-23的代码进行分划、数组收缩、内层循环交错和分块后所得的部分代码

![580-1](../Images/image05043.jpeg)

图11-67　对图11-23的代码进行分划、数组收缩和分块后所得的部分代码