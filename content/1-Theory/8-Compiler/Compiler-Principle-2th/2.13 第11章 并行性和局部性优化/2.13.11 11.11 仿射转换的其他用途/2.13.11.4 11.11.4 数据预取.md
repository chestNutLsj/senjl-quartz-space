### 11.11.4　数据预取

没有哪个数据局部性优化方法可以消除所有的内存访问。首先，第一次使用的数据必须从内存中获取。为了隐藏内存访问的延时，预取指令（prefetch instruction）被很多高性能处理器采用。数据预取指令被用来向处理器指明某些数据有可能很快就会被用到，因此如果它现在还没有在高速缓存中，期望能把它加载到高速缓存中。

11.5节中描述的复用分析可以用于估计什么时候可能发生高速缓存脱靶。当生成预取指令时，有两个重要问题需要考虑。如果将要访问连续的内存位置，我们只需要为每个高速缓存线发出一个预取指令。我们必须足够早地发出预取指令，以保证在使用这个数据时，它已经在高速缓存中了。但是，我们不应该过早地发出预取指令。预取指令可能会把高速缓存中还需要使用的数据转移出高速缓存，而预取到的数据也可能会因此在使用之前就被调出高速缓存了。

例11.73　考虑下面的代码：

![583-1](../Images/image05047.jpeg)

假设目标机器有一个预取指令。该指令可以一次预取两个字的数据，而一个预取指令的延时大约等于上面的循环中六次迭代的执行时间。图11-68中显示了这个例子的使用预取指令的代码。

![583-2](../Images/image05048.jpeg)

图11-68　为预取数据而修改的代码

我们把最内层的循环展开两次，使得可以为每个高速缓存线发出一个预取指令。我们使用软件流水线化概念来保证在数据被使用的六个迭代之前预取数据。流水线的前言部分获取了前6个迭代中使用的数据，稳定状态循环在它进行计算的同时提前预取6个迭代。尾声部分没有预取指令，只是直接执行余下的迭代。