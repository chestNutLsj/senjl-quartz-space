### 11.1.1　多处理器

最流行的并行机体系结构是对称多处理器（Symmetric MultiProcessor，SMP）结构。高性能个人计算机通常有两个处理器，而很多服务器有四个、八个，甚至几十个处理器。不仅如此，因为现在已经能够实现把多个高性能处理器集成在一个芯片上，所以多处理器得到了更加广泛的应用。

![504-1](../Images/image04859.jpeg)

图11-1　对称多处理器体系结构

一个对称多处理器结构中的各个处理器共享同一个地址空间。进行通信时，一个处理器把数据写到某个内存位置，然后由其他处理器来读取。对称多处理器的名字就是源于所有的处理器能够以统一的访问时间来访问系统中所有的内存。图11-1给出了一个多处理器的高层体系结构。各个处理器都拥有自己的第一层、第二层高速缓存，有时甚至拥有第三层高速缓存。最高层的高速缓存通过通常的共享总线连接到物理内存。

对称多处理器使用一致缓存协议（coherent cache protocol）来对程序员隐藏高速缓存的存在。在这样的协议下，多个处理器可以同时保存同一高速缓存线的多个拷贝[^1]，前提是它们都只是读取数据。当一个处理器想向一个高速缓存线写数据时，所有其他的高速缓存拷贝都被删除。当一个处理器请求的数据不在高速缓存中时，该请求会向外传递到共享总线，并从内存或其他处理器的高速缓存中获取数据。

一个处理器和另一个处理器通信所花的时间大约是内存访问时间的两倍。以缓存线为单位的数据必须首先从源处理器的高速缓存写到内存中，然后再从内存取出放到第二个处理器的高速缓存中。你可能认为处理器之间的通信相对便宜，因为它只需要大约两倍于内存访问的时间。但是，必须记住，相对于在高速缓存中命中的访问运算，内存访问已经非常昂贵了——内存访问可能慢几百倍。这个分析十分清楚地说明了高效并行化和局部性分析之间的相似性。不管是单独工作的处理器还是多处理器环境下的处理器，要使它高效工作就必须使它能够在高速缓存中找到运算所需的大部分数据。

在21世纪早期，对称多处理器的设计超不过几十个处理器的规模，原因是受到共享总线或任何其他用于此目的的互联设施的限制。它们在速度上不能应对不断增加的处理器数量。为了使得处理器设计可不断扩大规模，体系结构设计师们又在内存层次结构中引入了新的一层。他们不再使用和各个处理器距离一样远的内存，而是把内存分配给各个处理器，以便每个处理器能够快速访问它的局部内存，如图11-2所示。因此远程内存成为内存层次的下一级，它们的总量要比局部内存大，但是访问时花费的时间也更长。和内存体系结构设计时高速存储设备必然容量较小的原理类似，支持处理器之间快速通信的机器所拥有的处理器数量也必然较少。

![504-2](../Images/image04860.jpeg)

图11-2　分布式内存的机器

有两种不同的带有分布式内存的并行机：NUMA（NonUniform Memory Access，不一致内存访问）机器以及消息传递机器。NUMA体系结构为软件提供了一个共享地址空间，允许处理器通过读写共享内存来通信。然而，在消息传递机器上的处理器有各自的地址空间，处理器之间通过相互传递消息来通信。请注意，虽然为共享内存机器写代码要相对简单，但任何一种机器要想具有好的性能，都要求软件具有良好的局部性。