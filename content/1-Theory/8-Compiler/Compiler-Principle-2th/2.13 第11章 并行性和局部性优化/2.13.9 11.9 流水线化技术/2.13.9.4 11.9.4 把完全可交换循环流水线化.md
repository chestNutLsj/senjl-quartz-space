### 11.9.4　把完全可交换循环流水线化

一个具有k个最外层完全可交换循环的循环嵌套结构可以被构造为一个O（k-1）维的流水线。在SOR的例子中，k=2，因此我们可以把处理器构造成一个线性流水线。

我们可以用两种不同的方法对上面的SOR代码进行流水线化，如图11-52a和图11-52b所示。这两种流水线化方案分别对应于图11-51a和图11-51c所示的两种可能的排列。在每一种情况下，相应迭代空间的每一列组成一个任务，而每一行组成一个流水线阶段。我们把第i个阶段分配给处理器i，因此每个处理器执行内层循环的代码。不考虑边界条件，只有在处理器p-1执行了迭代i-1之后，处理器p才可以执行迭代i。

![563-2](../Images/image05004.jpeg)

图11-52　图11-51中的代码的两个流水线化实现

假设每个处理器用同样的时间来执行一个迭代，并且同步运算在瞬时发生。这两个流水线化方案将并行执行同样的迭代，唯一的区别是它们的处理器分配方法不同。在图11-51b中的迭代空间中，所有并行执行的迭代处于135°的斜线上，这些斜线对应于原迭代空间中的150°斜线，见图11-50b。

但是在实践中，带有高速缓存的处理器执行同一代码所花的时间并不总是相同的，用于同步运算的时间也会有所变化。使用同步栅障将使所有的处理器按照一致的步调进行运算。和同步栅障方法不同，流水线化技术最多要求处理器和另外两个处理器进行同步和通信。因此，流水线化的波阵面更加松弛，允许有些处理器领先而其他处理器暂时落后。这个灵活性降低了处理器在等待其他处理器时所花的时间，提高了并行性能。

可以把这个计算任务流水线化的方法有很多，上面显示的流水线化方案只是其中的两个。我们说过，只要一个循环嵌套结构是完全可交换的，我们在选择代码并行化方案方面就有很大的自由度。第一个流水线方案把迭代［i,j］映射到处理器i；第二个方案把迭代［i,j］映射到处理器j。只要c0和c1是正常数，我们就可以把迭代［i,j］映射到处理器c0i+c1j，从而得到其他的流水线化方案。这样的方案将创建出不同的流水线，它们的松弛波阵面位于90°（不含）到180°（不含）之间。