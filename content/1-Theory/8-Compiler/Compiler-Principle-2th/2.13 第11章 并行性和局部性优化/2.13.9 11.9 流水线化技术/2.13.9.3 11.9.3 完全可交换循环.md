### 11.9.3　完全可交换循环

我们首先介绍一下完全可交换（full permutability）的概念。这个概念对于流水线化和其他一些优化技术都是有用的。多个循环是完全可交换的条件是它们可以任意地排列而不会改变原程序的语义。一旦多个循环具有完全可交换的性质，我们可以很容易地把相应的代码流水线化，并对代码应用某些转换（比如分块技术）来提高数据局部性。

图11-50a中给出的SOR代码不是完全可交换的。如11.7.8节所示，交换两个循环的位置意味着原来的迭代空间中的迭代按照逐列（而不是逐行）的方式执行。比如，原来在迭代［2,3］中的计算将会在迭代［1,4］的计算之前执行，这就违反了图11-50b中的依赖关系。

然而，我们可以通过代码转换使得上面的SOR代码变成完全可交换的。对这个代码应用仿射转换

![562-2](../Images/image05002.jpeg)

可得到图11-51a中所示代码。经过转换得到的代码是完全可交换的，交换后的版本如图11-51c所示。我们在图11-51b和图11-51d中分别显示了这两个程序的迭代空间和数据依赖关系。从这个图中可以很容易看出这个重新排序保持了每一对具有数据依赖关系的访问之间的相对顺序。

当我们交换循环时，我们极大地改变了最外层循环的各个迭代所执行的运算集合。我们在调度这些运算时具有这样的自由度，说明在对程序的运算进行排序时有很大的回旋余地。调度的余地意味着存在并行化的机会。在本节的稍后我们将说明如果一个循环嵌套结构具有k个最外层的完全可交换循环，我们仅仅需要引入O（n）个同步运算，就可以得到O（k-1）度的并行性（n是一个循环中的迭代的个数）。

![563-1](../Images/image05003.jpeg)

图11-51　图11-50中代码的完全可交换版本