### 11.9.1　什么是流水线化

前面我们尝试对一个循环嵌套结构进行并行化时，我们对这个循环嵌套结构中的迭代进行分划，使得任意两个共享数据的迭代都被分配给同一个处理器上。流水线化技术允许不同处理器共享数据，但是一般只能以“局部的”方式来共享数据，数据只能从一个处理器传递到所在处理器空间中的邻近处理器上。下面给出一个简单的例子。

例11.55　考虑循环：

![560-4](../Images/image04999.jpeg)

这个代码把Y的第i行中的值相加，并把结果加到X的第i个元素上。其中的内层循环对应于求和过程。因为数据依赖的原因，这个循环必须顺序执行[^6]，但是不同的求和过程之间是独立的。我们可以让每个处理器执行一个独立的求和过程，从而实现代码的并行化。处理器i访问Y的第i行并修改X的第i个元素。

我们还可以把多个处理器组织成一个流水线来执行这个求和过程，并通过求和过程的重叠来获取并行性，如图11-49所示。更明确地讲，内层循环的每个迭代都可以被当作流水线的一个阶段：第j个阶段获取在前一阶段生成的X的一个元素，将它和Y的一个元素相加，并把结果传递到下一个阶段。请注意在这种情况下，每个处理器访问Y的一列，而不是一行。如果Y是按列存放的，那么通过按列分划（而不是按行分划）就可以提高局部性。

![561-1](../Images/image05000.jpeg)

图11-49　例11.55中的流水线化的执行过程，其中m=4，n=3

第一个处理器处理完前一个任务的第一个阶段之后，我们就可以立刻启动一个新的任务。流水线在开始时是空的，只有第一个处理器在执行第一个阶段。在它完成处理之后，结果被传送到第二个处理器，同时第一个处理器开始处理第二个任务，如此继续。按照这种方式，流水线被逐渐填满，直到所有的处理器都进入忙状态。当第一个处理器完成了最后一个任务后，流水线开始排空，越来越多的处理器进入空闲状态，直到最后一个处理器完成最后一个任务。在稳定状态下，n个任务在由n个处理器组成的流水线中并行执行。

把流水线技术和不同处理器处理不同任务的简单并行性进行比较是很有意思的：

- 流水线化技术只能应用于深度至少为2的循环嵌套结构。我们可以把外层循环的每个迭代当作一个任务，而把内层循环的各个迭代当作任务的各个阶段。
- 在一个流水线中运行的任务可以具有数据依赖关系。属于各个任务的同一个阶段的信息被存放在同一个处理器上。因此，由一个任务的第i个阶段生成的结果可以直接被后继任务的第i个阶段使用，不会产生通信开销。类似地，由不同任务的同一个阶段所使用的每个输入数据元素必须存放在同一个处理器内，如例11.55所示。
- 如果任务是独立的，那么简单的并行化方案具有较好的处理器利用率，原因是各个处理器可以一起开始执行，而不会产生填满和排空流水线的开销。但是，如例11.55所示，在一个流水线方案中的数据访问模式和简单并行化方案中的模式不同。如果流水线化技术可以降低通信量，那么就应该选择这个技术。