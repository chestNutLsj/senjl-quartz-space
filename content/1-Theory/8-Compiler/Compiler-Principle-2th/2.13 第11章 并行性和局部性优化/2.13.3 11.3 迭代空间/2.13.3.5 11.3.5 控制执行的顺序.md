### 11.3.5　控制执行的顺序

从一个循环体的上下界中抽取到的线性不等式定义了一个凸多面体上的迭代的集合。这个表示方法并没有假定在迭代空间中的迭代之间的任何执行顺序。原程序在迭代之上强加了一个串行顺序，该顺序就是按照从外到内方式排列的循环下标变量取值的词典排序。但是，只要遵守它们之间的数据依赖关系（即循环嵌套结构中不同赋值语句所执行的对任一数组元素的写/读操作的顺序没有改变），就可以按照任何顺序执行该空间中的迭代。

如何选择一个既遵守数据依赖关系，又能优化数据局部性和并行性的顺序是很困难的问题，我们稍后将从11.7节开始处理这个问题。这里我们假设已经有了一个合法且令人满意的排序，说明如何生成遵守这个顺序的代码。首先让我们讨论例11.6中的另一个排序。

例11.10　在例11.6的程序中，迭代之间没有数据依赖关系。因此，可以用串行或者并行的方式执行这些迭代。因为在此代码中迭代［i,j］访问了元素Z［j,i］，原程序按照图11-14a中的顺序访问数组。为了提高空间局部性，我们更愿意像图11-14b所显示的那样连续地访问数组中的邻近元素。

![518-1](../Images/image04886.jpeg)

图11-14　一个循环嵌套结构的访问和迭代的重新排序

如果我们按照图11-14c中的顺序执行循环的迭代，就能够得到上面的访问模式。也就是说，我们垂直地（而不是水平地）扫描图11-11中的迭代空间，因此j变成了外层循环的下标。按照上面的顺序执行这些迭代的代码是

![518-2](../Images/image04887.jpeg)

给定一个凸多面体和一个下标变量的排序，我们该如何生成循环的界限，使得循环能够按照这些变量的词典排序扫描这个迭代空间？在上面的例子中，约束i≤j在原程序中是作为内层循环下标j的下界出现的，但是在转换得到的程序中它作为内层循环下标i的上界出现。

最外层循环的界限是用符号常量和常量的线性组合来表示的，它定义了该循环下标的全部取值的范围。内层循环的下标变量的界限用较外层循环的下标变量、符号常量和常量的线性组合来表示。对于给定的较外层循环下标变量的每个取值组合，它们定义了该循环下标变量的取值范围。

投影

从几何学的角度来讲，我们可以把表示迭代空间的凸多面体投影（projectiog）到该空间中对应于较外层循环的维度上，以得到一个深度为2的循环嵌套结构中外层循环下标变量的循环界限。直观地讲，一个多面体在一个较低维度空间的投影就是该物体在这个空间中的影子。图11-11中的二维迭代空间到i轴上的投影是从0到5的垂直线；而到j轴的投影是从0到7的水平线。当我们把一个3维物体沿着z轴投影到一个二维的x-y的平面上时，我们消除变量z，失去了各个点的高度信息，而仅仅记录下该物体在x-y平面上的二维覆盖区域。

循环界限生成只是投影的多种用途之一。投影的正式定义如下。令S为一个n维多面体。S到它的前m个维度的投影是满足如下条件的点（x1,x2,…,xm）：存在xm+1,xm+2,…,xn使得向量［x1,x2,…,xn］在S中。我们可以使用Fourier-Motzkin消除算法来计算投影。下面介绍该算法。

算法11.11　Fourier-Motzkin消除算法。

输入：一个带有变量x1,x2,…,xn的多面体S。也就是说，S是关于变量xi的一组线性约束。一个给定的变量xm是被指定需要消除的变量。

输出：一个关于变量x1,x2,…xm-1,xm+1,…,xn（即除xm之外的所有S的变量）的多面体S′。S′是S到除第m个维度之外的所有维度的投影。

方法：令C是S中所有涉及xm的约束的集合。执行下列步骤：

1）对于C中关于xm的每一对上界和下界，比如

L≤c1xm

c2xm≤U

建立一个新的约束

c2L≤c1U

请注意，c1和c2是整数，但L和U可能是关于除xm之外的其他变量的表达式。

2）如果整数c1和c2有公因子，将上面约束的两边都除以这个因子。

3）如果新的约束是不可满足的，那么S无解，即多面体S和S′都是空的空间。

4）S′是约束集合S-C加上在第2步中生成的所有约束。

顺便说一下，如果xm具有u个下界和v个上界，消除xm最多会产生uv个不等式。

在算法11.11的第一步中引入的约束对应于约束集合C所蕴涵的对系统中其余变量的约束。因此，S′中有一个解的充要条件是S中至少有一个对应的解。给定S′中的一个解，把约束集合C中除了xm之外的所有变量替换为它们在这个解中的实际取值，就可以得到xm的取值范围。

例11.12　考虑定义了图11-11中的迭代空间的不等式组。假设我们希望使用Fourier-Motzkin消除算法来消除i维度，从而把这个二维空间投影到j维度上。存在一个i的下界0≤i和两个上界i≤j和i≤5。这可以生成两个约束0≤j和0≤5。后一个约束是永真式，可以忽略。前一个约束给出了j的下界，j的上界就是原来的上界j≤7。

循环界限的生成

既然我们已经定义了Fourier-Motzkin消除算法，生成循环界限来遍历一个凸多面体的算法（算法11.13）就很容易得到了。我们按照从最内层到最外层循环的顺序计算循环界限。所有涉及最内层循环下标变量的不等式都被改写成为该变量的下上界的形式。然后，我们通过投影消除代表了最内层循环的维度，得到减少了一个维度的多面体。我们重复这个过程，直到找出所有循环下标变量的界限。

算法11.13　给定一组变量的顺序，计算这些变量的界限。

输入：一个在变量v1,v2,…,vn之上的凸多面体S。

输出：每个变量vi的下界Li和上界Ui，这些界限只使用排在vi之前的变量vj（j<i）来表示。

方法：该算法在图11-15中描述。

![520-1](../Images/image04888.jpeg)

图11-15　按照一个给定的变量顺序表示变量界限的代码

例11.14　我们应用算法11.13来生成用于垂直扫描图11-11中的迭代空间的循环界限。下标变量的顺序是j，i。该算法生成了如下的界限：

Li:0

Ui:5,j

Lj:0

Uj:7

我们要满足所有这些约束，因此i的上界是min（5,j）。这个例子中没有冗余的界限。