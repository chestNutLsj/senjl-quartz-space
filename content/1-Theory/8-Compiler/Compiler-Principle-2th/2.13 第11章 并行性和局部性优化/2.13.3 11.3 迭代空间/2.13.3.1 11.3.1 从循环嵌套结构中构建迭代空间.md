### 11.3.1　从循环嵌套结构中构建迭代空间

让我们首先描述一下即将学习的技术能够处理哪些类型的循环嵌套结构。每个循环有一个唯一的循环下标，我们假设每次迭代这个下标增加1。这个假设并没有失去一般性，因为如果每次迭代的增量是大于1的整数c，那么总是可以把对下标i的使用替代为ci+a，其中a是某个正或负的常数，然后循环中的每次迭代将i加1。这个循环的上下界必须写成其外层循环的下标的仿射表达式。

例11.5　考虑下面的循环

![514-1](../Images/image04873.jpeg)

该循环的每轮运行把循环下标i加3，它的效果是把各个数组元素Z［2］，Z［5］，Z［8］，…，Z［98］设置为0。我们可以使用下面的循环来得到同样的效果：

![514-2](../Images/image04874.jpeg)

也就是说，我们用3j+2替代了i。下界i=2变成了j=0（只需要求解方程3j+2=2就可得到j的值），而上界i≤100变成了j≤32（将3j+2≤100简化可得j≤32.67，又因为j必须是整数，所以要舍弃小数部分）。

通常情况下，我们将在循环嵌套结构中使用for循环结构。对于一个while循环或者repeat循环，如果存在一个下标以及该下标的上下界，那么它就可以被替换为一个for循环。图11-9a中的循环就是这样的情况。一个像`for（i=0；i<100；i++）`这样的for循环可以达到同样的目标。

![515-1](../Images/image04875.jpeg)

图11-9　一些while循环

但是有些while循环或repeat循环没有明显的界限。比如，图11-9b中的例子可能会中止，也可能不会终止，但是没有办法指出在未知的循环体中i满足什么条件时程序会跳出该循环。图11-9c是另一个会出现问题的情况。例如，变量n可能是一个函数的参数。我们知道循环迭代n次，但是在编译时刻我们不知道n的值是什么。实际上，我们可能期望该循环在不同的执行中迭代的次数不同。在图11-9b和图11-9c这样的情况下，我们必须把i的上界当作无限来处理。

一个深度为d的循环嵌套结构可以被建模为一个d维空间。空间的各个维是有序的，第k维表示该嵌套结构中从最外层循环起的第k个循环。这个空间中的一个点（x1,x2,…,xd）表示所有这些循环下标的值，最外层循环下标的值是x1，第二个循环下标的值是x2，以此类推。最内层循环下标的值是xd。

但并不是这个空间中的每个点都代表了一个在该循环嵌套结构执行时实际出现的下标取值组合。作为外层循环下标的一个仿射函数，每个循环的上下界都定义了一个不等式，它把空间分成两半：对应于循环迭代的部分（即正的半空间）和不对应于迭代的部分（即负的半空间）。所有线性不等式的交（逻辑AND）表示这些正的半空间的交集，该交集定义了一个凸多面体（convex polyhedron）。我们把这个多面体称为这个循环嵌套结构的迭代空间（iteration space）。一个凸多面体具有以下性质：如果两个点在该多面体内，那么它们之间的连线上的所有点都在该多面体内。多面体使用循环界限不等式描述。循环的每个迭代都可以由该多面体中的具有整数坐标的点表示。反过来，在多面体内的每个整数点都代表了该循环嵌套结构在某个时候执行的一个迭代。

例11.6　考虑图11-10中的二维循环嵌套结构。我们可以使用图11-11中显示的二维多面体对这个深度为2的循环嵌套结构建模。图中的两个轴表示循环下标i和j的值。下标i可以取0～5之间的任何整数值；下标j可以取满足i≤j≤7的任何整数值。

![515-2](../Images/image04876.jpeg)

图11-10　一个二维循环嵌套结构

![516-1](../Images/image04877.jpeg)

图11-11　例11.6的迭代空间

迭代空间和数组访问

在图11-10的代码中，迭代空间也是数组Z中被该代码访问到的部分。这种类型的访问是很常见的，它们的数组下标就是按某种顺序排列的循环下标。但是，我们不应该把迭代空间和数据空间相混淆。迭代空间的各个维度是各循环下标。假设我们在图11-10的代码中使用一个类似于Z［2*i,i+j］的数组访问来替换Z［j,i］，那么迭代空间和数据空间之间的区别就很明显了。