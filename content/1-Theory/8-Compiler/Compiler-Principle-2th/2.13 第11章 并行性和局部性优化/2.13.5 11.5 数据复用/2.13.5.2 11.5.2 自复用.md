### 11.5.2　自复用

通过利用自复用可以有效节约在内存访问方面的开销。如果一个静态访问所指向的数据具有k个维度，且这个访问嵌套在一个深度为d（d>k）的循环结构中，那么同一个数据可以被复用nd-k次。其中，n是每个循环的迭代次数。比如，如果一个深度为3的循环嵌套结构访问一个数组的某一列，那么访问节约系数就可能达到n2。实际上，一个访问的维度和这个访问的系数矩阵的秩相对应。我们可以通过寻找该矩阵的零空间来找出哪些迭代指向同一个位置。具体方法在下面解释。

矩阵的秩

矩阵F的秩是F的线性无关列（或者等价地，行）的最大数目。一个向量集合被称为线性无关（linearly independent）的条件是没有向量可以被写成该集合中有限多个其他向量的线性组合。

例11.21　考虑矩阵

![525-2](../Images/image04903.jpeg)

请注意，第二行是第一和第三行的和，而第四行是第三行减去第一行的两倍。但是，第一行和第三行是线性独立的；其中的任何一行都不是另一行的倍数。因此，矩阵的秩是2。

我们也可以通过检查各列来得到这个结果。第三列是第二列的两倍减去第一列。另一方面，任何两列都是线性独立的。我们同样可以确定矩阵的秩为2。

例11.22　我们看一下图11-18中的数组访问。第一个访问X［i-1］的维度为1，因为矩阵［1 0］的秩为1。也就是说，唯一的一行是线性独立的，同样第一列也是线性独立的。

第二个访问Y［i,j］的维度为2。原因是矩阵

![526-1](../Images/image04904.jpeg)

具有两个独立的行（当然，因此也具有两个独立的列）。

第三个访问Y［j,j+1］的维度为1，因为矩阵

![526-2](../Images/image04905.jpeg)

的秩为1。请注意，矩阵中的两行是相同的，因此只有一行是线性独立的。等价地，第一列是第二列乘以0，因此这两列不是独立的。直观地讲，在一个大的正方形数组Y中，所有被访问的元素都排列在紧靠主对角线之上的一条斜线上。

第四个访问Y［1,2］的维度为0，因为一个全零矩阵的秩为0。请注意，对于这样的一个矩阵，我们找不出非零的矩阵的行（哪怕只有一行）的线性和。最后一个访问Z［i,i,2*i+j］的维度为2。请注意在这个访问的矩阵

![526-3](../Images/image04906.jpeg)

中，最后两行是线性独立的，任何一行都不是另一行的倍数。但是，第一行是另两行的线性“和”，其中的系数都是0。

矩阵的零空间

在一个深度为d的循环嵌套结构中的秩为r的数据引用在O（nd）个迭代中访问了O（nr）个数据元素，因此平均一定有O（nd-r）个迭代指向同一个数组元素。哪些迭代访问了同一个数据呢？假设在这个循环嵌套结构中的一个访问用F和f的矩阵-向量组合来表示。令i和i′为指向同一个数组元素的两个迭代，那么Fi+f=Fi′+f。重新排列这个等式中的各项，我们得到

F（i-i′）=0

有一个众所周知的线性代数概念可以刻划i和i′在什么时候满足上述等式。满足等式Fv=0的所有解的集合称为F的零空间。因此，如果两个迭代的循环下标向量的差属于矩阵F的零空间，那么它们指向同一个数组元素。

显然，零向量v=0总是满足Fv=0。也就是说，如果两个向量的差为0，那么它们一定指向同一个数组元素。换句话说，如果它们实际上是同一个迭代，它们就指向同一个元素。另外，零空间确实是一个向量空间。也就是说，如果Fv1=0且Fv2=0，那么F（v1+v2）=0且F（cv1）=0。

如果矩阵F是全秩的（fully ranked），也就是说它的秩为d，那么F的零空间只包含零向量。在这种情况下，一个循环嵌套的各个迭代指向不同的数据。一般来说，零空间的维度，或者说零数（nullity），就是d-r。如果d>r，那么对于每个元素，访问该元素的迭代组成一个（d-r）维空间。

零空间可以用它的基本向量表示。一个k维的零空间可以由k个独立的向量表示，任何可以被表示为这些基本向量的线性组合的向量都属于这个空间。

例11.23　重新考虑例11.21的矩阵

![527-1](../Images/image04907.jpeg)

在例11.21中，我们确定这个矩阵的秩为2，因此其零数为3-2=1。在这个例子中，零空间的基本向量必然是一个长度为3的非零向量。为了找到这个零空间的基本向量，我们假设零空间中的一个向量为［x,y,z］，并尝试求解下面的方程

![527-2](../Images/image04908.jpeg)

如果我们将前面两行乘以未知向量，就得到两个方程

x+2y+3z=0

5x+7y+9z=0

我们也可以根据第三和第四行写出这样的方程，但是因为不存在三个线性独立的行，所以增加方程不会对x、y和z增加新的约束。比如，我们从第三行得到的方程4x+5y+6z=0就是通过从第二个方程中减去第一个方程得到的。

我们必须尽可能地从上面的等式中消除变量。首先使用第一个方程求解x，得到x=-2y-3z。然后在第二个方程中替换x，得到-3y=6z，即y=-2z。由x=-2y-3z且y=-2z可知x=z。因此，变量［x,y,z］实际上是［z,-2z,z］。我们可以选择任意的非零z值，得到这个零空间的唯一基本向量。比如，我们可以选择z=1并把［1,-2,1］当作这个零空间的基本向量。

例11.24　例11.17中的所有数组访问的秩、零数和零空间显示在图11-19中，请注意，在所有情况下秩和零数的和都等于该循环嵌套的深度2。因为数组访问Y［i,j］和Z［1,i,2*i+j］的秩都是2，因此所有的迭代都指向不同的位置。

![527-3](../Images/image04909.jpeg)

图11-19　仿射访问的秩和零数

数组访问X［i-1］和Y［j，j+1］的矩阵的秩都是1，因此O（n）个迭代指向同一个位置。在前一种情况下，迭代空间的一整行都指向同一个位置。换句话说，仅仅j值不同的所有迭代指向同一个位置。这一事实由相应零空间的基本向量［0,1］明确表示。对于Y［j，j+1］，迭代空间中的整列指向同一个位置。这个事实由相应零空间的基本向量［1,0］明确表示。

最后，数组访问Y［1,2］在所有迭代中指向同一个位置。相应的零空间有两个基本向量［0,1］和［1,0］，这表示这个循环嵌套中的任何一对迭代都准确地指向同一个位置。