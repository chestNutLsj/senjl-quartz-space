### 11.5.3　自空间复用

空间复用的分析依赖于矩阵的数据布局。C语言的矩阵是按行存放的，而Fortran语言的矩阵按列存放。换句话说，在C语言中数组元素X［i，j］和X［i，j+1］相邻，而在Fortran语言中X［i，j］和X［i+1，j］相邻。不失一般性，在本章余下的部分，我们将选用C语言的数组布局方式（按行存放方式）。

首先作出如下的近似，当且仅当两个数组元素位于一个二维数组的同一行中时，我们认为它们共享一个高速缓存线。更加一般地讲，在一个d维数组中，如果两个元素只在最后一维的下标值上有所不同，我们就认为它们共享一个高速缓存线。因为对于通常的数组和高速缓存线，多个数组元素可以被放到同一高速缓存线中，以整行的方式顺序访问一个数组可以明显提高访问速度。虽然严格地讲，我们有时还需要等待加载一个新的高速缓存线。

发现和利用自空间复用的技巧是不考虑系数矩阵F中的最后一行。如果得到的截短后的矩阵的秩小于循环嵌套结构的深度，那么我们就可以确保最内层循环只改变数组的最后下标的值，从而保证空间局部性。

例11.25　考虑图11-19中的最后一个数组访问Z［1,i,2*i+j］。如果我们删除最后一行，就会得到下面的截短后的矩阵

![528-1](../Images/image04910.jpeg)

这个矩阵的秩显然是1。因为该循环嵌套结构的深度为2，所以存在空间复用的机会。在这个例子中，因为j是内层循环的下标且Z是按行存放的，所以内层循环访问Z的连续元素。让i成为内层循环的下标不会产生空间局部性。因为当i改变时，第二和第三个维度都会改变。

确定是否存在自空间复用的一般规则如下。如我们一直所做的，假设各循环的下标和系数矩阵的各列顺序对应，其中最外层循环对应于第一列，最内层循环对应于最后一列。然后，为了确保存在空间复用，向量［0,0,…,0,1］必须在被截短的矩阵的零空间中。理由是如果这个向量在零空间中，那么当我们把除了最内层下标之外的所有下标都固定下来的时候，就知道在最内层循环的一次执行中所有的动态访问都只在最后的数组下标上取不同的值。如果数组是按行存放的，那么这些元素之间距离接近，有可能在同一高速缓存线中。

例11.26　请注意，［0,1］（转置为一个列向量）位于例11.25中的被截短矩阵的零空间中。因此，我们期望当把j当作内层循环下标时会出现空间局部性。另一方面，如果我们颠倒循环的顺序使得i成为内层循环，那么系数矩阵就变成

![528-2](../Images/image04911.jpeg)

现在，［0,1］就不在这个矩阵的零空间中了。相反地，零空间由基本向量［1,0］生成。因此，如我们在例11.25中所建议的，如果i是内层循环，我们不再期望这个循环具有空间局部性。

但是，我们应该观察到向量［0,0,…,0,1］在零空间里远不足以保证空间局部性。比如，假设该访问不是Z［1,i,2*i+j］而是Z［1,i,2*i+50*j］。那么在内层循环的一次运行中，Z的每50个元素只有一个元素会被访问，除非一个高速缓存线长到足以保存50个以上的元素，否则我们将无法复用一个高速缓存线。