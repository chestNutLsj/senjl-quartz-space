## 11.12　第11章总结

- 数组的并行性和局部性。对于并行性和基于局部性的优化而言，最重要的机会来自于访问数组的循环。在这些循环中，对数组元素的各个访问之间的依赖关系通常是有限的，并且通常按照一个正则的模式访问数组元素。这些因素使程序可以获得很好的数据局部性，高效使用缓存。
- 仿射访问。几乎所有的并行化及数据局部性优化的理论和技术都假设对数组的访问是仿射的：这些数组下标的表达式是循环下标的线性函数。
- 迭代空间：一个具有d个循环的循环嵌套结构定义了一个d维的迭代空间。该空间中的点都是值的d元组，元组中的值对应于该嵌套循环结构运行时各个循环下标的取值。在仿射情况下，各个循环下标的界限是较外层循环下标的线性函数，因此迭代空间是一个多面体。
- Fourier-Motzkin消除算法。对迭代空间的关键操作之一是把定义该空间的各个循环重新排列。这么做要求把一个多面体迭代空间投影到它的部分维度上。Fourier-Motzkin算法把一个给定变量的上下界替换成为关于这些界限的不等式。
- 数据依赖与数组访问。在为了并行性和局部性优化的目的而处理循环时，我们需要解决的一个中心问题是确定两个数组访问之间是否具有数据依赖关系（也就是它们是否可能触及同一个数组元素）。如果这些访问以及循环界限都是仿射的，迭代空间就可以被定义为一个多面体。而上面的问题可以被表示为一个特定的矩阵-向量方程是否具有位于该多面体中的解。
- 矩阵的秩和数据复用。用来描述一个数组访问的矩阵可以给出多个关于该数组访问的重要信息。如果该矩阵的秩达到最大值（即矩阵的行数和列数的最小值），那么当这个循环迭代运行时，数据访问不会两次触及同一个元素。如果数组是按行（列）存放的，那么删除掉最后（最前）一行后得到的矩阵的秩可以告诉我们这个访问是否具有良好的局部性，即单个高速缓存线中的元素被几乎同时访问。
- 数据依赖关系和丢番图方程。如果我们仅仅知道对同一数组的两个访问触及该数组的同一区域，我们并不能判定它们是否真的访问了某个公共元素。原因是每个访问都可能跳过某些元素。比如，一个访问读写偶数号元素，另一个访问读写奇数号元素。为了确定是否存在数据依赖关系，我们必须求一个丢番图方程（只要整数解）的解。
- 解丢番图线性方程。关键技术是计算各个变量的系数的最大公约数（GCD）。只有当这个最大公约数能够整除常量项时，方程才可能存在整数解。
- 空间分划约束。为了并行化一个循环嵌套结构的执行过程，我们需要把这个循环的迭代映射到一个处理器空间。这个处理器空间可能具有一个或多个维度。空间分划约束是说如果不同迭代中的两个访问之间具有数据依赖关系（即它们访问了同一个数据元素），那么它们必须被映射到同一个处理器上。只要这个从迭代到处理器的映射是仿射的，我们就可以把这个问题用矩阵-向量的方式表示出来。
- 基本代码转换。用来并行化具有仿射数组访问的程序的转换是七个基本转换的组合，它们是：循环融合、循环裂变、重新索引（给循环下标加上一个常量）、比例变换（将循环下标乘以一个常量）、反置（倒转一个循环的下标）、交换（交换循环的顺序）和倾斜（改写循环使得迭代空间中的扫描线不再和某个坐标轴同向）。
- 并行运算的同步。有时，如果我们在一个程序的步骤之间插入同步运算，就可以获得更多的并行性。比如，相邻的两个循环嵌套结构之间可能具有数据依赖关系，但是在这两个循环之间的同步运算可以使得各个循环被单独并行化。
- 流水线化。这个并行化技术允许处理器共享数据，方法是把某些数据（通常是数组元素）从一个处理器同步传递到处理器空间中的相邻的处理器。这个方法可以提高每个处理器所访问数据的局部性。
- 时间分划约束。为了找到流水线化的机会，我们要求出时间分划约束的解。这些约束是说只要两个数组访问会触及同一个数组元素，那么在此流水线中，首先发生的迭代中的访问所分配到的流水线阶段不得晚于第二个访问所分配的流水线阶段。
- 求解时间分划约束。Farkas引理提供了一个有力的求解技术。它可以找出一个带有数组访问的给定循环嵌套结构所允许的所有仿射时间分划映射。这个技术实质上是把原来的表达时间分划约束的线性不等式公式替换成为它的对偶系统。
- 分块。这个技术把一个循环嵌套结构中的每个循环都分割成为两个循环。这个技术的优点在于可以使得我们在一个多维数组的小段（块）上进行计算，每次处理一个块。这么做提高了程序的局部性，使处理单个块时需要的数据都在高速缓存中。
- 条状挖掘。和分块技术类似，这个技术只把一个循环嵌套结构中的一部分循环分解开，每个循环分成两个循环。这么做的好处是一个多维数组被一条一条地访问，从而得到最好的高速缓存利用率。