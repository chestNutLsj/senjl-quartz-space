### 11.7.8　源代码转换

我们已经看到如何根据各个语句的简单仿射分划得到和原来的源代码明显不同的程序。但是，至今为止看到的例子中都没有明确显示出仿射分划是如何与源代码层次上的改变联系起来的。本节将说明，通过把仿射变换分解成为一系列基本变换，我们可以相对容易地论证对源代码的修改。

七个基本仿射转换

每个仿射分划可以表示为一个由的基本仿射转换组成的序列。每个基本仿射转换对应于源代码层次上的一个简单改变。总共有七个基本仿射转换：前四个基本转换在图11-35中说明，后三个转换被称为幺模转换（unimodular transform），在图11-36中解释。

![553-1](../Images/image04967.jpeg)

图11-35　基本仿射转换（Ⅰ）

![554-1](../Images/image04968.jpeg)

图11-36　基本仿射转换（Ⅱ）

图中给出了每个基本转换的一个例子：一个源代码、一个仿射分划和一个结果代码。我们也画出了转换之前和之后的代码中的数据依赖关系。在数据依赖关系图中，我们看到每个基本转换对应于一个简单的几何转换，对应于一个简单的代码转换。这七个基本转换为：

1）融合（fusion）。融合转换的特点是把原程序中的多个循环下标映射到同一个循环下标上。新的循环融合了来自不同循环的语句。

2）裂变（fission）。裂变转换是融合的逆向转换。它把不同语句的同一个循环下标映射到转换得到的代码中的不同循环下标。这个转换把原来的一个循环分解为多个循环。

3）重新索引（re-indexing）。重新索引技术把一个语句的动态执行偏移固定多个迭代。这个仿射变换有一个常量项。

4）比例变换（scaling）。源程序中的连续迭代被一个常量因子隔开。这个仿射变换具有一个正的非单元系数。

5）反置（reversal）。按照相反顺序执行循环中的迭代。反置转换的特点是有一个系数为-1。

6）交换（permutation）。交换内层循环和外层循环。这个仿射变换由单位矩阵中的经过交换的各行组成。

7）倾斜（skewing）。沿着一个角度来遍历循环的迭代空间。这个仿射变换是一个幺模矩阵，其对角线上都是1。

幺模转换

一个幺模转换仅由一个幺模系数矩阵组成，没有常量向量。幺模矩阵是一个正方形矩阵，其行列式为±1。幺模转换的重要性在于它把一个n维迭代空间映射到另一个n维的多面体，并且两个空间之间的迭代具有一一对应关系。

并行化的几何解释

在上面的例子中，除裂变之外，其他的仿射转换都是通过把无同步仿射分划算法应用到各自的源代码上而得到的。（下一节中将讨论如何把裂变转换应用于带有同步的代码的并行化。）在每一个例子中，生成的代码有一个（最外层的）可并行化循环，这个循环的各个迭代可以分配给不同的处理器，并且不需要同步。

这些例子说明可以使用几何学的方法来简单地解释并行化技术是如何工作的。依赖边总是从一个较早的实例指向较晚的实例。因此，嵌套在不同循环中的不同语句之间的依赖关系遵循程序文本中的顺序；嵌套在同一循环中的语句之间的依赖关系遵循词典顺序。从几何学角度讲，一个二维循环嵌套结构的依赖关系总是在［0°,180°）的范围之内，也就是说这些依赖关系的角度必然低于180°，但是不小于0°。

仿射转换改变了迭代的顺序，使得只有最外层循环的同一迭代之内的运算之间才有依赖关系。换句话说，在最外层循环的迭代边界上没有依赖边。在对简单的源代码进行并行化时，我们可以画出它们的依赖关系，并用几何方法找出这样的转换。