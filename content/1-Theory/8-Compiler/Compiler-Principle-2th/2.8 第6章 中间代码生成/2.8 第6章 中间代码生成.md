   

# 第6章　中间代码生成

在编译器的分析-综合模型中，前端对源程序进行分析并产生中间表示，后端在此基础上生成目标代码。理想情况下，和源语言相关的细节在前端分析中处理，而关于目标机器的细节则在后端处理。基于一个适当定义的中间表示形式，可以把针对源语言i的前端和针对目标机器j的后端组合起来，构造得到源语言i在目标机器j上的一个编译器。这种创建编译器组合的方法可以大大减少工作量：只要写出m种前端和n种后端处理程序，就可以得到m×n种编译程序。

本章的内容涉及中间代码表示、静态类型检查和中间代码生成。为简单起见，我们假设一个编译程序的前端处理按照图6-1所示方式进行组织，顺序地进行语法分析、静态检查和中间代码生成。有时候这几个过程也可以组合起来，在语法分析中一并完成。我们将使用第2章和第5章中的语法制导定义来描述类型检查和翻译过程。大部分的翻译方案可以基于第5章中给出的自顶向下或自底向上的语法分析技术来实现。所有的方案都可以通过生成并遍历抽象语法树来实现。

![244-1](../Images/image04375.jpeg)

图6-1　一个编译器前端的逻辑结构

静态检查包括类型检查（type checking），类型检查保证运算符被应用到兼容的运算分量。静态检查还包括在语法分析之后进行的所有语法检查。例如，静态检查保证了C语言中的一条break指令必然位于一个while/for/switch语句之内。如果不存在这样的语句，静态检查将报告一个错误。

本章介绍的方法可以用于多种中间表示，包括抽象语法树和三地址代码。这两种中间表示方法都在2.8节中介绍过。之所以名为“三地址代码”，是因为这些指令的一般形式x=y op z具有三个地址：两个运算分量y和z，一个结果变量x。

在将给定源语言的一个程序翻译成特定的目标机器代码的过程中，一个编译器可能构造出一系列中间表示，如图6-2所示。高层的表示接近于源语言，而低层的表示接近于目标机器。语法树是高层的表示，它刻画了源程序的自然的层次性结构，并且适用于静态类型检查这样的处理。

![244-2](../Images/image04376.jpeg)

图6-2　编译器可能使用一系列的中间表示

低层的表示形式适用于机器相关的处理任务，比如寄存器分配、指令选择等。通过选择不同的运算符，三地址代码既可以是高层的表示方式，也可以是低层的表示方式。在6.2.3节将看到，对表达式而言，语法树和三地址代码只是在表面上有所不同。对于循环语句，语法树表示了语句的各个组成部分，而三地址代码包含标号和跳转指令，用来表示目标语言的控制流。

不同的编译器对中间表示的选择和设计各有不同。中间表示可以是一种真正的语言，也可以由编译器的各个处理阶段共享的多个内部数据结构组成。C语言是一种程序设计语言。它具有很好的灵活性和通用性，可以很方便地把C程序编译成高效的机器代码，并且有很多C的编译器可用，因此C语言也常常被用作中间表示。早期的C++编译器的前端生成C代码，而把C编译器作为其后端。