### 6.8.2　switch语句的语法制导翻译

图6-49中的中间代码是图6-48中的switch语句的一个近似翻译结果。所有的测试都出现在代码的末端，因此一个简单的代码生成器就可以识别出多路分支，并使用本节开始时介绍的多种实现方法中最合适的实现方法来生成高效的代码。

![285-1](../Images/image04461.jpeg)

图6-49　一个switch语句的翻译结果

图6-50中显示的是一个更直接的代码序列。它要求编译器进行更加深入的分析，才能找到最高效的实现。值得注意的是，在一趟式编译器中，将分支语句放在开始的位置会造成不便，因为编译器此时还没有碰到各个语句Si，无法生成转向各个语句的代码。

![285-2](../Images/image04462.jpeg)

图6-50　一个switch语句的另一种翻译

为了翻译成如图6-49所示的形式，当我们看到关键字switch的时候，我们生成两个新标号`test`和`next`以及一个临时变量t。然后，当我们对表达式E进行语法分析的时候，生成计算E值并将其保存到t的代码。处理完E之后，产生跳转指令`goto test`。

当我们看见各个case关键字时，就创建一个新的标号Li，并将其加入符号表。我们将在一个仅用于存放case分支的队列中放入一个值-标号对。这个值-标号对由常量值Vi和Li（或者是指向符号表中Li的条目的指针）组成。我们逐个处理语句case Vi：Si，生成附加于Si的代码上的标号Li。最后生成跳转指令`goto next`。

当编译器到达switch语句的末端时，我们已经可以生成n路分支的代码了。读取值-标号对的队列，我们就可以生成形如图6-51所示的三地址语句序列。其中t是一个保存选择表达式E的值的临时变量，Ln为默认语句的标号。

![285-3](../Images/image04463.jpeg)

图6-51　用来翻译switch语句的case三地址代码指令

指令`case t` Vi Li和图6-49中的`if t`=Vi `goto` Li含义相同，但是`case`指令更加容易被最终的代码生成器探测到，从而对这些指令进行某种特殊处理。在代码生成阶段，根据分支的个数以及这些值是否在一个较小的范围内，这些`case`语句的序列可以被翻译成最高效的n路分支。