### 6.1.2　构造DAG的值编码方法

语法树或DAG图中的结点通常存放在一个记录数组中，如图6-6所示。数组的每一行表示一个记录，也就是一个结点。在每个记录中，第一个字段是一个运算符代码，也是该结点的标号。在图6-6b中，各个叶子结点还有一个附加的字段，它存放了标识符的词法值（在这里，它是一个指向符号表的指针或一个常量）。内部结点则有两个附加的字段，分别指明其左右子结点。

![246-2](../Images/image04381.jpeg)

图6-6　i=i+10的DAG的结点在数组中的表示

在这个数组中，我们只需要给出一个结点对应的记录在此数组中的整数下标就可以引用该结点。在历史上，这个整数称为相应结点或该结点所表示的表达式的值编码（value number）。例如，在图6-6中，标号为“+”的结点的值编码为3，其左右子结点的值编码分别为1和2。在实践中，我们可以用记录指针或对象引用来代替整数下标，但是我们仍然把一个结点的引用称为该结点的“值编码”。如果使用适当的数据结构，值编码可以帮助我们高效地构造出表达式的DAG。下一个算法将给出构造的方法。

假定结点按照如图6-6所示的方式存放在一个数组中，每个结点通过其值编码引用。设每个内部结点的范型为三元组<op，l，r>，其中op是标号，l是其左子结点对应的值编码，r是其右子结点对应的值编码。假设单目运算符对应的结点有r=0。

算法6.3　构造DAG的结点的值编码方法。

输入：标号op、结点l和结点r。

输出：数组中具有三元组<op，l，r>形式的结点的值编码。

方法：在数组中搜索标号为op、左子结点为l且右子结点为r的结点M。如果存在这样的结点，则返回M结点的值编码。若不存在这样的结点，则在数组中添加一个结点N，其标号为op，左右子结点分别为l和r，返回新建结点对应的值编码。

虽然算法6.3可以产生我们期待的输出结果，但是每次定位一个结点时都要搜索整个数组，这个开销是很大的，当数组中存放了整个程序的所有表达式时尤其如此。更高效的方法是使用散列表，将结点放入若干“桶”中，每个桶通常只包含少量结点。散列表是能够高效支持词典（dictionary）功能的少数几个数据结构之一[^1]。词典是一种抽象的数据类型，它可以插入或删除一个集合中的元素，可以确定一个给定元素当前是否在集合中。类似于散列表这样为词典设计的优秀数据结构可以在常数或接近常数的时间内完成上述的操作，所需时间和集合的大小无关。

要给DAG中的结点构造散列表，首先需要建立散列函数（hash function）h。这个函数为形如<op，l，r>的三元组计算“桶”的索引。它通过计算索引把三元组分配到各个桶中，并使得不大可能存在某个“桶”的元组数量大大超过平均数很多。通过对op、l、r的计算，可以确定地得到桶索引h（op，l，r）。因而我们可以多次重复这个计算过程，总是得到结点<op，l，r>的相同的桶索引。

桶可以通过链表来实现，如图6-7所示。一个由散列值索引的数组保存桶的头（bucket header）。每个头指向列表中的第一个单元。在一个桶的链表中，链表的各个单元记录了某个被散列函数分配到此桶中的某个结点的值编码。也就是说，在以数组的第h（op，l，r）个元素为头的链表中可以找到结点<op，l，r>。

![247-1](../Images/image04382.jpeg)

图6-7　用于搜索桶的数据结构

因此，给定一个输入结点（op，l，r），我们首先计算桶索引h（op，l，r），然后在该桶的单元中搜索这个结点。通常情况下有足够多的桶，因此链表中不会有很多单元。然而，我们必须查看一个桶中的所有单元，并且对于每一个单元中的值编码v，我们必须检查输入结点的三元组<op，l，r>是否和单元列表中值编码为v的结点相匹配（如图6-7所示）。如果我们找到了匹配的结点，就返回v。如果没有找到匹配的结点，我们知道其他桶中也不会有这样的结点。因此，我们就创建一个新的单元，添加到“桶”索引为h（op，l，r）的单元链表中，并返回新建结点对应的值编码。