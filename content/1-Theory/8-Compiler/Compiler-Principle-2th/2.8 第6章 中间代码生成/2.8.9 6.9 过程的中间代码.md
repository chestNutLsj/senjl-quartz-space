## 6.9　过程的中间代码

过程及其实现将在第7章中与运行时刻的变量存储管理一并详细地讨论。本节我们使用术语“函数”来表示带有返回值的过程。我们将简单讨论函数声明以及函数调用的三地址代码。在三地址代码中，函数调用被拆分为准备进行调用时的参数求值，然后是调用本身。为简单起见，我们假定参数使用值传递的方式。1.6.6节中曾讨论过参数传递方法。

例6.25　假定a是一个整数数组，并且f是一个从整数到整数的函数。那么赋值语句

`n=f（a［i］）；`

可以被翻译成如下的三地址代码。

![286-1](../Images/image04464.jpeg)

如6.4节中讨论的，前两行计算表达式`a［i］`的值，并将结果存放到临时变量`t2`中。第3行将`t2`作为实在参数用于第4行中对f的调用。这个调用只带有一个参数。第4行中函数调用的返回值被赋给`t3`。第5行将返回值赋给`n`。

图6-52中的产生式可以生成函数定义和函数调用。（这个文法会在最后一个参数之后生成一个不必要的逗号，但是它已经足以说明翻译的方法了。）如6.3节所述，非终结符号D和T分别生成声明和类型。由D生成的函数定义包含了关键字define、返回类型、函数名、括号中的形式参数以及由一个位于花括号中的语句组成的函数体。非终结符号F生成0个或多个形式参数，每个形式参数包括一个类型和一个标识符。非终结符号S和E分别生成语句和表达式。S的产生式增加了一条返回表达式值的语句。E的产生式中增加了函数调用，调用中的实在参数由A生成。一个实在参数就是一个表达式。

![286-2](../Images/image04465.jpeg)

图6-52　在源语言中加入函数

函数定义和函数调用可以用本章中已经介绍过的概念进行翻译。

- 函数类型。一个函数类型必须包含它的返回值类型和形式参数类型。令void是一个表示没有参数或没有返回值的特殊类型。因此，返回一个整数的函数pop()的类型是“从void到integer的函数”。函数类型可以在返回值类型和有序的参数类型列表上应用构造算子fun来表示。
- 符号表。设编译器处理到一个函数定义时，最上层的符号表为s。函数名被放入s，以便在程序的其他部分使用。函数的形式参数可以用类似于记录字段名的方式来处理（见图6-18）。在D的产生式中，在看到关键字define和函数名之后，我们将s压栈并建立新的符号表

![287-1](../Images/image04466.jpeg)

这个新符号表被称为t。注意，top被作为参数传递到new Env（top），因此新的符号表t可以被链接到先前的符号表s。新的符号表t用于这个函数的函数体的翻译。在这个函数体被翻译完成之后，我们恢复到先前的符号表s。

- 类型检查。在表达式中，一个函数和运算符的处理方法相同。因此在6.5.2节中讨论的类型检查规则（包括自动类型转换）仍然可用。例如，如果f是一个带有一个实数型参数的函数，那么在函数调用f（2）时，整数2将被转换成实型数。
- 函数调用。当为一个函数调用id（E，E，…，E）生成三地址指令的时候，只需要生成对各个参数E求值的三地址指令，或者生成将各个参数E归约为地址的三地址指令，然后再为每个参数生成一条`param`指令即可。如果我们不愿将参数计算指令和`param`指令混在一起，可以将每个表达式E的属性E.addr存放到一个数据结构（比如队列）中。一旦所有的表达式都翻译完成，我们就可以在清空队列的同时生成`param`指令。

过程是程序设计语言中重要且常用的编程结构，因此编译器必须为过程调用和返回生成良好的代码。用于处理过程的参数传递、调用和返回的运行时刻例程是运行时刻支持系统的一部分。运行时刻支持机制将在第7章中讨论。