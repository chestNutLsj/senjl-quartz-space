### 6.5.5　一个合一算法

非正式地讲，合一就是判断能否通过将两个表达式s和t中的变量替换为某些表达式，使得s和t相同。测试表达式是否等价是合一的一个特殊情况。如果s和t中只有常量没有变量，则s和t合一当且仅当它们完全相同。本节中的合一算法可以处理含有环的图，因此它可以用于测试循环类型的结构等价性[^7]。

我们将实现一种基于图论表示方法的合一算法，其中类型被表示成图的形式。类型变量用叶子结点表示，类型构造算子用内部结点表示。结点被分成若干的等价类。如果两个结点在同一个等价类中，那么它们代表的类型表达式就必须合一。因此，同一个等价类中的内部结点必须具有同样的类型构造算子，且它们的对应子结点必须等价。

例6.18　考虑下列两个类型表达式

（（α1→α2）×list（α3））→list（α2）

（（α3→α4）×list（α3））→α5

下列的置换S是这两个表达式的最一般化的合一替换：

![269-1](../Images/image04426.jpeg)

这个置换将上述两个类型表达式映射成如下的表达式

（（α1→α2）×list（α1））→list（α2）

这两个表达式被表示为图6-31中标号为→：1的两个结点。结点上的整数编号指明了在编号为1的结点被合一后，各个结点所属的等价类的编号。

![269-2](../Images/image04427.jpeg)

图6-31　合一后的等价类

算法6.19　类型图中的一对结点的合一处理。

输入：一个表示类型的图，以及需要进行合一处理的结点对m和n。

输出：如果结点m和n表示的表达式可以合一，返回布尔值true。反之，返回false。

方法：结点用一个记录实现，记录中的字段用于存放一个二元运算符和分别指向其左右子结点的指针。字段set用于保存等价结点的集合。每个等价类都有一个结点被选作这个类的唯一代表，它的set字段包含一个空指针。等价类中其他结点的set字段（可能通过该集合中的其他结点间接地）指向该等价类的代表结点。在初始时刻，每个结点n自身组成一个等价类，n是它自己的代表结点。

如图6-32所示的合一算法在结点上进行如下两种操作：

![270-1](../Images/image04428.jpeg)

图6-32　合一算法

- find（n）返回当前包含结点n的等价类的代表结点。
- union（m，n）将包含结点m和n的等价类合并。如果m和n所对应的等价类的代表结点中有一个是非变量的结点，则union将这个非变量结点作为合并后的等价类的代表结点；否则，union把任意一个原代表结点作为新的代表结点。这种在union的规约中的非对称性非常重要，因为如果一个等价类对应于一个带有类型构造算子的类型表达式或基本类型，我们就不能用一个变量作为该等价类的代表。否则，两个不等价的表达式可能会通过该变量被合一。

集合的union操作的实现很简单，只需要改变一个等价类的代表结点的set字段，使之指向另一个等价类的代表结点即可。为了找到一个结点所属的等价类，我们沿着各个结点的set字段中的指针前进，直到到达代表结点（即set字段指针为空指针的结点）为止。

请注意，图6-32中的算法分别使用s=find（m）和t=find（n），而不是直接使用m和n。如果m和n在同一个等价类中，那么代表结点s和t相等。如果s和t表示相同的基本类型，则调用unify（m，n）返回true。如果s和t都是代表某个二目类型构造算子的内部结点，那么我们尝试合并它们的等价类，并递归地检查它们的各个子结点是否等价。因为首先进行合并操作，我们在递归检查子结点之前减少了等价类的个数，因此算法终止。

将一个变量置换为一个表达式的实现方法如下：把代表该变量的叶子结点加入到代表该表达式的结点所在的等价类中。假设m或n表示一个变量的叶子结点，同时假设这个结点已经放入满足下面条件的等价类中，即这个等价类中的一个结点代表的表达式或者带有一个类型构造算子，或者是一个基本类型。那么，find将会返回一个反映该类型构造算子或基本类型的代表结点，使一个变量不会和两个不同的表达式合一。

例6.20　假设例6.18中的两个表达式可以用图6-33中的两个初始图表示，图中的每个结点所在的等价类仅仅包含该结点。当应用算法6.19来计算unify（1，9）时，注意到结点1和9表示同一个运算符。因此将结点1和9合并成同一个等价类，并调用unify（2，10）和unify（8，14）。执行unify（1，9）得到的结果就是前面在图6-31中显示的图。

![271-1](../Images/image04429.jpeg)

图6-33　初始图，其中的每个结点在只包含该结点自身的等价类中

如果算法6.19返回true，我们可以按照如下方法构造出一个置换S作为合一替换。对于每个变量α，find（α）给出α的等价类的代表结点n。n所表示的表达式为S（α）。例如，在图6-31中，我们看到α3的代表结点为4，这个结点表示α1。结点8是α5的代表结点，这个结点表示list（α2）。置换S的结果如例6.18所示。