### 5.1.2　在语法分析树的结点上对SDD求值

在语法分析树上进行求值有助于将SDD所描述的翻译方案可视化，虽然翻译器实际上不需要构建语法分析树。因此，我们想象一下在应用一个SDD的规则之前首先构造出一棵语法分析树，然后再使用这些规则对这棵语法分析树上的各个结点上的所有属性进行求值。一个显示了它的各个属性的值的语法分析树称为注释语法分析树（annotated parse tree）。

我们如何构造一棵注释语法分析树呢？我们按照什么顺序来计算各个属性？在我们对一棵语法分析树的某个结点的一个属性进行求值之前，必须首先求出这个属性值所依赖的所有属性值。比如，如例5.1所示，所有的属性都是综合属性，那么在我们对一个结点上的val属性求值之前，必须求出该结点的所有子结点的属性val的值。

对于综合属性，我们可以按照任何自底向上的顺序计算它们的值，比如对语法分析树进行后序遍历的顺序。对于S属性定义的求值将在5.2.3节中讨论。

对于同时具有继承属性和综合属性的SDD，不能保证有一个顺序来对各结点上的属性进行求值。比如，考虑非终结符号A和B，它们分别具有综合属性A.s和继承属性B.i。同时它们的产生式和规则如下：

![211-1](../Images/image04302.jpeg)

这些规则是循环定义的。不可能首先求出结点N上的A.s或N的子结点上的B.i中的一个的值，然后再求出另一个的值。一棵语法分析树的某个结点对上的A.s和B.i之间的循环依赖关系如图5-2所示。

![211-2](../Images/image04303.jpeg)

图5-2　A.s和B.i之间的循环依赖

从计算的角度看，给定一个SDD，很难确定是否存在某棵语法分析树使得SDD的属性值之间具有循环依赖关系[^1]。幸运的是，存在一个SDD的有用子类，它们能够保证对每棵语法分析树都存在一个求值顺序。我们将在5.2节中介绍这类SDD。

例5.2　 图5-3显示了一个对应于输入串3*5+4n的注释语法分析树，该分析树是利用图5-1的文法和规则构造得到的。我们假定lexval的值由词法分析器提供。对应于非终结符号的每个结点都有一个按自底向上顺序计算得到的val属性。在图中我们可以看到每个结点都关联了一个结果值。比如，在图中结点*的父结点上，当计算得到它的第一和第三个子结点上的T.val=3和F.val=5之后，我们应用了相应的规则，指明T.val就是这两个值的乘积，即15。

当一棵语法分析树的结构和源代码的抽象语法不“匹配”时，继承属性是很有用的。因为文法不是为了翻译而定义的，而是以语法分析为目的进行定义的，因此可能会产生这种不匹配的情况。下面的例子显示了如何使用继承属性来解决这个问题。

![212-1](../Images/image04304.jpeg)

图5-3　3*5+4n的注释语法分析树

例5.3　图5-4中的SDD计算诸如3*5和3*5*7这样的项。处理输入3*5的自顶向下语法分析过程首先使用了产生式T→FT′。这里，F生成了数位3，但是运算符*由T’生成。因此，左运算分量3和运算符*位于不同的子树中。我们将使用一个继承属性来把这个运算分量传递给运算符*。

![212-2](../Images/image04305.jpeg)

图5-4　一个基于适用于自顶向下语法分析的文法的SDD

这个例子中的文法摘自常见的表达式文法的无左递归版本，我们在4.4节中使用这个文法作为说明自顶向下语法分析的例子。

非终结符号T和F各自有一个综合属性val，终结符号digit有一个综合属性lexval。非终结符号T′具有两个属性：继承属性inh和综合属性syn。

这些语义规则基于如下思想：运算符*的左运算分量是通过继承得到的。更准确地说，产生式T′→* ![212-3](../Images/image04306.jpeg)的头T′继承了产生式体中*的左运算分量。给定一个项x*y*z，对应于*y*z的子树的根结点继承了x的值。对应于*z的子树的根结点继承了x*y的值。如果项中还有更多的因子，我们可以继续这样的处理过程。当所有的因子都处理完毕后，这个结果就通过综合属性向上传递到树的根部。

为了了解如何使用这些语义规则，考虑图5-5中对应于3*5的注释语法分析树。这棵语法分析树中最左边的标号为digit的叶子结点具有属性值lexval=3，其中的3是由词法分析器提供的。它的父结点对应于产生式4，即F→digit。和这个产生式相关的唯一语义规则定义F.val=digit.lexval，等于3。

![213-1](../Images/image04307.jpeg)

图5-5　3*5的注释语法分析树

在根结点的第二个子结点上，继承属性T′.inh根据和产生式1关联的语义规则T′.inh=F.val定义。因此，运算符*的左运算分量3从根结点的左子结点传递到右子结点。

对应于T′的结点的产生式是![213-2](../Images/image04308.jpeg)。（我们保留了注释语法分析树中的下标1，以区分树中的两个T′结点。）继承属性![213-3](../Images/image04309.jpeg)是由语义规则![213-4](../Images/image04310.jpeg)定义的，这个规则和产生式2相关联。

已知T′.inh=3且F.val=5，我们得到![213-6](../Images/image04311.jpeg)。在层次较低的![213-8](../Images/image04312.jpeg)结点上的产生式是T′→∈。相应的语义规则T′.syn = T′.inh定义了![213-7](../Images/image04313.jpeg)。各个T′结点上的属性syn将值15沿着树向上传递到T结点，使得T.val = 15。