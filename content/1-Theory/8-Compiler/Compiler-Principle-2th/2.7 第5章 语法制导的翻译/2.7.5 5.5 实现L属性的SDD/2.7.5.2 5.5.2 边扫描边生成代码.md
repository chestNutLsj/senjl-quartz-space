### 5.5.2　边扫描边生成代码

如例5.20所示，使用属性来表示代码并构造出很长的串不能满足我们的要求，原因是多方面的，比如拷贝和移动这些串字符时需要很长的时间。在通常情况下，比如在我们的代码生成例子中，我们可以通过执行一个SDT中的语义动作，逐步把各个代码片段添加到一个数组或输出文件中。要保证这项技术能够正确应用，下列要素必不可少：

1）存在一个（一个或多个非终结符号的）主属性。为方便起见，我们假设主属性都以字符串为值。在例5.20中，属性S.code和C.code是主属性，而其他属性不是主属性。

2）主属性是综合属性。

3）对主属性求值的规则保证：

① 主属性是将相关产生式体中的非终结符号的主属性值连接起来得到的。连接时也可能包括其他非主属性的元素，比如字符串label和标号L1及L2的值。

② 各个非终结符号的主属性值在连接运算中出现的顺序和这些非终结符号在产生式体中的出现顺序相同。

上面这些条件使得我们在构造主属性时只需要在适当的时候发出这个连接运算中的非主属性元素。我们可以依靠对一个产生式体中的非终结符号的对应函数的递归调用，以增量方式生成它们的主属性。

例5.22　我们可以修改图5-29中的函数，使得它生成主属性S.code的各个元素，而不是把它们保存起来，再连接得到S.code的一个返回值。经过修改的函数S显示在图5-31中。

![234-1](../Images/image04360.jpeg)

图5-31　while语句的on-the-fly的递归下降代码生成

在图5-31中，S和C现在不返回任何值，因为它们唯一的综合属性是通过打印生成的。而且这些打印语句的位置很重要。打印输出的顺序是：首先是`label` L1，然后是C的代码（它和图5-29中的Ccode的值相同），然后是`label` L2，最后是对S的递归调用所生成的代码（它和图5-29中的Scode的值相同）。这样，对S的一次调用所打印的代码和图5-29中返回的Scode的值相同。

主属性的类型

我们的简单假设要求主属性具有字符串属性，这个限制实际上太严格了。真实要求是所有主属性的类型的值必须能够通过连接各个元素而构造得到。比如，任何类型的对象列表也可以作为主属性的类型，只要这些列表的表示方法允许我们把元素高效地加入到列表的尾部。因此，如果主属性的目的是表示一个中间代码语句的序列，我们就可以在一个对象数组的尾部不断写入语句，最终生成中间代码。当然，这个列表还需要满足5.5.2节中给出的其他要求。比如，一个主属性值必须由其他主属性值按照非终结符号的顺序连接得到。

我们附带地对基础SDT进行相同的修改：将一个主属性的构造转变为发出这个属性的元素的语义动作。在图5-32中，我们可以看到图5-28的SDT被修改成边扫描边生成代码的SDT。

![235-1](../Images/image04361.jpeg)

图5-32　边扫描边生成while语句的代码的SDT