### 5.3.1　抽象语法树的构造

2.8.2节讨论过，一棵语法树中的每个结点代表一个程序构造，这个结点的子结点代表这个构造的有意义的组成部分。表示表达式E1+E2的语法树结点的标号为+，且两个子结点分别代表子表达式E1和E2。

我们将使用具有适当数量的字段的对象来实现一棵语法树的各个结点。每个对象将有一个op字段，也就是这个结点的标号。这些对象将具有如下所述的其他字段：

- 如果结点是一个叶子，那么对象将有一个附加的域来存放这个叶子结点的词法值。构造函数Leaf（op，val）创建一个叶子对象。我们也可以把结点看作记录，那么Leaf就会返回一个指向与叶子结点对应的新记录的指针。
- 如果结点是内部结点，那么它的附加字段的个数和该结点在语法树中的子结点个数相同。构造函数Node带有两个或多个参数：Node（op，c1，c2，…，ck），该函数创建一个对象，第一个字段的值为op，其余k个字段的值为c1，…，ck。

例5.11　图5-10中的S属性定义为一个简单的表达式文法构造出语法树。这个文法只包含二目运算符+和-。通常，这两个运算符具有相同的优先级，并且都是左结合的。所有的非终结符号都有一个综合属性node，该属性表示相应的抽象语法树结点。

每当使用第一个产生式E→E1+T时，它的语义规则就创建出一个结点。创建时使用“+”作为op，使用E1.node和T.node作为代表子表达式的两个子结点。第二个产生式也有类似的规则。

![219-1](../Images/image04324.jpeg)

图5-10　为简单表达式构造语法树

产生式3，即E→T，没有创建任何结点，因为E.node和T.node是一样的。类似地，产生式4，即T→（E），也没有创建任何结点。T.node的值和E.node的值相同，因为括号仅仅用于分组。它们会影响语法分析树和抽象语法树的结构，但是一旦分组完成，就不需要在抽象语法树中保留这些括号了。

最后两个T-产生式的右部是一个终结符号。我们使用构造函数Leaf来创建合适的结点。这些结点就成为T.node的值。

图5-11显示了为输入a-4+c构造一棵抽象语法树的过程。这棵抽象语法树的结点被显示为记录。这些记录的第一个字段是op。现在，抽象语法树的边用实线表示。基础的语法分析树使用点虚线表示边。实际上不需要生成语法分析树。第三种线是虚线，它表示E.node和T.node的值。每条线都指向适当的抽象语法树结点。

![219-2](../Images/image04325.jpeg)

图5-11　a-4+c的抽象语法树

在最底端，我们可以看到由Leaf构造得到的分别表示a、4和c的叶子结点。我们假设词法值id.entry指向符号表，并且词法值num.val是一个常量值。根据规则5和6，这些叶子结点，或指向它们的指针，变成了图中的三个标号为T的语法分析树结点上的T.node的值。请注意，根据规则3，指向a对应的叶子结点的指针同时也是语法分析树中最左边的E的E.node值。

我们根据规则2创建了一个结点，该结点的op字段等于减号，它的指针指向前两个叶子结点。然后，规则1将对应于-的结点和第三个叶子组合起来，得到这个抽象语法树的根结点。

如果这些规则是在对语法分析树的后序遍历过程中求值的，或者是在自底向上分析过程中和归约动作一起进行求值的，那么当图5-12中显示的一系列步骤结束时，p5指向构造得到的抽象语法树的根结点。

![220-1](../Images/image04326.jpeg)

图5-12　a-4+c的抽象语法树的构造步骤

如果使用一个为自顶向下语法分析而设计的文法，那么得到的抽象语法树仍然相同，其构造的步骤也相同，虽然语法分析树的结构和抽象语法树的结构有极大的不同。

例5.12　图5-13中的L属性定义完成的翻译工作和图5-10中的S属性定义所完成工作的相同。文法符号E、T、id和num的属性和例5-11中讨论的相同。

![220-2](../Images/image04327.jpeg)

图5-13　在自顶向下语法分析过程中构造抽象语法树

这个例子中构造抽象语法树的规则和例5.3中桌上计算器的规则类似。在桌上计算器的例子中，项x*y中的x和*y位于语法分析树的不同部分，因此在计算x*y时x是作为继承属性传递的。这里的思想是在构造x+y的抽象语法树时将x作为一个继承属性传递，因为x和+y出现在不同的子树中。非终结符号E′对应于例5.3中的非终结符号T′。请比较一下图5-14中a-4+c的依赖图和图5-7中3*4的依赖图的相似之处。

非终结符号E′有一个继承属性inh和一个综合属性syn。属性E′.inh表示至今为止构造得到的部分抽象语法树。明确地说，它表示的是位于E′的子树左边的输入串前缀所对应的抽象语法树的根。在图5-14中依赖图的结点5处，E′.inh表示对应于a的抽象语法树的根，实际上就是对应于a的叶子结点。在结点6处，E′.inh表示对应于输入a-4的部分抽象语法树的根。在结点9处，E′.inh表示a-4+c的抽象语法树。

![220-3](../Images/image04328.jpeg)

图5-14　使用图5-13中的SDD时的a-4+c的依赖图

因为没有更多的输入，所以在结点9处，E′.inh指向整个抽象语法树的根。属性syn把这个值沿着语法分析树向上传递，直到它成为E.node的值。明确地讲，结点10上的属性值是通过产生式E′→∈所关联的规则E′.syn = E′.inh来定义的。在结点11处的属性值是通过图5-13中与产生式2相关的规则![221-4](../Images/image04329.jpeg)来定义的。类似的规则还定义了结点12和13处的值。