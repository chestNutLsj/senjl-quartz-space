## 红黑树
### 高度与深度问题

- 黑深度
	- 除去（子）树根节点本身，沿途所经黑节点的总数（包括外部节点）
	- 根节点黑深度为 0
- 黑高度
	- 除去外部节点，沿途所经黑节点的总数
	- 外部节点黑高度为 0
	- 根的黑高度称为全（子）树的黑高度，在数值上与外部节点的黑深度相等

1. 给出 n 个关键码的红黑树的**黑高度**的关系式。

> 红黑树可以视作 (2,4)-树，其中每个黑节点都是 (2,4)-树的一个超级节点，单独的一个黑节点也能满足 (2,4)-树的节点内关键码的数量要求，因此红节点并不是必须的。
> 
> 从这个意义上考虑，
> - 红黑树最大黑高度就是在 (2,4)-树中，每个节点只有 1 个关键码（即那个黑节点），此时黑高度为 $\lfloor\log_{2} \frac{n+1}{2}\rfloor+1$ 
> - 红黑树的最小黑高度就是在 (2,4)-树中，每个节点有 3 个关键码（1 黑，2 红），此时黑高度为 $\lceil\log_{4} (n+1)\rceil$ 

2. 给出全树的**高度**关系式。

> - 红黑树最小高度就是完全平衡的完全二叉树，此时高度自然就是 $\lceil\log_{2}n\rceil$ 
> - 红黑树的最大高度比较复杂，直接记结论：$h_{max} = max\left( 2\cdot(\lfloor\log_{2}(n + 2)\rfloor - 1), 2\cdot\lfloor\log_{2}\left( \frac{n+2}{3} \right)\rfloor + 1 \right)$ 至于证明方法，需要对树高 h 分偶数、奇数情况考虑，分别对应 max 中的第一个参数和第二个参数。更进一步地，最大高度也要求大多数节点都只有一个黑色节点（做关键码），只有代表最大树高的那一条链才有 2 个关键码（1 黑 1 红）。示意图如下：
> 	- ![[61B-Exercise-8-13.png]]
> 	- ![[61B-Exercise-8-13-d.png]]

3. 判断：红黑树上所有节点，其黑深度与黑高度之和相同。

> ❌
> 显然，这里需要注意到红节点和黑节点的差异：
> - 黑节点的黑高度取决于其通往外部节点的通路上有多少个黑节点，并且不将自身计入数量中，黑深度取决于其通往根的通路上有多少个黑节点，同样不将自身计入计数中，因此其黑深度与黑高度之和相当于根到外部节点的通路上黑节点的总数-1；
> - 红节点的黑高度和黑深度定义与上述相同，但要注意，即使不将自身计入计数中，它自己作为红节点对通路上的黑节点数是没有贡献的，因此黑深度与黑高度之和相当于根到外部节点上黑节点的总数；
> 
> ![[Important-and-hard-problems-red-black-tree.png]]
> 以上图为例，
> - 节点 11 的黑高度为 1，黑深度为 1，和为 2，而根到外部节点的通路上黑节点总数是 3；
> - 而节点 8 的黑高度是 2，黑深度是 1，和为 3，恰好等于根到外部节点通路上的黑节点总数。

### 旋转与染色次数问题

- 看到这里，背诵一遍 [[61-Balanced-BST#红黑树插入|双红修正、双黑修正]] 的具体操作。

1. 判断：若红黑树的删除操作导致了 $\Omega(\log n)$ 次重染色操作，则必然有至少一次旋转。

> ❌ 
> 注意，
> - 需要旋转的操作只有 BB-1 和 BB-3，且 BB-3 旋转后必然到达 BB-2R 或 BB-1 的情况。
> - 而 BB-2R 调整后全树黑高度复衡，但 BB-2B 有可能下溢至根，因此完全可以 $\Omega(\log n)$ 次重染色操作都集中在 BB-2B 这一情况，最后通过 BB-2R 复衡或本身就已复衡，此时完全不需要旋转。

### 节点数规模问题

1. 定义左倾率为以某个节点为根的（子）树中，根的左子树的关键码规模与右子树的关键码规模之比。当全树的关键码数为 $n$ ，且 $n\rightarrow +\infty$ 时，给出根节点只有 1个关键码的红黑树的最小左偏率的关系式。

> ![[Important-and-hard-problems-red-black-left-rate.png]]
> 考虑全树的高度为 h（统一外部节点的高度为 0，计算关键码时不考虑外部节点）：
> - 左子树的高度为 h-1，因此其包含的关键码数为: $N_{L}=2^{h-1}-1$；
> - 右子树的高度同样为 h-1，因此其包含的关键码数为 $N_R$ ，则有如下关系式：$\lceil\log_{4}(N_{R}+1)\rceil\le h-1$，即 $N_{R}=4^{h-1}-1$；
> - 而总关键码数有关系式 $N_{L}+N_{R}+1=n$，解得树高与关键码数的关系式为 $h=\frac{\log_{2}n+1}{2} +1$，因此代入 $N_{L}$ 和 $N_R$ 的关系式中，可解得 $N_{L}=(n+1)^{\frac{1}{2}}-1$，$N_{R}=n$ （这里看起来和前式矛盾，是因为有一步做了不恰当的截断——h 的计算是损失了部分精度的，但是无关大雅，这里也恰恰能够表明，**右子树的关键码总数占据了全树的绝大部分**），此时最小左偏率为 $\lim\limits_{n\rightarrow\infty} \frac{N_{L}}{N_{R}}=\lim\limits_{n\rightarrow\infty} \frac{\sqrt{n+1}-1}{n}=0$ 

2. 红黑树的一条路径上有 5 个红节点，则该红黑树最少有多少个节点？

> 这个其实本质上与计算红黑树的最大高度那一题的思路是一致的：
> 单条路径上有 5 个红节点，为了保证最少节点的要求，则红节点应当是间隔分布的，则全树的树高为 `2*5=10` （外部节点的树高为 0），也即，一个红节点贡献两层树高，树高总是偶数的。这样一来直接套用公式的前半部分：$\text{h}_{max}=2\cdot(\lfloor\log_{2}(n+2)\rfloor-1)$，因此代入 $\text{h}_{max}=10$，即可求出 $n=2^{6}-2=62$ 个节点。
> 

### 搜索长度问题

1. 判断：规模同为 2023 个节点的红黑树和 AVL 树，最坏情况下红黑树的搜索长度更长。

> ✅
> 本质还是树高问题。
> 其中，AVL 树高在最坏情况下的关系式是：$fib(h+3)-1≤ n$ ，代入 $n=2023$，得 $h=14$
> 红黑树的树高在最坏情况树高与节点数的关系式是：$h_{max} = max( 2\cdot(\lfloor\log_{2}(n + 2)\rfloor - 1), 2\cdot\lfloor\log_{2}( \frac{n+2}{3} )\rfloor + 1 )$ ，代入 $n=2023$，得 $h_{max}= max(18,19) =19$ 

## 树的遍历

### 先序、中序、后序的迭代实现

![[50-Tree#先序遍历]]

![[50-Tree#中序遍历]]

![[50-Tree#后序遍历]]