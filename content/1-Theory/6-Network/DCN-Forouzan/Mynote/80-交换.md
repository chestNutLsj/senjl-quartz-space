## 交换

### 背景

- 网络：是连接设备的一组集合。而为了解决如何将多台设备连接起来实现一对一的通信，有两种解决方案：
	
- 一种解决方案是：
	
	- 每对设备之间建立点到点连接（网状拓扑），一台中心设备与其他所有设备之间建立点到点连接（星型拓扑）。但在应用于大规模网络时，该方法不切实际且浪费，链路的数量和长度需要太多的基础设施从而使成本效益很低，而多数链路再大多数时间内是空闲的
		
	- 其他拓扑结构如总线拓扑，由于设备之间距离和设备总数的增长会超出介质和设备的容量的原因也被排除
		
	
- 更好的方案是：交换switching
	
	- 交换网络由一系列互联的节点（称为交换机）构成，交换机能够在连接到交换机的两台或多台设备之间建立临时连接
		
	- 交换网络中，一些节点连接到端系统end system，另一些只是用于路由选择
		
	- 传统有三种交换方式：电路交换、分组交换、报文交换（前两种目前普遍使用，这种在一般通信中已经被淘汰，只是存在于网络应用中）
		
	- 由三种交换方式衍生出三种网络：
		
		- 电路交换网
			
		- 分组交换网：趋向是结合数据报网和虚电路网。网络根据数据报寻址的思想对第一个分组进行路由选择，然后为同一个源端和目的端的所有其余的分组建立一个虚电路网
			
			- 数据报网
				
			- 虚电路网：具有与电路交换网和数据报网的一些特性
				
			
		- 报文交换网：每个交换机储存整个报文，并转发到下一个交换机




### 电路交换网络

circuit-switched network：是由物理链路连接的一组交换机组成的。两个站点的连接是由一条或多条链路组成的专用路径来实现，每次连接仅使用每条链路上的一条专用通道，每条链路用 FDM 或 TDM 划分成 n 个通道

- 四个注意点：
	
	- **电路交换是在物理层**
		
	- 通信开始前，站点必须对通信时间所用的资源给以预留。这些资源包括通道（FDM的带宽和TDM的时隙）、交换机的缓冲器、交换机处理时间、交换机输入/输出端口，在整个数据传输期间必须保留直至拆除阶段
		
	- **两个站点之间数据传输不打包**（物理层传输信号）。源站点发送连续的数据流，目的站接收这些数据流，尽管可能会存在间隙
		
	- **数据传输期间没有寻址**，交换机基于它们占有频带 FDM 或时隙 TDM 发送数据。==只有在建立阶段，存在端到端的寻址==

- 三个阶段：
	
	- 建立阶段 setup phase：
		- ![[80-交换-circuit-switched.png]]
		
		- 双方（或电话会议中多方）通信之前，需要建立一条专用电路（链路中的通道的组合）
			
		- 当端系统需要连接到另一个端系统时，向其发送一个连接请求，这个请求必须被所有交换机接收。端系统通常通过专用线路连接到交换机，因此在交换机之间建立专用通道
			
		- 开始建立时，从一方端系统发送含有另一端地址的连接请求给交换机，交换机以此发现与另一交换机的专用通道，接着发送请求，如此反复直到到达目的端系统
			
		- 通道建立前，目的端系统必须反方向发送一个确认给源端系统，仅当源端系统接收到确认之后，连接才建立
			
		- 端到端系统的寻址要求建立两个端系统之间的连接。计算机的地址是由TDM网络管理者给定的，电话号码是由FDM网络管理者给定的
			
		
	- 数据传输data transfer：专用电路（通道）建立之后，双方可以传输数据
		
	- 拆除阶段 teardown phase：任何一方要撤销连接，就向每台交换机发送一个释放资源的信号
	- ![[80-交换-circuit-switched-network.png]]
		
	
- 效率：
	
	- 资源在整个连接期间都被占用，这些资源不能被其他连接所用，所以电路交换网的效率不及其他两类网络类型的效率
		
	- 电话网中，人们结束对话就终止通信。但是，计算机网络中，即使长时间没有通信，一台计算机也可能与另一台计算机相连，此时允许拥有专用资源的意思是不能用于其他连接
		
	
- 延迟：尽管效率低，**但延迟却是最小**。连接期间，资源被分配给该连接，每个交换机没有延迟，整个延迟时间取决于以下三个部分：
	
	- 建立连接需要的时间：
		- ![[80-交换-circuit-switched-delay.png]]
		
		- 源计算机请求的传播时间
			
		- 请求信号的传输时间
			
		- 目的计算机确认的传播时间
			
		- 确认信号的传输时间
			
		
	- 数据传输延迟：
		
		- 传播时间
			
		- 数据传输时间
			
		
	- 拆除电路所需时间
		
	
- 电话网中的电路交换技术：电话公司传统电话网物理层的交换技术采用电路交换方法，目前趋向转用其他交换技术


### 数据报网络

datagram network

![[80-交换-datagram-network.png]]

- 分组交换网络特点：
	
	- 经过分组交换网发送的报文，必须划分为一些固定长的分组或可变长的分组，分组长度由网络和控制协议决定
		
	- 分组交换中，对分组不存在资源分配，即链路没有预留的带宽以及对每个分组没有安排预定的处理时间
		
	- 资源按需分配，基于先来先服务的原则。当交换机接收到一个分组时，不管它是源端还是目的端，如果还有其他分组正在处理，该分组就必须等待。没有预留就可能会发生延迟


- 数据报网络中，每个分组独立处理，与其他分组无关。即使某个分组是多分组传输的一个部分，但网络处理它好像是单独存在的一样，这种方法分组称为数据报 datagram 
	
	- 数据报交换通常是在网络层。传统上称数据报网中的交换机为路由器，从源端发出的报文分组，经过不同的链路传送到目的端
		
	- 这种方法可能引起传输的数据报到达目的端时，由于分组之间延迟不同而失序，也可能由于缺乏资源而引起分组丢失。因此多数协议，在传送到应用层之前，由上层负责数据报重新排序或寻找丢失的数据报
		
	- 数据报网有时也称为无连接网络connectionless network，无连接意指交换机不保存有关连接状态的信息，不需要建立连接阶段和拆除阶段，每个分组不管源端和目的端由交换机同样处理


- 路由表
	
	- 数据报网中，每个交换机（或分组交换机）都有一个基于目的地址的路由表
		
	- 路由表是动态的，周期性地修改
		
	- 表中记录目的地址和相应的转发端口。目的地址包含在数据报网络的每个分组的头部中，当交换机接收到分组时，检查目的地址，查阅路由表找到对应的输出端口，通过它转发出去。目的地址在分组传送期间保持不变，与虚电路交换网中的地址不同


- 效率
	
	- 高于电路交换网。仅当有传输的分组时，才分配资源。如果源端发送一个分组，在另一个分组可发送前，存在很少时间的延迟；对于来自其他源端的分组在这段时间需要重新分配资源


- 延迟
	
	- 长于虚电路交换网。虽然没有建立阶段和拆除阶段，但每个分组再转发前交换机会有等待
		
	- 由于报文中所有分组不需要通过同一个交换机发送，因此报文的分组延迟不一致
		
	- 总延迟时间=传输时间+传播延迟+等待时间
	- ![[80-交换-delay-in-datagram.png]]


- 因特网中的数据报网
	
	- 因特网在网络层选用数据报方法进行交换，采用网络层规定的同一地址寻找从源端到目的端的路径



### 虚电路网络virtual-circuit network

- 结合电路交换网络和数据报网络的产物，具有二者的某些特点：
	
	- ![[80-交换-virtual-circuit.png]]
	- 数据传输阶段前后，同电路交换网络一样有建立阶段和拆除阶段
		
	- 同电路交换网络或数据报网络一样，按需要在建立阶段期间分配资源
		
	- 同数据报网络一样，数据被划分为组，每一组的头部含有地址，具有本地的权限（定义下一个交换机和传送分组的通道应该是什么），而不是端到端的权限
		
	- 同电路交换网络一样，所有分组沿着连接期间建立的路径传送
		
	- 虚电路网络通常在数据链路层实现。电路交换网络在物理层实现，数据报网络在网络层实现


- 网络的交换机执行从源端到目的端通信量交换。源端或目的端可以是计算机、分组交换机、网桥或连接网络的任何设备


- 编址：
	
	- 全局编址：源端或目的端需要有一个全局地址，该地址是一个广域网方位内或网际范围内唯一地址。虚电路网络中的全局地址仅用于建立虚电路标识符
		
	- 本地地址（虚电路标识符virtual circuit identifier,VCI）：一个VCI是一个仅在交换机范围内的小数字，由两个交换机之间的帧来使用
		
		- 当一个帧到达一个交换机时，它有一个VCI，当它离开时，有另一个VCI
			
		- 既然每个交换机都可以使用自己唯一的VCI集，因此VCI就不必很大



- 三个阶段：
	
	- 数据传输阶段：
		
		- 交换机为虚电路建立的表项，最见到有4列，包含输入端口、输入VCI、输出端口、输出VCI四个信息
			
		- 图8.12说明了一个数据经过一个交换机时的流程和VCI的变化，图8.13说明了一个帧如何从源端到达目的端以及整个过程中每个交换机都更改VCI并路由该帧
			
		- 数据传输阶段一直保持活动，直到源端向目的端发送完所有的帧。这个过程在源端和目的端之间建立虚电路，而不是实际电路
			
		
	- 建立连接阶段：源端和目的端使用各自的全局地址来帮助交换机为连接建立表项。建立阶段，一个交换机为虚电路生成一个入口
		
		- 连接请求：一个连接请求的帧从源端发送到目的端。细则见图8.14及之后的详解
			
			- 源端向交换机1发送一个建立连接帧
				
			- 交换机1接收这个建立请求帧，担当分组交换机的作用，为这个虚电路在表中建立一个表项并且填写输入端口1、输入VCI14、输出端口3，然后通过输出端口3向交换机2转发该帧
				
			- 交换机2接收这个建立请求帧，同交换机1一样完成表项的三列并发送至交换机3
				
			- 交换机3接收建立请求帧并填写三列表项，发向目的端
				
			- 目的端接收建立请求帧，如果准备好接收源端的帧，就分配一个VCI给从源端发来的帧。这个VCI让目的端知道帧是从特定源端发出的，而不是从其他源端发出的
				
			
		- 确认：确认帧逆向从目的端发送到源端，并完成路径上未填写的表项
			
			- 确认帧携带有全局源端地址和目的端地址
				
			- 源端使用最终交换机发送给源端的确认帧的输入VCI作为准备发送给目的端的数据帧的输出VCI
				
			
		
	- 连接拆除阶段：源端和目的端通知交换机删除对应的表项


- 效率：
	
	- 连接建立阶段虚电路网络要做资源预留，此时每个分组延迟都相同；或在数据传输阶段按需分配资源，此时各分组延迟可能不同
		
	- 虚电路网络最大优点在于资源都按需分配，源端可检测资源可利用的程度，而不必真实预留
		
	- 虚电路交换中，属于相同源端与目的端的所有分组都按同一路径传送；但如果资源按需分配，分组到达目的端可能有不同延迟


- 虚电路网络延迟：总延迟=传输时间+传播时间+建立阶段延迟（包括两个方向的传输和传播）+拆除阶段延迟
	- ![[80-交换-delay-in-virtual-circuit.png]]

- 广域网中的电路交换技术：18章中讨论用于广域网中的虚电路网络，如帧中继网和ATM网。虚电路技术非常适用于链路层


### 交换机结构

- 电路交换机结构
	
	- 空分交换机
		
		- 空分交换space-division switching，电路中的各条通路在空间上是相互分离的。最初用于模拟网络，目前被同时使用在模拟和数字网络中
			
		- 纵横制交换机crossbar switch：在栅格中将n个输入连接到m个输出，连接方法是在每个交叉点crosspoint使用微电子开关（晶体管）
			
			- 主要限制是需要的交叉点数量过于庞大
				
			- 统计表明，在任何时刻只有低于25%的交叉点处于工作状态，而其他交叉点都处于闲置状态
				
			
		- 多级交换机multistage switch：将多台纵横制交换机按多级（通常是3级）结构组合在一起
			
			- 单个纵横交换机中，任何连接仅有一行或一列（一条路径）是激活的，所以需要N×N个交叉点。如果交换机中允许多条路径，则可以降低交叉点数，中间级每一个交叉点可被第一级或第三级交叉点访问
				
			- 设计步骤：
				
				- 将 N 条输线分为组，每组 n 条输入线。对每组用一个 n×k 纵模交换机，其中 k 是中间级纵横交换机的个数。第一级有 $\frac{N}{n}$ 个纵横交换机，每个具有 $n×k$ 个交叉点 
					
				- 中间级，使用 k 个 $(\frac{N}{n})×(\frac{N}{n})$ 纵横交换机 
					
				- 第三级，使用 $\frac{N}{n}$ 个 $k×n$ 纵横交换机 
					
				- 总交叉点个数为$2kN+k(\frac{N}{n})^2$，远小于N2
					
				
			- 缺点：
				
				- 多级交换的思想是共享中间级纵横机的交叉点，如果资源有限，并且同一时刻所有用户都请求连接，那么共享会引起有效性的短缺
					
				- 高通信量时会引起阻塞 blocking 现象，指输入无法连接到输出的情形，因为此时两者之间没有可用路径，所有可用中间交换机都被占用了 
					
				- 大规模系统中，级数的增加能够迅速降低所需交叉点的数量，但随之产生阻塞的可能性增大
					
				
			- **Clos 准则**：在一个没有阻塞的交换机中，中间级交换机的个数必须大于等于2n-1，即 $k\ge2n-1$
				
				- 此时交叉点的个数仍少于单级交换机的个数
					
				- $n=(\frac{N}{2})^{\frac{1}{2}}$, $k>2n-1$, $总的交叉点个数>=4N[(2N)^{\frac{1}{2}}-1]$
					
				- 额外的交叉点是防止阻塞所需的，但使用Clos准则和最小交叉点个数的多级交换仍要求很大的交叉点个数
					
				
			
		
	- 时分交换机time-division switching：采用时分复用TDM在交换机内部来实现交换，最常用方法是时隙互换TSI(time-slot interchange)
		
		- 时隙互换：图 8.19 的 4 条输入线路连接到 4 条输出线路的系统
			- ![[80-交换-time-slot-interchange.png]]
			
			- 组合了TDM复用器、TDM分离器、TSI三个部件，TSI是由具有多个存储单元的随机访问器RAM构成的
				
			- 每个存储单元的大小与单个时隙的大小相同，存储单元的个数与输入端的个数相同，多数情况下输入端与输出端个数相同
				
			- RAM中存储的是顺序接收的时隙数据，随后时隙按照控制单元的决策发送出去
				
			
		
	- 时分交换与空分交换机组合：
		
		- 空分交换优势在于瞬态的，缺点在于其有效性，即拥塞可以忍受的情况是由交叉点数量决定的；时分交换优点在于不需要交叉点，缺点在于使用TSI时，对每个连接的处理会产生延迟，每个时隙必须存储在RAM中，然后被检索和传递
			
		- 二者结合以利用两者优点，可以在物理上（交叉点的个数）和时间上（延迟时间）进行优化，由此设计为时间-空间-时间TST(time-space-time)交换机
			
		- 图 8.20 经典 TST 交换机
			- ![[80-交换-time-space-time-switch.png]]
			
			- 将所有输入分成3组并连接到3台时隙交换机中。这样，平均延迟只是使用单一时隙交换机处理12个输入所产生延迟的1/3
				
			- 中间级是一台纵横制空分交换机，连接到TSI交换机组，使所有可能的输入/输出对之间建立连接
				
			- 最后一级是第一级的镜像



- 分组交换机结构
	
	- 输入端口input port：执行分组交换机的物理层和数据链路层功能
		
		- 将接收信号转换成位，将帧分解成分组，进行差错检测与纠错，准备由网络层发送分组，除物理层处理器和数据链路层处理器之外，在分组转向交换结构之前，输入端口有缓冲器（队列）保存分组
			
		- ![[80-交换-input-port.png]]
			
		
	- 输出端口output port：与输入端口成镜像，功能相同顺序相反
		
		- 首先对输出分组进行排队，然后将分组组装成帧，最后利用物理层功能将帧转换成信号在线路上发送
		- ![[80-交换-output-port.png]]
			
		
	- 路由处理器rounting processor：执行网络层的功能
		
		- 利用目的地址寻找下一跳的地址和输出端口号，通过它发送分组。这个动作称为路由表查询table lookup，因为路由处理器寻找路由表。最新的分组交换机中，为加速和方便该过程，将路由处理器的功能移到输入端口
			
		
	- 交换结构switching fabric：从输入队列将分组传送到输出队列是最难的任务，这一动作的速度影响输入/输出队列的长度和分组总传输延迟
		
		- 纵横交换机：如前所述
			
		- Banyan交换机：是一个多级交换，每一级有微交换并基于表示为二进制串的输出端口来发送分组
			
			- 对于n个输入和n个输出，将有log2(n)级，每级有n/2个微交换。第一级基于二进制串的最高位发送分组，第二级基于二进制串的次最高位发送分组，以此类推
				
			- 图 8.24 典例 8 个输入和 8 个输出的榕树交换机
			- ![[80-交换-banyan.png]]
				
			- 存在问题是即使两个分组不是前往相同的输出端口，也可能存在内部冲突。可以通过对目的端口对到达的分组进行排序来解决
				
			
		- Batcher-banyan交换机：设计了Batcher交换机放在banyan交换机之前，根据输入分组的最终目的对分组进行排序
			
			- 排序交换机采用硬件合并技术
			- ![[80-交换-batcher-banyan.png]]
				
			- 通常还有陷阱trap的硬件模块加在Batcher交换机于banyan交换机之间，陷阱模块防止重复的分组（具有相同输出目的地的分组）同时通过banyan交换机。在每个时间节拍，对每个目的地仅有一个分组；如果存在多于一个分组，它们就应该等待下一个节拍
