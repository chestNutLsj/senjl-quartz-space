### (set! …)

The `set!` form changes the value of a previously defined variable.[^11]

    `# (set! n (+ n 1))`
    `case` `[``'set!'``,` `Symbol``(``name``),` `value_exp``]:`
        `env``.``change``(``name``,` `evaluate``(``value_exp``,` `env``))`

Subject:

List starting with `'set!'`, followed by a `Symbol` and an expression.

Action:

Update the value of `name` in `env` with the result of evaluating the expression.

The `Environment.change` method traverses the chained environments from local to global, and updates the first occurrence of `name` with the new value. If we were not implementing the `'set!'` keyword, we could use Python’s `ChainMap` as the `Environment` type everywhere in this interpreter.

##### Python’s nonlocal and Scheme’s set! Address the Same Issue

The use of the `set!` form is related to the use of the `nonlocal` keyword in Python: declaring `nonlocal x` allows `x = 10` to update a previously defined `x` variable outside of the local scope. Without a `nonlocal x` declaration, `x = 10` will always create a local variable in Python, as we saw in [“The nonlocal Declaration”](ch09.html#nonlocal_sec).

Similarly, `(set! x 10)` updates a previously defined `x` that may be outside of the local environment of the function. In contrast, the variable `x` in `(define x 10)` is always a local variable, created or updated in the local environment.

Both `nonlocal` and `(set! …)` are needed to update program state held in variables within a closure. [Example 9-13](ch09.html#ex_average_fixed) demonstrated the use of `nonlocal` to implement a function to compute a running average, holding an item `count` and `total` in a closure. Here is that same idea, written in the Scheme subset of _lis.py_:

```
(
```

[![^1]

Creates a new closure with the inner function defined by `lambda`, and the variables `count` and `total` initialized to 0; binds the closure to `avg`.

[![^2]

Returns 10.0.

[![^3]

Returns 10.5.

[![^4]

Returns 12.0.

The preceding code is one of the tests in [_lispy/py3.10/examples_test.py_](https://fpy.li/18-18).

Now we get to a function call.