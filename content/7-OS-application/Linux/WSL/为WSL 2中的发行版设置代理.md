宿主机代理软件：clash-for-windows 。其他软件同理，请自行查找对应文档，或找到对应功能进行设置。

## 原理
在 WSL1 时代，由于 Linux 子系统和 Windows 共享了网络端口，所以访问 Windows 的代理非常简单。例如 Windows 的代理客户端监听了 8000 端口，那么只需要在 Linux 子系统中执行如下命令，就可以让当前 session 中的请求通过代理访问互联网。

```shell
export ALL_PROXY="http://127.0.0.1:8000"
```

但是 WSL2 基于 Hyper-V 运行，导致 Linux 子系统和 Windows 在网络上是两台各自独立的机器，从 Linux 子系统访问 Windows 首先需要找到 Windows 的 IP。

因此，我们可以分析出两个关键步骤：
1. WSL2 中配置的代理要指向 Windows 的 IP；
2. Windows 上的代理客户端需要允许来自本地局域网的请求；

由于 Linux 子系统也是通过 Windows 访问网络，所以 Linux 子系统中的网关指向的是 Windows，DNS 服务器指向的也是 Windows，基于这两个特性，我们可以将 Windows 的 IP 读取出来。

例如，在 Ubuntu 子系统中，通过 `cat /etc/resolv.conf` 查看 DNS 服务器 IP。

```shell
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateResolvConf = false
nameserver 172.19.80.1
```

可以看到 DNS 服务器是 `172.19.80.1`，通过环境变量 `ALL_PROXY` 配置代理：

```bash
export ALL_PROXY="http://172.19.80.1:7890"
```

7890 是 Windows 上运行的代理客户端的端口。

## 宿主机设置
![[cfw-host-setting.png]]

1. 开启 `Allow LAN` 选项；
2. 开启 `System Proxy` 选项；

>[! Tip] 其它选项功能略解
>1. `mixin`：混合 socket 和 http 两种协议的流量，使其都通过一个端口；
>2. `tun mode`：类似于虚拟网卡，如果出现 DNS 污染，可以开启此选项；
>3. `service mode`：安装后才可以开启 TUN 模式；
>4. `UWP Loopback`：解决 Windows 上自带应用无法联网的问题，如 MS store 等；

## WSL 2 设置
在常用 shell 的配置文件（如 `~/.zshrc`， `~/.bashrc` 等）中添加如下几行：
```shell
# 获取主机IP
export host_ip=$(cat /etc/resolv.conf |grep -oP '(?<=nameserver\ ).*')

# 对http、socket协议进行代理，注意端口填写与clash中代理的端口一致
export http_proxy="http://${host_ip}:7890"
export https_proxy="http://${host_ip}:7890"
export all_prosy="http://${host_ip}:7890"
```

退出编辑后，可以使用 `source ~/.zshrc` 更新之前的配置，若要验证是否成功，可以：
```shell
curl -L www.google.com
# 如果代理成功，应该有如下输出



```

这样只要开启 WSL 2，代理就会随着 shell 一同开启。

## 完成 WSL 2 与 Windows 间的网络互访
本来设置好之前两步，就可以正常通过代理下载应用、连接网络。

但今日突然无法正常使用，具体表现如下：
![[wsl-wget-timeout.png]]
（事实上之前也无法使用 `wget www.google.com`，但是可以正常下载应用、获取 docker 镜像我也就没有深究，事后想来那可能与网络环境有关，之前是使用 wifi 有线直连，现在使用 wifi 无线连接把底裤扯掉了）

可以看到，WSL 在连接 `172.25.240.1:7890` 时超时，通过 `cat /etc/resolv.conf` 可知这就是 windows 的 ip，这表明 WSL 无法正常访问 windows 的网络。

解决办法就是添加一条防火墙规则允许 WSL 对 windows 的访问，以管理员身份打开 powershell 键入如下命令：
```powershell
New-NetFirewallRule -DisplayName "WSL" -Direction Inbound  -InterfaceAlias "vEthernet (WSL)"  -Action Allow
```

正常的输出应该如下：
![[new-wsl-firewall-rule.png]]

这时打开防火墙高级设置，可以找到一则名为 WSL 的新规则：
![[windows-firewall-rules-for-wsl.png]]

配置完成后，就可以在 WSL 中通过 `host_ip:port` 访问 windows 中的应用程序。

![[wsl-wget-succeed.png]]
